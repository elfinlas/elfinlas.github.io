{"componentChunkName":"component---src-templates-post-jsx","path":"/mongodb/230118_mongo_dump/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab"}},"markdownRemark":{"id":"468457ac-4133-5267-ac76-831040d6bb13","excerpt":"슬슬 데이터를 이동해볼까... 기존 개발 서버에서 쓰던 디비를 몇 가지 옮겨서 쓸 일이 있어서 찾아보다가... 또 잊을까봐 정리해두려고 쓰는 포스팅.. 구성은 Aws Ubuntu의 Docker 환경에서 진행하였다. MongoDb Backup 일단 Docker 안의 MongoDB…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/95a159ff13e5784dc37dcaa8b9344fb2/c2d13/thumbnail.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.993865030674847%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPElEQVR42mPgWx3gJjDXfxYDBDAy/P8PwSA2AwMTA0M9E4T9H8pngMlhBwIbArcKr4r4L9QX4AYWWBXKjCSNTSPIUAY5AxsteX1rBwVDS3lFfVszRUMbPYiBG4OvCS8P+y80OzRHm0FbVt7MJkDJ2NpGwcRKXUnfxlrB0NZOydDGGWSAsr6Vo5Kxna6CgbW+sjFInZ2uvKFNopKxfSbQwCJRLXseBoG1QdNFlob9558WYKyqaOGiaGSbrWhonaRgaBOrZGATqWhgnaxgaJ2uYGCTp2BgWyJnaBsMlPdVMrCOUtC3dZM3tnJUMLJJA1oSL69vrsDgurFY0XVVSTrItcbGPlx6eq7cksbGXCDb9PT0wGx5eXsOoNfs5IxtvWW0LIRUVFTYxYHq5E1NJVQ8PNi1LNyEjIHqgAawAgA3dEaiQUAFOwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"thumbnail\"\n        title=\"\"\n        src=\"/static/95a159ff13e5784dc37dcaa8b9344fb2/a6d36/thumbnail.png\"\n        srcset=\"/static/95a159ff13e5784dc37dcaa8b9344fb2/222b7/thumbnail.png 163w,\n/static/95a159ff13e5784dc37dcaa8b9344fb2/ff46a/thumbnail.png 325w,\n/static/95a159ff13e5784dc37dcaa8b9344fb2/a6d36/thumbnail.png 650w,\n/static/95a159ff13e5784dc37dcaa8b9344fb2/e548f/thumbnail.png 975w,\n/static/95a159ff13e5784dc37dcaa8b9344fb2/3c492/thumbnail.png 1300w,\n/static/95a159ff13e5784dc37dcaa8b9344fb2/c2d13/thumbnail.png 2560w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"슬슬-데이터를-이동해볼까\" style=\"position:relative;\"><a href=\"#%EC%8A%AC%EC%8A%AC-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%A5%BC-%EC%9D%B4%EB%8F%99%ED%95%B4%EB%B3%BC%EA%B9%8C\" aria-label=\"슬슬 데이터를 이동해볼까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>슬슬 데이터를 이동해볼까...</h1>\n<p>기존 개발 서버에서 쓰던 디비를 몇 가지 옮겨서 쓸 일이 있어서 찾아보다가...<br>\n또 잊을까봐 정리해두려고 쓰는 포스팅..</p>\n<p>구성은 Aws Ubuntu의 Docker 환경에서 진행하였다.</p>\n<br>\n<h2 id=\"mongodb-backup\" style=\"position:relative;\"><a href=\"#mongodb-backup\" aria-label=\"mongodb backup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MongoDb Backup</h2>\n<p>일단 Docker 안의 MongoDB에 접근해야 한다.<br>\n접근 명령어는 아래와 같이...<br>\n저 뒤의 <strong>mongo</strong>는 docker 컨테이너 이름인데 각자 알맞게 적어준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo docker exec --it mongo /bin/bash</code></pre></div>\n<p>Shell에 접근 후 전체 디비를 뜨는 경우 옵션을 안줘도 되지만,<br>\n나는 특정 디비만 백업하면 되는 것이라서 아래와 같이 명령어를 수행했다.</p>\n<p>그리고 <strong>out</strong>뒤의 인자는 덤프를 뜬 뒤의 디렉토리를 정해주는건데 Shell 내부 디렉토리를 가리킨다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># mongodump --out /backup/ --db mydb</code></pre></div>\n<p>만약 디비가 없는 경우 아래와 같이 에러가 나므로 주의</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># mongodump --out /backup/ --db mydb\n2023-01-18T11:49:23.716+0900\tFailed: error creating intents to dump: error getting collections for database `mydb`: (Unauthorized) command listCollections requires authentication</code></pre></div>\n<br>\n<p>내 디비의 경우 계정 비밀번호가 있었는데 이 경우 아래와 같이 옵션을 주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> -u : 디비 접근 가능 id\n -p : 계정 암호\n --db : 대상 디비</code></pre></div>\n<p>정상적으로 덤프를 따면 아래와 같이 덤프가 생성되고 담기게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># mongodump --out /backup/ -u mydbuser -p 12345 --db mydb\n2023-01-18T02:56:20.823+0000\twriting mydb.a_data to /backup/mydb/a_data.bson\n2023-01-18T02:56:20.828+0000\twriting mydb.a_data to /backup/mydb/a_data.bson\n2023-01-18T02:56:20.829+0000\twriting mydb.a_data to /backup/mydb/a_data.bson\n2023-01-18T02:56:20.837+0000\tdone dumping mydb.a_data (0 documents)\n2023-01-18T02:56:20.839+0000\tdone dumping mydb.a_data (153 documents)\n2023-01-18T02:56:20.842+0000\tdone dumping mydb.a_data (0 documents)\n2023-01-18T02:56:20.852+0000\twriting mydb.a_data to /backup/mydb/a_data.bson\n2023-01-18T02:56:21.042+0000\tdone dumping mydb.a_data (1051 documents)</code></pre></div>\n<p>이렇게 하면 백업 데이터가 <strong>backup</strong> 디렉토리에 저장이 된다.<br>\n이것을 이제 밖으로 빼려면 아래와 같이 수행한다.<br>\n실행은 shell 밖에서 해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># sudo docker cp [docker 내 컨테이너 이름]:[아까 백업 담겼던 디렉토리] [저장할 디렉토리]\n\n$ sudo docker cp mongo:/backup/ ./my_backup</code></pre></div>\n<br>\n<h2 id=\"mongodb-resotre\" style=\"position:relative;\"><a href=\"#mongodb-resotre\" aria-label=\"mongodb resotre permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MongoDb Resotre</h2>\n<p>위에서는 백업을 했으니 이제는 다시 복원시킬 차례다.<br>\n옮길 곳이 나는 로컬에서 Aws에서 도는 ubuntu였다.</p>\n<p>백업 디렉토리는 파일질라 등으로 옮겨주고...</p>\n<p>이제 대상지도 같은 환경이라 가정하고...<br>\n대상 도커 컨테이너 내에 넣어준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># sudo docker cp [현재 백업파일이 있는 디렉토리] [docker 내 컨테이너 이름]:[docker 내 저장할 디렉토리]\n\n$ sudo docker cp ./my_backup mongo:/backup</code></pre></div>\n<p>그리고 MongoDB에 접속해 준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo docker exec -it mongo /bin/bash</code></pre></div>\n<p>그리고 해당 백업 디렉토리가 존재하는지 확인 후 아래의 명령어대로 리스토어를 실행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># mongorestore -u tester -p 12345 --db mydb ./backup\n2023-01-18T12:05:40.287+0900\tThe --db and --collection flags are deprecated for this use-case; please use --nsInclude instead, i.e. with --nsInclude=${DATABASE}.${COLLECTION}\n2023-01-18T12:05:40.292+0900\tbuilding a list of collections to restore from backup dir\n2023-01-18T12:05:40.293+0900\treading metadata for mydb.a.data from backup/data.metadata.json\n.....\n2023-01-18T12:05:40.490+0900\t1204 document(s) restored successfully. 0 document(s) failed to restore.\n#</code></pre></div>\n<p>이렇게 하면 백업 &#x26; 복원이 간단하게 끝났다.</p>\n<h3 id=\"기타\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%ED%83%80\" aria-label=\"기타 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기타</h3>\n<p>이거를 직접 통신으로 하는 방법도 있던 것 같은데...<br>\n일단 할 일이 많기 때문이 이런 노가다 방법으로 처리했다.</p>\n<p>향후 시간이 될때 더 고차원적인 방법을 찾아봐야겠다.</p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EC%8A%AC%EC%8A%AC-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%A5%BC-%EC%9D%B4%EB%8F%99%ED%95%B4%EB%B3%BC%EA%B9%8C\">슬슬 데이터를 이동해볼까...</a></p>\n<ul>\n<li>\n<p><a href=\"#mongodb-backup\">MongoDb Backup</a></p>\n</li>\n<li>\n<p><a href=\"#mongodb-resotre\">MongoDb Resotre</a></p>\n<ul>\n<li><a href=\"#%EA%B8%B0%ED%83%80\">기타</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"MongoDB 백업(Backup) & 복원(Restore) (With Docker)","description":null,"date":"January 18, 2023","tags":["MongoDB"],"series":"MongoDB","previewImage":"mongo_logo.png","isPrivate":null,"writer":null}},"previous":{"fields":{"slug":"/node-js/230118_yarn_runs_not_excute/"},"frontmatter":{"title":"yarn에서 run-s 실행이 안될 때 (With package.json)","isPrivate":null}},"next":{"fields":{"slug":"/vcs_git/230118_git_ssh_key/"},"frontmatter":{"title":"Github clone 받을 때 권한 문제 (git permission denied - publickey)","isPrivate":null}}},"pageContext":{"id":"468457ac-4133-5267-ac76-831040d6bb13","previousPostId":"29e7d430-63f4-50c6-bad5-d43a19eddb7e","nextPostId":"ecbb5ac5-bccd-532a-ad2d-04a11aca70a0"}},"staticQueryHashes":[],"slicesMap":{}}