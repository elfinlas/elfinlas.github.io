{"componentChunkName":"component---src-templates-post-jsx","path":"/til/230324_til/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab"}},"markdownRemark":{"id":"2a875bbb-bc02-5ce5-b2d1-d2824688ead5","excerpt":"개발하며 얻은 TIL 흑우집합소 개발하며 얻은 내용 및 노션에 작성한 내용을 정리한 포스팅이다. 오늘 개발하면서 배운 내용은 아래와 같다. 예외처리의 미흡함 (예외처리 부분) 문자열 상수(String Literal) - Typescript Object…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/39caabbd44b8d6bf6560fecef746ecb3/fcbaf/thumbnail_til.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABVElEQVR42oWS3XKCMBCFgQQS8kMiENAKpdVpO2Mv7Pj+73YaQKmo1Iud3Uw2Z7/dbBAEAa7NMIHWOjSqQKcd2qxElzl0psKbrb1VWOscTq9ghMLt++AShEE4+FbmkDwd4mi6Gy3yOTQi0JTD0hTvvohk6ZLg6Le94FVSURTY7/d42W6HeMgNx+KVMChFNgO6J9QFeMwmQSkl2rZFXdew1p7Jx9ySazhpZkB3gq9+XozGM5I4jsE5x203eSJRKfu/YD/8hNBJkDE2UCqlIIQAIWQStolA5T/nKWFyJpRCYrfb4ftwwM/xiNPpBJH+zXcVC9TqmaAukSbjDKmnSTxhT0XOcRhFM8F+hRYER++Yxsdqg8Y4EEqRcYlNlqP2rfU0G/9p6+Gco/N72d8/XJtb63/w0zUwqYKKGBRhfv8YMsLH2JskyTXZY8FL69I//ioaLBVcsl/Pe+yHKlOGOgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"thumbnail\"\n        title=\"\"\n        src=\"/static/39caabbd44b8d6bf6560fecef746ecb3/a6d36/thumbnail_til.png\"\n        srcset=\"/static/39caabbd44b8d6bf6560fecef746ecb3/222b7/thumbnail_til.png 163w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/ff46a/thumbnail_til.png 325w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/a6d36/thumbnail_til.png 650w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/fcbaf/thumbnail_til.png 895w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><br><br><br><br></p>\n<h1 id=\"개발하며-얻은-til\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EB%B0%9C%ED%95%98%EB%A9%B0-%EC%96%BB%EC%9D%80-til\" aria-label=\"개발하며 얻은 til permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개발하며 얻은 TIL</h1>\n<p>흑우집합소 개발하며 얻은 내용 및 노션에 작성한 내용을 정리한 포스팅이다.<br>\n오늘 개발하면서 배운 내용은 아래와 같다.</p>\n<ol>\n<li>예외처리의 미흡함 (예외처리 부분)</li>\n<li>문자열 상수(String Literal) - Typescript Object 키 문제</li>\n<li>반복적 코드를 줄이는 리팩토링</li>\n</ol>\n<p>각 항목은 아래의 내용을 참고하자.</p>\n<h2 id=\"1-예외처리-부분\" style=\"position:relative;\"><a href=\"#1-%EC%98%88%EC%99%B8%EC%B2%98%EB%A6%AC-%EB%B6%80%EB%B6%84\" aria-label=\"1 예외처리 부분 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 예외처리 부분</h2>\n<p>오늘도 개발을 하던 도중 코드가 이상한 부분을 찾게 되었다.<br>\n백엔드 측의 에러 핸들링 부분이었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>exception <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//토큰 문제가 발생한 경우</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-1'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-2'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-3'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-4'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-5'</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> decodeData <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodeJwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">accessJwtDecode</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//로그아웃 처리</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>logoutAccountInboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      email<span class=\"token operator\">:</span> decodeData<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n      joinType<span class=\"token operator\">:</span> decodeData<span class=\"token punctuation\">.</span>joinType<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Error Handler 부분의 일부다.<br>\n여기서 저기 <strong>const decodeData</strong> 부분의 로직을 보면 request의 헤더로부터 jwt를 가져오는 부분이 있다.</p>\n<p>만약 헤더에 jwt를 안가지고 올 경우 어떻게 될까?<br>\n또 버그를 양산하는 모양새가 된다.</p>\n<p>물론 <strong>jwtStrategy</strong>에서 검증을 하겠지만, 혹시 <strong>AuthExceptionHandler</strong>를 strategy 없이 사용하는 곳에서 발생했다면?<br>\n그래서 이 부분은 검사를 한번 더 하는 방향으로 로직을 수정했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>exception <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//토큰 문제가 발생한 경우</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-1'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-2'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-3'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-4'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-5'</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//만약 JWT가 헤더 안에 있다면...</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> decodeData <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodeJwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">accessJwtDecode</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">//로그아웃 처리</span>\n      <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>logoutAccountInboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        email<span class=\"token operator\">:</span> decodeData<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n        joinType<span class=\"token operator\">:</span> decodeData<span class=\"token punctuation\">.</span>joinType<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 한번 보호를 함으로써 예외를 막을 수 있었다.</p>\n<h2 id=\"2-typescript-object-키-문제\" style=\"position:relative;\"><a href=\"#2-typescript-object-%ED%82%A4-%EB%AC%B8%EC%A0%9C\" aria-label=\"2 typescript object 키 문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Typescript Object 키 문제</h2>\n<p>개발을 하던 도중 아래와 같은 코드를 작성했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">F_HEADER_BKEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">'test_key'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> defaultH<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">'key-str'</span><span class=\"token operator\">:</span> <span class=\"token string\">'value-str'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">'F_HEADER_BKEY'</span><span class=\"token operator\">:</span> <span class=\"token string\">'111aaa'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'show value = '</span><span class=\"token punctuation\">,</span> defaultH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이렇게 작성할 경우 결과는 아래와 같아 나온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[LOG]: \"show value = \",  {\n  \"key-str\": \"value-str\",\n  \"F_HEADER_BKEY\": \"111aaa\"\n}</code></pre></div>\n<p>내가 원하는 그림은 <strong>F-HEADER_BKEY</strong>의 값이 저 상수 이름 값이 아닌,<br>\n<strong>test_key</strong> 상수의 값이 들어가길 원했다.</p>\n<p>이 문제를 해결하려면 아래와 같이 작성한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">F_HEADER_BKEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">'test_key'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span>\n<span class=\"token keyword\">const</span> defaultH<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">'key-str'</span><span class=\"token operator\">:</span> <span class=\"token string\">'value-str'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\ndefaultH<span class=\"token punctuation\">[</span><span class=\"token constant\">F_HEADER_BKEY</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"aaa\"</span>\n\n<span class=\"token comment\">//결과</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token constant\">LOG</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token string\">\"show value = \"</span><span class=\"token punctuation\">,</span>  <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">\"key-str\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"value-str\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"test_key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aaa\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>맨 처음처럼 나타나는 이유는 내가 선언한 <strong>defaultH</strong>의 경우,<br>\n타입이 다음과 같이 <strong>{ [key: string]: string }</strong> 되어 있다.</p>\n<p>즉 key는 string으로 되어 있기에 string 자체로 인식을 해버린다.<br>\n하지만 두 번째 제대로 나오는 부분에서는 Object형에 접근하기 위한 값으로 사용한 것이,<br>\n문자열(string)이 아닌 **상수 문자열(string literal)**를 사용했기에 적용이 된다.</p>\n<p>그리고 하나 더 찝어서 이야기 하면 아래와 같은 코드도 동작이 안될 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">defaultH<span class=\"token punctuation\">.</span><span class=\"token constant\">F_HEADER_BKEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"aaa\"</span>\n\n<span class=\"token comment\">//결과</span>\n<span class=\"token punctuation\">[</span><span class=\"token constant\">LOG</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token string\">\"show value = \"</span><span class=\"token punctuation\">,</span>  <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">\"key-str\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"value-str\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"test_key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aaa\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"F_HEADER_BKEY\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"a111\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이거는 간단한 것이 object에 .(Dot)으로 접근 시 해당 키를 이용해 접근하는 방식이다.<br>\n하지만 여기도 <strong>F-HEADER_BKEY</strong>를 문자열 자체로 받아들인다.</p>\n<p>이게 문자열 상수 값으로 받아들여지지 않고, 그냥 문자열 자체로 받아들인단 의미다.<br>\n그래서 혹시 선언된 객체형에 키를 동적으로 쓰고 싶다면 <strong>[]</strong> 형식을 이용해서 접근하는게 좋다.</p>\n<h2 id=\"3-반복적-코드를-줄이는-리팩토링\" style=\"position:relative;\"><a href=\"#3-%EB%B0%98%EB%B3%B5%EC%A0%81-%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%A4%84%EC%9D%B4%EB%8A%94-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81\" aria-label=\"3 반복적 코드를 줄이는 리팩토링 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 반복적 코드를 줄이는 리팩토링</h2>\n<p>백엔드 측을 개발하면서 다음과 같은 코드가 있었다.<br>\n(아래 코드는 예시를 위해 사용하여 일부 변수 및 내용이 코드 문법에 어긋날 수 있습니다.)</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtStrategy</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">PassportStrategy</span><span class=\"token punctuation\">(</span>Strategy<span class=\"token punctuation\">,</span> <span class=\"token string\">'Jwt'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">VERIFY_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> verifyjwtOutboundPort<span class=\"token operator\">:</span> VerifyJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">DECODE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> decodJwtOutboundPort<span class=\"token operator\">:</span> DecodeJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">CREATE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> createJwtOutboundPort<span class=\"token operator\">:</span> CreateJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">FIND_ACCOUNT_EMAIL_JOINTYPE_STATUS_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> findAccountEmailJoinTypeOutboundPort<span class=\"token operator\">:</span> FindAccountEmainJoinTypeStatusOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">LOGOUT_ACCOUNT_INBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> logoutAccountInboundPort<span class=\"token operator\">:</span> LogoutAccountInboundPort<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token operator\">&lt;</span>ParamsDictionary<span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> ParsedQs<span class=\"token punctuation\">,</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token operator\">>></span><span class=\"token punctuation\">,</span> options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> jwt <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * JWT가 존재하지 않는 경우 에러 처리\n     */</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>jwt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">(</span>AuthJwtErrorCode<span class=\"token punctuation\">.</span><span class=\"token function\">jwtNotFound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> account<span class=\"token operator\">:</span> Account <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAccountInJwt</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">,</span> <span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//...Some work</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">//JWT 내에서 계정 정보를 가져오는 함수</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> <span class=\"token function\">getAccountInJwt</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> tokenType<span class=\"token operator\">:</span> JwtType<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>Account<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Access가 만료된 경우 리프레시 토큰도 체크해줘야 한다.</span>\n    <span class=\"token keyword\">const</span> jwtData <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodJwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">accessJwtDecode</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//계정 정보를 가져온다.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>findAccountEmailJoinTypeOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      u_email<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n      ua_joinType<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>joinType<span class=\"token punctuation\">,</span>\n      uStatus<span class=\"token operator\">:</span> <span class=\"token constant\">ACCOUNT_STATUS_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVE</span><span class=\"token punctuation\">,</span>\n      uAccAuth<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>근데 코드를 작성하다보니...<strong>getAccountInJwt</strong> 함수의 경우 다른 곳에서도 비슷한 방식으로 사용되고 있었다.<br>\n쉽게말해 중복적으로 코드가 작성되고 있었다.</p>\n<p>이 부분은 <strong>Inbound Port</strong> 성향의 서비스 로직으로 분리할 수 있었다.<br>\n난 <strong>Port &#x26; Adaptor</strong> 아키텍쳐 방식을 사용할 때 In과 Out을 저번에 받은 강의 내요을 토대로 사용한다.</p>\n<p>In 성향은 외부 세계에서 요청이 오는 경우로 나누고,<br>\nOut은 백엔드 내에서 처리하여 인프라 쪽과 연계되는 경우로 나눈다.</p>\n<p>지금처럼 Jwt를 받아서 그 안에 담겨있는 정보를 요청해야 하는 경우,<br>\n이 성향은 Inbound 성향이라 할 수 있다.</p>\n<p>설령 내부에서 호출한다 해도 jwt라는 속성 자체가 외부에서 오기 때문이다.<br>\n물론 인프라 측의 DB 로직을 한번 타긴 하는데, 난 이런 경우 처음 접근하는 변수를 기준으로 잡는다.</p>\n<p>그래서 이 부분은 <strong>Inbound Port</strong>로 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">//Inbound Port 정의</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> JwtType <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/domain/auth/types/jwt.enums'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">GET_ACCOUNT_IN_JWT_INBOUND_PORT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Get_Account_In_Jwt_Inbound_Port'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GetAccountInJwtInputDto</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  jwt<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  jwtType<span class=\"token operator\">:</span> JwtType<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GetAccountInJwtOutputDto</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">GetAccountInJwtInboundPort</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">excute</span><span class=\"token punctuation\">(</span>params<span class=\"token operator\">:</span> GetAccountInJwtInputDto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//인바운드 인터페이스 구현체 서비스</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GetAccountInJwtService</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">GetAccountInJwtInboundPort</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">DECODE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> decodJwtOutboundPort<span class=\"token operator\">:</span> DecodeJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">FIND_ACCOUNT_EMAIL_JOINTYPE_STATUS_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> findAccountEmailJoinTypeOutboundPort<span class=\"token operator\">:</span> FindAccountEmainJoinTypeStatusOutboundPort<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">excute</span><span class=\"token punctuation\">(</span>params<span class=\"token operator\">:</span> GetAccountInJwtInputDto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Access가 만료된 경우 리프레시 토큰도 체크해줘야 한다.</span>\n    <span class=\"token keyword\">const</span> jwtData <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodJwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">accessJwtDecode</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//계정 정보를 가져온다.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>findAccountEmailJoinTypeOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      u_email<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n      ua_joinType<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>joinType<span class=\"token punctuation\">,</span>\n      uStatus<span class=\"token operator\">:</span> <span class=\"token constant\">ACCOUNT_STATUS_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVE</span><span class=\"token punctuation\">,</span>\n      uAccAuth<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>위와 같이 별도 Inbound Service로 분리할 경우 아래와 같이 간단하게 작성할 수 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">//여기서 아래의 getAccountInJwtService 인터페이스 주입을 해준다.</span>\n\n<span class=\"token comment\">//Get Account</span>\n<span class=\"token keyword\">const</span> account<span class=\"token operator\">:</span> Account <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>getAccountInJwtService<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> jwt<span class=\"token punctuation\">,</span> jwtType<span class=\"token operator\">:</span> <span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_TOKEN</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//기존 코드</span>\n<span class=\"token comment\">//const account: Account = await this.getAccountInJwt(jwt, JWT_TYPE.ACCESS_TOKEN);</span></code></pre></div>\n<br>\n<p>이렇게 함으로써 다른 영역에서도 해당 로직을 재사용할 수 있게 되었다.</p>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>개발을 하면서 계속 더 나은 코드를 작성하는 건 뭐랄까...<br>\n완벽할 수 없지만, 완벽에 가까워지도록 하는 형태가 된다고 해야 할까?</p>\n<p>그런 의미로 리팩토링은 참 재미있는 것 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"toc\"><pre class=\"language-toc\"><code class=\"language-toc\"></code></pre></div>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EA%B0%9C%EB%B0%9C%ED%95%98%EB%A9%B0-%EC%96%BB%EC%9D%80-til\">개발하며 얻은 TIL</a></p>\n<ul>\n<li><a href=\"#1-%EC%98%88%EC%99%B8%EC%B2%98%EB%A6%AC-%EB%B6%80%EB%B6%84\">1. 예외처리 부분</a></li>\n<li><a href=\"#2-typescript-object-%ED%82%A4-%EB%AC%B8%EC%A0%9C\">2. Typescript Object 키 문제</a></li>\n<li><a href=\"#3-%EB%B0%98%EB%B3%B5%EC%A0%81-%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%A4%84%EC%9D%B4%EB%8A%94-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81\">3. 반복적 코드를 줄이는 리팩토링</a></li>\n<li><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"23년 3월 24일 TIL & 개발노트 (Typescript에서 문자열 상수, 그리고 코드 리팩토링)","description":null,"date":"March 31, 2023","tags":null,"series":null,"previewImage":null,"isPrivate":null,"writer":null}},"previous":{"fields":{"slug":"/nginx/230330_nginx_header/"},"frontmatter":{"title":"Nginx에서 헤더 전달하기 (프록시 사용)","isPrivate":null}},"next":{"fields":{"slug":"/nginx/230331_file_upload_size/"},"frontmatter":{"title":"Nginx에서 파일 업로드 사이즈 용량 처리","isPrivate":null}}},"pageContext":{"id":"2a875bbb-bc02-5ce5-b2d1-d2824688ead5","previousPostId":"fc305de8-065f-51e6-ab94-7a4b00c704a6","nextPostId":"f298ef5b-df6c-5f73-b42f-ceaac1834bfc"}},"staticQueryHashes":[],"slicesMap":{}}