{"componentChunkName":"component---src-templates-blog-post-js","path":"/til/230214_til/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab","siteUrl":"https://elfinlas.github.io","comment":{"disqusShortName":"","utterances":"elfinlas/blog_utterances"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"id":"47c396c4-32f5-5ad8-8d66-180563f5fbcd","excerpt":"23년 2월 13일 TIL 금일 흑우집합소를 개발하며 배운 내용 및 겪은 과정을 정리하여 올려본다. 오늘은 깔끔한 코드 작성에 대해 고민한 부분을 정리하여 올려본다. 어제 작업하던 JWT 부분에 대해 매듭을 지려고 했다. 일부분은 Ports And Adapters Architecture…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 895px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/39caabbd44b8d6bf6560fecef746ecb3/b002d/thumbnail_til.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABMklEQVQoz42SW2/CMAyFk7a50Li3lFJGuw2plSbxBP//x50lhjFAo+zhyI3lfj5xLIQQuJW3hKFaY3AeH7TGO7X4KNb4LDvsqw2rLxpsihqFdXj8XzwmIkBl6q9CVioTUGpQpZbhVpllYHRm9W9R13WYpgm7YUDj/V3tJq9QG7cMjNdTaXY9O+cwjiODiYhzUshzs1WJZkXLwDirNEnuclJK1mNtawg+L5eBcS5xTj8grTW7LIoCeZ4juWnmtUPryn84vADjFed5xuFwwOl4Cjpyg6tDTQFYvXAYgEadXzm6SbMwTylYqb5//SY47KheBva2xNy88S6KRKIOQ9+VLbZh93pq+Pt89tjXPXJtl4FXcHjBr24EmRVyqeASzSKOiqOR2evFlpdIymJqtk8X/Jm+AaC961594rpnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/39caabbd44b8d6bf6560fecef746ecb3/77434/thumbnail_til.webp 300w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/411c4/thumbnail_til.webp 600w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/dd3ab/thumbnail_til.webp 895w\"\n              sizes=\"(max-width: 895px) 100vw, 895px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/39caabbd44b8d6bf6560fecef746ecb3/a8a0d/thumbnail_til.png 300w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/dface/thumbnail_til.png 600w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/b002d/thumbnail_til.png 895w\"\n            sizes=\"(max-width: 895px) 100vw, 895px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/39caabbd44b8d6bf6560fecef746ecb3/b002d/thumbnail_til.png\"\n            alt=\"thumbnail\"\n            title=\"thumbnail\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1 id=\"23년-2월-13일-til\" style=\"position:relative;\"><a href=\"#23%EB%85%84-2%EC%9B%94-13%EC%9D%BC-til\" aria-label=\"23년 2월 13일 til permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>23년 2월 13일 TIL</h1>\n<p>금일 흑우집합소를 개발하며 배운 내용 및 겪은 과정을 정리하여 올려본다.<br>\n오늘은 깔끔한 코드 작성에 대해 고민한 부분을 정리하여 올려본다.</p>\n<p>어제 작업하던 JWT 부분에 대해 매듭을 지려고 했다.<br>\n일부분은 <strong>Ports And Adapters Architecture</strong> 방식으로 작성해보려고 노력중이다.</p>\n<p>근데 확실히 레이어드 아키텍쳐보다 더 나은 것 같다.<br>\n이유는 크게 세 가지다.</p>\n<ol>\n<li>하나의 코드 파일의 가독성 증가</li>\n<li>레이어드 보다 더 세분화 가능</li>\n<li>깔끔한 파일 관리</li>\n</ol>\n<p>개인적 사견이 많이 녹여 있어서 다른 사람은 공감 못할 수 있다.<br>\n레이어드 아키텍쳐로도 충분히 구현 가능하지만, 이 아키텍쳐로 인해 명확하게 각 역할이 나눠지는 것을 채감했다.</p>\n<p>이것은 차후에 다루고…<br>\n오늘 했던 고민은 아래와 같다.</p>\n<br>\n<h2 id=\"고민-포인트\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%AF%BC-%ED%8F%AC%EC%9D%B8%ED%8A%B8\" aria-label=\"고민 포인트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고민 포인트</h2>\n<p>먼저 내가 jwt를 검증하는 Inbound 영역의 서비스 로직이 있다.<br>\n코드는 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VerifyJwtService</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">VerifyJwtOutboundPort</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> jwtService<span class=\"token operator\">:</span> JwtService<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">DECODE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> decodJwtOutboundPort<span class=\"token operator\">:</span> DecodeJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">FIND_ACCOUNT_EMAIL_JOIN_TYPE_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> findAccountEmailJoinTypeOutboundPort<span class=\"token operator\">:</span> FindAccountEmainJoinTypeOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">LOGOUT_ACCOUNT_INBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> logoutAccountInboundPort<span class=\"token operator\">:</span> LogoutAccountInboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">CREATE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> createJwtOutboundPort<span class=\"token operator\">:</span> CreateJwtOutboundPort\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">excute</span><span class=\"token punctuation\">(</span>params<span class=\"token operator\">:</span> VerifyJwtInputDto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      params<span class=\"token punctuation\">.</span>tokenType <span class=\"token operator\">===</span> <span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_TOKEN</span>\n        <span class=\"token operator\">?</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">verifyAccessJwt</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>jwt<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">:</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">verifyRefreshJwt</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>jwt<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> e\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> <span class=\"token function\">verifyAccessJwt</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>jwtService<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_ACCESS_SECRET_KEY</span><span class=\"token punctuation\">,</span>\n        audience<span class=\"token operator\">:</span> <span class=\"token function\">getJwtAudience</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        issuer<span class=\"token operator\">:</span> <span class=\"token function\">getJwtIssuer</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> JwtVerifyOptions<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> validResult <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">tokenExceptionHandler</span><span class=\"token punctuation\">(</span>\n        e<span class=\"token punctuation\">,</span>\n        jwt<span class=\"token punctuation\">,</span>\n        <span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_TOKEN</span>\n      <span class=\"token punctuation\">)</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>validResult <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> validResult\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">//고민 포인트 01</span>\n      <span class=\"token comment\">//액세스 토큰에서 만료가 되면 리프래시 토큰을 검증한다.</span>\n      <span class=\"token comment\">//큰 문제 없다면 AccessToken을 다시 전달한다.</span>\n      <span class=\"token comment\">//이 부분에는 거의 10~20줄 짜리 코드 로직이 들어갔었다.</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * 리프레시 토큰 검증  고민포인트 02\n   * @param jwt\n   */</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> <span class=\"token function\">verifyRefreshJwt</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>jwtService<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_REFRESH_SECRET_KEY</span><span class=\"token punctuation\">,</span>\n        audience<span class=\"token operator\">:</span> <span class=\"token function\">getJwtAudience</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        issuer<span class=\"token operator\">:</span> <span class=\"token function\">getJwtIssuer</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">REFRESH_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> JwtVerifyOptions<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">//고민 포인트 03</span>\n      <span class=\"token comment\">//리프레시 만료시에 대한 처리 로직</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * 토큰 예외 공통 처리 핸들러\n   * @param e\n   * @param jwt\n   * @param tokenType\n   * @returns\n   */</span>\n  <span class=\"token keyword\">private</span> <span class=\"token function\">tokenExceptionHandler</span><span class=\"token punctuation\">(</span>\n    e<span class=\"token operator\">:</span> Error<span class=\"token punctuation\">,</span>\n    jwt<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    tokenType<span class=\"token operator\">:</span> JwtType\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token operator\">|</span> AuthException <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//토큰 만료 시</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">TokenExpiredError</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[tokenExceptionHandler] : TokenExpiredError'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// return true;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">(</span>AuthJwtErrorCode<span class=\"token punctuation\">.</span><span class=\"token function\">jwtExpired</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">,</span> tokenType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// payload가 잘 못 되었을 때 (base64 decode가 안되는 경우 등)</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">SyntaxError</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[tokenExceptionHandler] : Syntax'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// throw new AuthException(AuthJwtErrorCode.jwtInvalid(jwt, tokenType));</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">(</span>AuthJwtErrorCode<span class=\"token punctuation\">.</span><span class=\"token function\">jwtInvalid</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">,</span> tokenType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// JwtWebTokenError should be later than TokenExpiredError</span>\n    <span class=\"token comment\">//보통 토큰의 시크릿 코드가 변경되었는데 구형 키 값을 사용하여 만들어진 JWT를 사용할 경우 발생</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">JsonWebTokenError</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[tokenExceptionHandler] : JsonWebTokenError'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// throw new AuthException(AuthJwtErrorCode.invalidTokenOrInvalidSignature(jwt));</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">(</span>\n        AuthJwtErrorCode<span class=\"token punctuation\">.</span><span class=\"token function\">invalidTokenOrInvalidSignature</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">,</span> tokenType<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//그 외 기타 에러</span>\n    <span class=\"token comment\">//기타 에러</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">(</span>AuthJwtErrorCode<span class=\"token punctuation\">.</span><span class=\"token function\">jwtEtcError</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">,</span> tokenType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>딱 봐도 코드의 문제가 보인다. (고민 포인트는 아래서 집어볼 예정)<br>\n일단 가장 큰 문제는 코드의 복잡도가 높다는 것이다.</p>\n<p>내가 최근 연습하고 있는 방법은 <strong>하나의 서비스는 하나의 기능만 담당한다</strong> 이다.<br>\n이게 생각보다 어렵다.</p>\n<p>명확하게 나눠지는건 쉽게 자를 수 있지만 위처럼 Jwt를 구현할 때 Access와 Refresh를 같이 쓴다.<br>\n이 경우 아래와 같이 생각할 수 있다.</p>\n<br>\n<ol>\n<li>먼저 한 메서드를 통해 JWT와 타입을 받고 내부 프라이빗 메서드에서 나눠서 처리하는 방법</li>\n<li>검증 자체 목적에 집중하는 서비스 로직과 Access와 Refresh 각각을 담당하는 서비스로 나눠서 처리하는 방법</li>\n<li>검증이라는 목적에 집중하여 Access와 Refresh 검증만 하고 그 외 예외 발생 시 호출 영역으로 전가시키기</li>\n</ol>\n<br>\n<p>맨 처음 내가 구현한 방법은 1번 방식이었고…<br>\n결국 위 코드처럼 복잡도가 매우 많이 상승하게 되었다.</p>\n<p>그럼 2번으로 할 것인가…<br>\n이 부분도 잘 생각해야 하는게 나누고 자르는게 좋지만 너무 나눌 경우 그것 자체로 인해 기능이 너무 산재되어 결국 코드 팔로우가 힘들 것이다.</p>\n<p>그래서 3번의 방법을 선택하게 되었다.<br>\n이렇게 하면서 각 고민 포인트를 고민하고 해결하였다.</p>\n<br>\n<h3 id=\"고민-포인트-01\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%AF%BC-%ED%8F%AC%EC%9D%B8%ED%8A%B8-01\" aria-label=\"고민 포인트 01 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고민 포인트 01</h3>\n<p>Access JWT를 검증하고 catch 하는 부분에서 예외에 대하여 직접 처리하려 했더니 catct 부분이 복잡해졌다.<br>\n이로 인해 Refresh JWT 부분의 catch도 같은 문제가 생기게 되었다.</p>\n<p>이 부분은 위에서 언급한 3번 방법으로 해결하게 되었다.</p>\n<p>JWT를 검증하는 로직에서 <strong>AuthException</strong> 이라는 예외를 직접 핸들링하고,<br>\n이 부분에서 내가 의도한 예외(Access의 Expired 같은)는 따로 정상 처리를 하고,<br>\n그 외의 예외는 호출 지점으로 올려서 Controller 단의 <strong>ExceptionHandler</strong>로 흐르게끔 처리했다.</p>\n<p>그래서 이 부분은 해결할 수 있었다.</p>\n<br>\n<h3 id=\"고민-포인트-02\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%AF%BC-%ED%8F%AC%EC%9D%B8%ED%8A%B8-02\" aria-label=\"고민 포인트 02 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고민 포인트 02</h3>\n<p>검증 로직에서 Access 와 Refresh를 각각 나눠서 별도의 파일로 관리할 것인가를 고민했었다.<br>\n근데 이것도 위에서 언급한 바와 같이 정답이 아니었다.</p>\n<p>혹시 별도의 JWT가 추가되면 계속 코드 파일이 늘어나기 때문이다.<br>\n그래서 이 부분은 1번 포인트와 같이 검증 목적에 집중하기로 했다.</p>\n<p>결국 신경 쓸 부분은 Refresh가 만료된 시점에 사용자 로그아웃 처리였다.<br>\n이 부분은 검증 로직에서 신경 쓸 것이 아닌 호출 지점에서 처리할 문제였다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccessJwtStrategy</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">PassportStrategy</span><span class=\"token punctuation\">(</span>Strategy<span class=\"token punctuation\">,</span> <span class=\"token string\">'jwt'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">VERIFY_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> verifyjwtOutboundPort<span class=\"token operator\">:</span> VerifyJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">DECODE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> decodJwtOutboundPort<span class=\"token operator\">:</span> DecodeJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">CREATE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> createJwtOutboundPort<span class=\"token operator\">:</span> CreateJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">FIND_ACCOUNT_EMAIL_JOIN_TYPE_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> findAccountEmailJoinTypeOutboundPort<span class=\"token operator\">:</span> FindAccountEmainJoinTypeOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">LOGOUT_ACCOUNT_INBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> logoutAccountInboundPort<span class=\"token operator\">:</span> LogoutAccountInboundPort\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> jwt <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string\">'testAuth'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>jwt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">(</span>AuthJwtErrorCode<span class=\"token punctuation\">.</span><span class=\"token function\">jwtNotFound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>verifyjwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        jwt<span class=\"token punctuation\">,</span>\n        tokenType<span class=\"token operator\">:</span> <span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_TOKEN</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//Access Jwt 만료된 경우</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token constant\">ERROR_CODE_JWT_EXPIRED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> validResult<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">validRefreshJwt</span><span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span>\n          <span class=\"token comment\">//이후 로직 처리</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> e\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> payload\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드는 <strong>Strategy</strong> 파일이다.<br>\nNest.js에서 사용하는 전략 파일의 일종이고, 이건 Access Jwt의 처리를 담당하는 Strategy다.</p>\n<p>이 부분에서 토큰 검증 이후 만료된 토큰에 대한 처리, 갱신 가능하면 갱신 처리, 각종 Jwt의 예외처리를 담당했다.<br>\n위 코드는 샘플용이라 정확하지 않지만…</p>\n<p>내가 지금 확인해보니 이 Strategy는 import와 몇 주석을 빼면 100줄도 안되는 코드로 변했다.<br>\n기존에 verify에 몰아서 짤 때는 약 300줄이 넘어갔다 -_-;;</p>\n<p>그래서 <strong>목적에 집중한 코드</strong> 덕분에 한결 나아진 코드를 작성할 수 있었다.</p>\n<br>\n<h3 id=\"고민-포인트-03\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%AF%BC-%ED%8F%AC%EC%9D%B8%ED%8A%B8-03\" aria-label=\"고민 포인트 03 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고민 포인트 03</h3>\n<p>이 부분도 01, 02와 연계되어 있는데, 결국 Refresh가 만료되었을 때에 대한 처리 빼곤 Access와 동일했다.<br>\n그래서 별도 분리를 하지 않고, verify에서 예외를 호출단으로 넘기고 처리는 호출점에서 담당하는 방식으로 해결했다.</p>\n<br>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>오늘도 코드를 작성하면서 좀 더 깔끔하고, 유지보수가 쉬운 코드로 작성하는 연습을 하면서 하니…<br>\n사실 시간은 좀 배로 걸리는 것 같다.</p>\n<p>실행 목적에 집중하여 막 짜면 결과는 사실 금방 나온다.<br>\n그리고 이렇게 블로그로 남길거 생각 안하면 더 빠르고…</p>\n<p>근데 이렇게 하여 완성하고 나면 결국 그 뒤가 문제다.<br>\n지금 내가 만든 <strong>MyMe.Link</strong>가 그렇다.</p>\n<p>정말 코드가 판타스틱하다.<br>\n사실 유지보수 해야 하는데 정말 큰 일이 된거 같아서 큰일이다…<br>\n차라리 다시 짜는게 나을 것 같기도 할 정도니 말이다.</p>\n<p>이번 흑우집합소는 그런 전철을 안밟게 하려고 하는데 이게 맞는건지도 사실 잘 모르겠다.<br>\n정답은 없기에…</p>\n<p>일단 이게 최선의 방법인 것 같고 하면서 더 나은 코드를 짜는 방법을 찾는게 목적이 되었다.</p>\n<p>중간에 개발업 내려놨다 왔지만 나름 5년차 백엔드 개발자다.<br>\n물론 약 3년 휴식 + 전에 약간 섞인 물경력이 문제긴 하지만…</p>\n<p>나름 쌓여있는 경험치 덕분에 혼자서도 이렇게 잘(?) 해낼 수 있던 것 같다.</p>\n<p>이제는 다른 사람과 함께 일해보고 싶다.<br>\n근데 일단 매듭은 짓고 다시…</p>","frontmatter":{"title":"23년 2월 14일 TIL & 개발노트 (깔끔한 코드에 대한 고민)","date":"February 14, 2023"}}},"pageContext":{"slug":"/til/230214_til/","previous":{"fields":{"slug":"/til/230119_til/"},"frontmatter":{"title":"23년 2월 13일 TIL & 개발노트 (흑우집합소)"}},"next":{"fields":{"slug":"/my_project/230329_bcow_start/"},"frontmatter":{"title":"로또 커뮤니티 서비스 흑우집합소 오픈하다"}}}},"staticQueryHashes":["3128451518","903436796"]}