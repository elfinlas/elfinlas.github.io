{"componentChunkName":"component---src-templates-post-jsx","path":"/nginx/230331_file_upload_size/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab"}},"markdownRemark":{"id":"f298ef5b-df6c-5f73-b42f-ceaac1834bfc","excerpt":"파일 업로드를 했는데... 흑우집합소를 개발하고, 로컬에서 잘 되던 파일 업로드 기능이 이상하게 배포만 하면 에러가 났다. -_-;; Nest.Js의 서버측에서는 파일 사이즈를 분명 설정하고 잘 맞춰뒀는데 왜 그런 에러가 발생하는지 이유가 궁금했다...  에러는 복잡했는데 Status…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/29d31/thumbnail_nginx.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB47VGdJL/AP/EABoQAAICAwAAAAAAAAAAAAAAAAECABEQEiH/2gAIAQEAAQUCtoGNu3dRn//EABYRAQEBAAAAAAAAAAAAAAAAAAAREv/aAAgBAwEBPwHSv//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/Aar/xAAZEAEBAAMBAAAAAAAAAAAAAAABABAhIjH/2gAIAQEABj8C9Y23LMY//8QAGxABAAMBAAMAAAAAAAAAAAAAAQARITFRYZH/2gAIAQEAAT8hqL+zNZ33cl+mvS+ZqKiBQgD2f//aAAwDAQACAAMAAAAQsB//xAAXEQADAQAAAAAAAAAAAAAAAAAAAVER/9oACAEDAQE/EMQSw//EABYRAQEBAAAAAAAAAAAAAAAAAAARUf/aAAgBAgEBPxCcS//EABsQAAMBAQADAAAAAAAAAAAAAAERIQBBUXHB/9oACAEBAAE/EOQiOuBKgjvDHzACYBaFb1xYSFAS4o4AR5OaI0Vd/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"thumbnail\"\n        title=\"\"\n        src=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/6aca1/thumbnail_nginx.jpg\"\n        srcset=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/d2f63/thumbnail_nginx.jpg 163w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/c989d/thumbnail_nginx.jpg 325w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/6aca1/thumbnail_nginx.jpg 650w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/29d31/thumbnail_nginx.jpg 700w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"파일-업로드를-했는데\" style=\"position:relative;\"><a href=\"#%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C%EB%A5%BC-%ED%96%88%EB%8A%94%EB%8D%B0\" aria-label=\"파일 업로드를 했는데 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>파일 업로드를 했는데...</h1>\n<p>흑우집합소를 개발하고, 로컬에서 잘 되던 파일 업로드 기능이 이상하게 배포만 하면 에러가 났다. -_-;;<br>\nNest.Js의 서버측에서는 파일 사이즈를 분명 설정하고 잘 맞춰뒀는데 왜 그런 에러가 발생하는지 이유가 궁금했다...</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5478dd8f9eb0b70a42a8af6e0c0d8917/e80ac/img01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.496932515337424%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAn0lEQVR42kWMCw+CMAyE+f+/TuQRAzIgcTxE4yOwsXXzLMPEJl+uvV4bGePgHMHRH9rUWvYdrDFY5hlqWQLee4Z92vfEuQ3Dua2ishlQiQqiaVDVNfcCJXMqiqBnRrQtVj74YK+VDOZVwVqCUgpaa1a9P3weY0xZjinNcE3S0N/yHOMh/nlJ8BdRw18kSHbwfQ/bdXgPQ+DF80NKqPuILw4n4wjFxcCQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img01\"\n        title=\"\"\n        src=\"/static/5478dd8f9eb0b70a42a8af6e0c0d8917/a6d36/img01.png\"\n        srcset=\"/static/5478dd8f9eb0b70a42a8af6e0c0d8917/222b7/img01.png 163w,\n/static/5478dd8f9eb0b70a42a8af6e0c0d8917/ff46a/img01.png 325w,\n/static/5478dd8f9eb0b70a42a8af6e0c0d8917/a6d36/img01.png 650w,\n/static/5478dd8f9eb0b70a42a8af6e0c0d8917/e80ac/img01.png 809w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>에러는 복잡했는데 Status코드가 <strong>413</strong>이 돌아왔다.</p>\n<p>이 에러 코드는 클라이언트에서 보낸 요청의 크기가 서버에서 설정한 최대 한도를 초과해서 발생하는 문제다.<br>\n근데 서버는 분명 설정을 해뒀으니 누가 문제일까?</p>\n<p>역시 범인은 Nginx였다.</p>\n<h2 id=\"처리방법은\" style=\"position:relative;\"><a href=\"#%EC%B2%98%EB%A6%AC%EB%B0%A9%EB%B2%95%EC%9D%80\" aria-label=\"처리방법은 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>처리방법은?</h2>\n<p>몹시 간단하다.<br>\nNginx의 설정 값 중 <strong>client_max_body_size</strong> 값을 지정해주면 된다. <strong>(마크다운 문법 에러 때문에 _ 조심)</strong></p>\n<h3 id=\"client_max_body_size-설정하기\" style=\"position:relative;\"><a href=\"#client_max_body_size-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0\" aria-label=\"client_max_body_size 설정하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>client_max_body_size 설정하기</h3>\n<p>nginx의 설치된 경로에 별도로 바꾸지 않았다면, <strong>nginx.conf</strong>파일을 열고 아래와 같이 값을 입력해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">user www-data;\nworker_processes auto;\npid /run/nginx.pid;\n\nhttp {\n\n\t##\n\t# Basic Settings\n\t##\n\n\tsendfile on;\n\ttcp_nopush on;\n\ttypes_hash_max_size 2048;\n\tclient_max_body_size 100m; # 이 부분처럼 설정해주고 용량을 적당하게 지정하자.\n\n    ....\n}</code></pre></div>\n<p>이렇게 처리하면 잘 될 것이다.<br>\n만약 위에 client_max_body_size 옵션 만으로도 에러가 지속되면 버퍼쪽도 올려줘야 한다.</p>\n<h3 id=\"proxy_buffer_size와-proxy_buffers-설정하기\" style=\"position:relative;\"><a href=\"#proxy_buffer_size%EC%99%80-proxy_buffers-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0\" aria-label=\"proxy_buffer_size와 proxy_buffers 설정하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>proxy_buffer_size와 proxy_buffers 설정하기</h3>\n<p>참고로 Nginx는 기본 버퍼가 16KB다.<br>\n그래서 이 부분을 더 늘려서 사용하면 된다.</p>\n<p>이것도 위에 나온 경로에 아까 설정한 client_max_body_size 값 바로 아래에 정해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">user www-data;\nworker_processes auto;\npid /run/nginx.pid;\n\nhttp {\n\n\t##\n\t# Basic Settings\n\t##\n\n\tsendfile on;\n\ttcp_nopush on;\n\ttypes_hash_max_size 2048;\n\tclient_max_body_size 100m;\n    proxy_buffer_size   64k; # 버퍼 설정 64KB\n    proxy_buffers   4 64k; # 버퍼 설정 64KB\n\n    ....\n}</code></pre></div>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p><strong>마크다운 버그인지 저기 속성들이 _(언더바)가 들어가는데 2개 이상 쓰면 저렇게 글이 뭉개진다.</strong><br>\n<strong>그래서 저 옵션은 꼭 잘 확인하자.</strong></p>\n<p>이렇게 처리한다면 더 이상 413이니 이상한 에러는 안날 것이다.<br>\n물론 백엔드 코드가 잘못되어 있다면 에러는 발생하겠지만...</p>\n<p>PS : 하다보니 Nginx가 범인이 아니라 무지한 내가 범인인듯....</p>\n<div class=\"gatsby-highlight\" data-language=\"toc\"><pre class=\"language-toc\"><code class=\"language-toc\"></code></pre></div>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C%EB%A5%BC-%ED%96%88%EB%8A%94%EB%8D%B0\">파일 업로드를 했는데...</a></p>\n<ul>\n<li>\n<p><a href=\"#%EC%B2%98%EB%A6%AC%EB%B0%A9%EB%B2%95%EC%9D%80\">처리방법은?</a></p>\n<ul>\n<li><a href=\"#client_max_body_size-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0\">client_max_body_size 설정하기</a></li>\n<li><a href=\"#proxy_buffer_size%EC%99%80-proxy_buffers-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0\">proxy_buffer_size와 proxy_buffers 설정하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></p>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"Nginx에서 파일 업로드 사이즈 용량 처리","description":null,"date":"March 31, 2023","tags":["Nginx"],"series":"Nginx","previewImage":"nginx_logo.webp","isPrivate":null,"writer":null}},"previous":{"fields":{"slug":"/til/230324_til/"},"frontmatter":{"title":"23년 3월 24일 TIL & 개발노트 (Typescript에서 문자열 상수, 그리고 코드 리팩토링)","isPrivate":null}},"next":{"fields":{"slug":"/nest_js/230401_ipv6_ipv4/"},"frontmatter":{"title":"Nest.js에서 Ip 조회할 때 IpV6로 표시되는 것을 IpV4로 바꾸기","isPrivate":null}}},"pageContext":{"id":"f298ef5b-df6c-5f73-b42f-ceaac1834bfc","previousPostId":"2a875bbb-bc02-5ce5-b2d1-d2824688ead5","nextPostId":"4faf903c-517b-5f9a-9798-68f088e76684"}},"staticQueryHashes":[],"slicesMap":{}}