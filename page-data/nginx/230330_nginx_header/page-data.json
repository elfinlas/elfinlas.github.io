{"componentChunkName":"component---src-templates-post-template-index-tsx","path":"/nginx/230330_nginx_header/","result":{"data":{"cur":{"id":"c88b8f0b-1230-5d9e-82b6-6ab0e1366f50","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB4zZGdJL/AP/EABoQAAICAwAAAAAAAAAAAAAAAAABAhEQEiH/2gAIAQEAAQUCtibucu6rCP/EABYRAQEBAAAAAAAAAAAAAAAAAAAREv/aAAgBAwEBPwHSv//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/Aar/xAAZEAEBAAMBAAAAAAAAAAAAAAABABAhIjH/2gAIAQEABj8C9jbcsxj/xAAbEAACAwADAAAAAAAAAAAAAAABEQAhMVFhkf/aAAgBAQABPyFI37Hs6XdRgYdS0FCFXiAC3P/aAAwDAQACAAMAAAAQwP8A/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERUf/aAAgBAwEBPxCMEp//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8QykP/xAAZEAEBAQEBAQAAAAAAAAAAAAABEQAhQXH/2gAIAQEAAT8QWGInt4cFCtTFPPmByQI0na/PJjksDmFCgeuuMhYzu//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/7c297/thumbnail_nginx.webp 180w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/33ecc/thumbnail_nginx.webp 360w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/84c6d/thumbnail_nginx.webp 700w\"\n              sizes=\"(max-width: 700px) 100vw, 700px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/98e5d/thumbnail_nginx.jpg 180w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/543cd/thumbnail_nginx.jpg 360w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/40619/thumbnail_nginx.jpg 700w\"\n            sizes=\"(max-width: 700px) 100vw, 700px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/40619/thumbnail_nginx.jpg\"\n            alt=\"thumbnail\"\n            title=\"thumbnail\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<h1 id=\"분명-로컬에서는-잘-되었는데\" style=\"position:relative;\"><a href=\"#%EB%B6%84%EB%AA%85-%EB%A1%9C%EC%BB%AC%EC%97%90%EC%84%9C%EB%8A%94-%EC%9E%98-%EB%90%98%EC%97%88%EB%8A%94%EB%8D%B0\" aria-label=\"분명 로컬에서는 잘 되었는데 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>분명 로컬에서는 잘 되었는데…</h1>\n<p>흑우집합소 개발이 다 되서 프로덕션 환경에서 배포 후 처리를 하는데 로그인 부분이 제대로 되지 않았다.<br>\n왜 그런가 콘솔 로그까지 찍어가며 확인해본 결과 헤더의 특정 값이 전달되지 않았다.</p>\n<p>그래서 찾아보니…<br>\nNginx는 기본 헤더나 잘 알려진 기본 헤더 값만 전송한다고 한다.</p>\n<p>기본 Http 헤더는 <a href=\"https://developer.mozilla.org/ko/docs/Web/HTTP/Headers\">모질라 개발 문서</a>를 참고하자.<br>\n무튼 어떻게 해야 하나 방법을 찾아보니 의외로 간단했다.</p>\n<h2 id=\"how-to\" style=\"position:relative;\"><a href=\"#how-to\" aria-label=\"how to permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to?</h2>\n<p>참고로 난 Http로 오면 https로 포워딩하고, 내부 프론트엔드를 바라보게 되어있다.<br>\n그리고 설정은 다 못까지만 일부는 오픈한다.<br>\n또한 Ubuntu 환경에서 진행한다.</p>\n<p>먼저 정답을 이야기 하면 두 가지 옵션을 넣으면 된다.<br>\n<strong>underscores_in_headers</strong> 와 <strong>proxy_pass_request_headers</strong> 옵션이다.</p>\n<p>설명을 이어나가면…<br>\n<strong>nginx.conf</strong> 또는 자신의 별도 설정 파일에서 포워딩하는 부분을 찾는다.</p>\n<p>아래는 80에서 443으로 포워딩하는 부분이다.<br>\n여기는 설정할게 없다.</p>\n<p>다음은 https쪽이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">### 443 (Https)\nserver {\n  #기본 설정\n  listen 443;\n  listen [::]:443;\n  root /var/www/html;\n\n  server_name bcow.world;\n\n  underscores_in_headers on; #언더스코어 형식 헤더 허용\n  location / {\n    proxy_set_header Range $saferange;\n\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    proxy_set_header X-NginX-Proxy true;\n\n    proxy_pass http://localhost:68742;\n    proxy_pass_request_headers on; #리퀘스트로 온 헤더를 프록시로 전달\n  }\n}</code></pre></div>\n<p>저기 주석에 나온 것처럼 하면 된다.<br>\n헤더에 난 _(언더스코어)를 써서 보내는 것들이 있어서 저 옵션도 넣었다.</p>\n<p>이렇게 하니까 해결이 되었다.</p>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>내가 두 서비스를 배포하면서 느낀게 있다.<br>\n로컬에서는 잘 되는데 배포를 하면 안되는 경우, 변경된 개발환경을 살펴봐라.</p>\n<p>그 변경된 개발환경이 나의 경우 nginx밖에 없었기에 이 부분이 정답이었다.<br>\n왜 안되지라고 시간 많이 먹을 뻔 했다…</p>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#how-to\">How to?</a></li>\n<li><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></li>\n</ul>\n</div>","excerpt":"분명 로컬에서는 잘 되었는데… 흑우집합소 개발이 다 되서 프로덕션 환경에서 배포 후 처리를 하는데 로그인 부분이 제대로 되지 않았다. 왜 그런가 콘솔 로그까지 찍어가며 확인해본 결과 헤더의 특정 값이 전달되지 않았다. 그래서 찾아보니… Nginx는 기본 헤더나 잘 알려진 기본 헤더 값만 전송한다고 한다. 기본 Http 헤더는 모질라 개발 문서를 참고하자. 무튼 어떻게 해야 하나 방법을 찾아보니 의외로 간단했다. How to? 참고로 난 Http로 오면 https로 포워딩하고, 내부 프론트엔드를 바라보게 되어있다. 그리고 설정은 다 못까지만 일부는 오픈한다. 또한 Ubuntu 환경에서 진행한다. 먼저 정답을 이야기 하면 두 가지 옵션을 넣으면 된다. underscores_in_headers 와 proxy_pass_request_headers 옵션이다. 설명을 이어나가면… nginx.conf 또는 자신의 별도 설정 파일에서 포워딩하는 부분을 찾는다. 아래는 80에서 443으로 포워딩하…","frontmatter":{"date":"2023.03.30","title":"Nginx에서 헤더 전달하기 (프록시 사용)","categories":"nginx","emoji":"📜"},"fields":{"slug":"/nginx/230330_nginx_header/"}},"next":{"id":"54349601-4d04-50c2-a414-828c2cc296c2","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABMElEQVQoz42S0Y6CMBBFW6Cl0GmhxYorrJpAsolP+v8fdzetrqtmxX24GToZztxOhzHGcC+vCEOzwqA9drTCJ3XYmRX2NuDQrJN647A2LYzSeP6fPSciQBTir8KknGegvESTqwRXolwGRmdK/haFEDBNE7bDAOf9Q+26btCWehkYryfy4nbWWmMcxwQmopTjjF+aVRauomVgnFWeZQ85znnSc21XEnxtl4FxLnFOPyApZXJpjEFd18jumnmp0Wn7D4dXYLziPM84Ho84n844n06pwc2hJHS6eePQBpTi8srRTV4UYJwl5fLx9Z3UCNQuA3tlMbuPtIss42grwtZ22BiHnlz6vpw9Dm2PWqpl4A1cWXyFEVRWqLmAzmQSpShSLHnxfrH5NZJQmNzm5YK/0jegveteJRG0qAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/39caabbd44b8d6bf6560fecef746ecb3/7c297/thumbnail_til.webp 180w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/33ecc/thumbnail_til.webp 360w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/df77d/thumbnail_til.webp 720w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/dd3ab/thumbnail_til.webp 895w\"\n              sizes=\"(max-width: 720px) 100vw, 720px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/39caabbd44b8d6bf6560fecef746ecb3/e9ea2/thumbnail_til.png 180w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/53918/thumbnail_til.png 360w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/242a6/thumbnail_til.png 720w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/b002d/thumbnail_til.png 895w\"\n            sizes=\"(max-width: 720px) 100vw, 720px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/39caabbd44b8d6bf6560fecef746ecb3/242a6/thumbnail_til.png\"\n            alt=\"thumbnail\"\n            title=\"thumbnail\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<h1 id=\"흑우집합소-개발을-하며\" style=\"position:relative;\"><a href=\"#%ED%9D%91%EC%9A%B0%EC%A7%91%ED%95%A9%EC%86%8C-%EA%B0%9C%EB%B0%9C%EC%9D%84-%ED%95%98%EB%A9%B0\" aria-label=\"흑우집합소 개발을 하며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>흑우집합소 개발을 하며…</h1>\n<blockquote>\n<p>PS : 아래 예제에서 호출되는 url은 참고용입니다</p>\n</blockquote>\n<br>\n<p>개발이 거의 끝나가는 무렵이었다.<br>\n사실 막 짠 코드가 좀 있었고…</p>\n<p>로직이 좀 엉상한 부분도 있었다.<br>\n그래서 미래에 또 헤매거나 복잡함을 피하기 위해 찌금 작업을 좀 해두자 라는 마인드로…<br>\n일부 리팩토링을 진행했다.</p>\n<h2 id=\"1-똥이-되어가는-코드를-코드-리팩토링\" style=\"position:relative;\"><a href=\"#1-%EB%98%A5%EC%9D%B4-%EB%90%98%EC%96%B4%EA%B0%80%EB%8A%94-%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%BD%94%EB%93%9C-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81\" aria-label=\"1 똥이 되어가는 코드를 코드 리팩토링 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 똥이 되어가는 코드를 코드 리팩토링</h2>\n<p>프론트엔드 영역에서 Axios를 호출하는 부분에 대한 고민이 깊어졌다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">await</span> <span class=\"token function\">excuteAxiosInbound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  inboundRequestConfig<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    url<span class=\"token operator\">:</span> <span class=\"token string\">'/api/test/some/url'</span><span class=\"token punctuation\">,</span>\n    data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> url<span class=\"token operator\">:</span> <span class=\"token string\">'acc/logout'</span><span class=\"token punctuation\">,</span> method<span class=\"token operator\">:</span> <span class=\"token string\">'post'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>responseData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//로그이웃 처리 및 기타 작업 ing~</span>\n    router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/gogo/somewhere'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">axiosClientErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> axiosError<span class=\"token operator\">:</span> e <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이렇게 되어 있다.<br>\n물론 전체 코드는 아니고 호출되는 영역만 가져왔다.</p>\n<p>근데 이걸 매번 호출할 때마다 반복적으로 작성해야 하는 부분이 마음에 안들었다.<br>\n지금 호출 로직은 아래의 세 가지 문제점이 발생한다.</p>\n<b>\n<blockquote>\n<ol>\n<li>저 호출 부분에서 성공 시 또는 실패 시 처리해야 할 공통 로직이 추가된다면 일일히 바꿔야 하는 문제가 생긴다.</li>\n<li>setLoading과 같은 상태 관리(Zustant)의 로직을 호출 컴포넌트마다 작성해야 한다.</li>\n<li>매번 인바운드(내부 api 주소로 호출하는 영역) 부분의 주소를 적거나 아웃바운드(백엔드 쪽)로 내보내야 하는 부분이 겹칠 때가 있다.</li>\n</ol>\n</blockquote>\n</b>\n<br>\n<p>이런 문제로 인해 저 부분을 공통 로직으로 만들어 쓰기로 하고…<br>\n이를 해결하기 위해 몇 가지 고민을 했다.</p>\n<b>\n<blockquote>\n<ol>\n<li>then 성공 로직에서 성공 시 공통으로 처리할 함수를 적어주기 (예외 발생시 처럼)</li>\n<li>excuteAxiosInbound 함수 자체를 전달인자로 바꾸기</li>\n<li>inbound로 나가는 axios를 개선</li>\n</ol>\n</blockquote>\n</b>\n<br>\n<p>해결법에서 1번은 사실 좋은 선택은 아니었다.<br>\n만들어갈 결과물에 포함될 방법일 뿐 그 자체만으로는 해결이 되지 않는다.</p>\n<p>2번은 생각해보니 성공 실패 로직에 대한 것을 호출 영역에서 함수로 전달하면 될 것 같다는 생각이 들었다.<br>\n3번은 지금도 되어 있긴 한데 문제 2번의 스토어를 넣어서 같이 사용하는 방향으로 하면 좋을 것 같았다.</p>\n<p>그래서 해결을 위해 호출하는 공통 로직을 Custom Hook으로 만들어야 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useCallback <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> SweetAlertOptions <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'sweetalert2'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> SendAxiosRequestConfig <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/axios/axios.type'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> excuteAxiosInbound <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/axios/axios.util'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> axiosClientErrorHandler <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/axios/errors/axios.client.error.handler'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> useSetAccountInfo <span class=\"token keyword\">from</span> <span class=\"token string\">'./stores/use.account.info'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> useLoading <span class=\"token keyword\">from</span> <span class=\"token string\">'./stores/use.loading'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AxiosCallClientHandlerInputDto</span> <span class=\"token punctuation\">{</span>\n  outboundData<span class=\"token operator\">:</span> SendAxiosRequestConfig<span class=\"token punctuation\">;</span>\n  successAction<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">;</span>\n  failSwal<span class=\"token operator\">:</span> SweetAlertOptions<span class=\"token punctuation\">;</span>\n  setLoadingAction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">;</span>\n  outboundHeader<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//Outbound로 헤더 보낼 때 쓰는 속성</span>\n  inboundUrl<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//inbound 호출 URL이 다른 경우 별도 작성 (Default = api/hub)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Axis 내부 호출 Hook\n * @returns\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useAxiosInbound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> handleSetLoading <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useLoading</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> handleLogoutAccountInfo <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSetAccountInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//변수 선언</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">axiosCallClientHandler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>params<span class=\"token operator\">:</span> AxiosCallClientHandlerInputDto<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//로딩</span>\n    <span class=\"token function\">handleSetLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">await</span> <span class=\"token function\">excuteAxiosInbound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      inboundRequestConfig<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        url<span class=\"token operator\">:</span> params<span class=\"token operator\">?.</span>inboundUrl <span class=\"token operator\">?</span> params<span class=\"token punctuation\">.</span>inboundUrl <span class=\"token operator\">:</span> <span class=\"token string\">'/use_api/back/inbound/axios'</span><span class=\"token punctuation\">,</span>\n        data<span class=\"token operator\">:</span> params<span class=\"token punctuation\">.</span>outboundData<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      outboundHeader<span class=\"token operator\">:</span> params<span class=\"token punctuation\">.</span>outboundHeader<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">handleSetLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>responseData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">successAction</span><span class=\"token punctuation\">(</span>responseData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">axiosClientErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          axiosError<span class=\"token operator\">:</span> e<span class=\"token punctuation\">,</span>\n          handleLogoutAccountInfo<span class=\"token punctuation\">,</span>\n          failSwal<span class=\"token operator\">:</span> params<span class=\"token punctuation\">.</span>failSwal<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//메모제이션을 해준다.</span>\n  <span class=\"token keyword\">const</span> handleExcuteAxiosInbound <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span>params<span class=\"token operator\">:</span> AxiosCallClientHandlerInputDto<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">axiosCallClientHandler</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>axiosCallClientHandler<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> handleExcuteAxiosInbound <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>이 Hook은 <strong>handleExcuteAxiosInbound</strong>라는 함수를 반환하는데 여기에 호출할 inputDto인 <strong>AxiosCallClientHandlerInputDto</strong>를 전달하면 된다.<br>\n그래서 호출할 컴포넌트에서는 아래와 같이 간단하게 호출할 수 있었다.</p>\n<p>그리고 <strong>useCallback</strong>을 이용해 재사용성을 하게 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">PagingProps</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//....</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">PagingComponent</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> PagingProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//some logic..</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> handleExcuteAxiosInbound <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useAxiosInbound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handle4PageChange</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>page<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">handleExcuteAxiosInbound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      outboundData<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        url<span class=\"token operator\">:</span> <span class=\"token string\">'some/page/data/list?page='</span> <span class=\"token operator\">+</span> page <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;pnum=10'</span><span class=\"token punctuation\">,</span>\n        method<span class=\"token operator\">:</span> <span class=\"token string\">'get'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function-variable function\">successAction</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>responseData<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">clearDataList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> listData <span class=\"token operator\">=</span> responseData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>resultData<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setDataList</span><span class=\"token punctuation\">(</span>listData<span class=\"token punctuation\">.</span>dataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//페이지 데이터</span>\n        <span class=\"token keyword\">const</span> pageData <span class=\"token operator\">=</span> listData<span class=\"token punctuation\">.</span>pageData<span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">setNowPage</span><span class=\"token punctuation\">(</span>pageData<span class=\"token punctuation\">.</span>nowPage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setTotalItemCnt</span><span class=\"token punctuation\">(</span>pageData<span class=\"token punctuation\">.</span>totalItemCnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setTotalPage</span><span class=\"token punctuation\">(</span>pageData<span class=\"token punctuation\">.</span>totalPage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setPerPageNum</span><span class=\"token punctuation\">(</span>pageData<span class=\"token punctuation\">.</span>perPageNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      failSwal<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        title<span class=\"token operator\">:</span> <span class=\"token string\">'데이터 로드 실패'</span><span class=\"token punctuation\">,</span>\n        html<span class=\"token operator\">:</span> <span class=\"token string\">'페이지 데이터 로드에 실패하였습니다. &lt;br> 관리자에게 문의해 주세요.'</span><span class=\"token punctuation\">,</span>\n        icon<span class=\"token operator\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n        confirmButtonText<span class=\"token operator\">:</span> <span class=\"token string\">'확인'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>개선된 코드는 간단 명료하다.<br>\naxios를 사용할 곳에 **useAxiosInbound()**라는 hook을 호출하여 실제 Axios 작업을 하는 함수를 불러온다.</p>\n<p>성공은 호출되는 영역마다 작업이 상이해서 저렇게 함수를 전달하지만,<br>\n실패는 언제나 지정된 양식이 있기에 공통으로 처리하고, 그 이외 예외는 알럿을 호출할 수 있게 해줬다.</p>\n<p>저 inputDto 자체는 재사용이 안되고, 호출 지점마다 고유해서 이 정도만 해도 많이 개선이 되었다고 판단했다.</p>\n<h2 id=\"2-배포만-하면-문제\" style=\"position:relative;\"><a href=\"#2-%EB%B0%B0%ED%8F%AC%EB%A7%8C-%ED%95%98%EB%A9%B4-%EB%AC%B8%EC%A0%9C\" aria-label=\"2 배포만 하면 문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 배포만 하면 문제…</h2>\n<p>이제는 몇 가지 테스트를 위해 배포를 해봤는데 자꾸 몇 가지 기능이 정상적으로 동작하지 않았다.<br>\n로그인 부분과 이중 로그인 영역 쪽이었다.</p>\n<p>그래서 20분 고민하다가…<br>\n내 로컬과 배포 환경과의 차이점이 뭘까?</p>\n<b>\n<blockquote>\n<ol>\n<li>pm2 구동환경</li>\n<li>방화벽</li>\n<li>nginx</li>\n<li>aws와 Cloudflare의 환경</li>\n</ol>\n</blockquote>\n</b>\n<p>그래서 각 부분을 하나씩 점검했다.<br>\n1번의 경우 문제는 아니었다.<br>\n어짜피 구동하는건 로컬이나 pm2로 올리나 똑같으니까?</p>\n<p>2번 방화벽도 재점검 했는데 문제는 아니었다.<br>\n백엔드는 지정된 ip와 서버 내, 그리고 nginx에서 제대로 프록싱 하고 있었다.</p>\n<p>3번…이 정답이었다.<br>\nNginx는 기본적으로 헤더를 알려진 값 외에는 막는다.</p>\n<p>그래서 내가 커스텀으로 사용한 헤더가 정상적으로 전달이 되지 않은 문제가 답이었다.<br>\n이와 관련된 내용은 <a href=\"https://elfinlas.github.io/nginx/230330_nginx_header/\">Nginx에서 헤더 전달하기 (프록시 사용)</a> 포스팅을 참고하자.</p>\n<br>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>역시 코드를 잘 작성하는 부분이 중요하다.<br>\n백엔드의 경우 Layer 아키텍쳐에서 포트 앱 어댑으로 바꾸고 나서 정말 코드 보기가 편해졌다.</p>\n<p>그리고 리팩토링…<br>\n개인적으로 리팩토링은 코드를 계속 지속 가능성이 될 수 있도록 해주는 중요한 수단인 것 같다.</p>\n<p>배포환경…<br>\n빨리 찾아서 다행이지…<br>\n좀만 더 늦었으면 와인 까서 마시면서 엄한 곳이나 쑤셨을 듯 싶다…</p>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#1-%EB%98%A5%EC%9D%B4-%EB%90%98%EC%96%B4%EA%B0%80%EB%8A%94-%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%BD%94%EB%93%9C-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81\">1. 똥이 되어가는 코드를 코드 리팩토링</a></li>\n<li><a href=\"#2-%EB%B0%B0%ED%8F%AC%EB%A7%8C-%ED%95%98%EB%A9%B4-%EB%AC%B8%EC%A0%9C\">2. 배포만 하면 문제…</a></li>\n<li><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></li>\n</ul>\n</div>","frontmatter":{"date":"2023.03.30","title":"23년 3월 29일 TIL & 개발노트 (코드 리팩토링, 배포환경)","categories":"til","emoji":"📜"},"fields":{"slug":"/til/230329_til/"}},"prev":{"id":"eb63d062-494f-57d5-abd4-13b611554a74","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABMElEQVQoz42S0Y6CMBBFW6Cl0GmhxYorrJpAsolP+v8fdzetrqtmxX24GToZztxOhzHGcC+vCEOzwqA9drTCJ3XYmRX2NuDQrJN647A2LYzSeP6fPSciQBTir8KknGegvESTqwRXolwGRmdK/haFEDBNE7bDAOf9Q+26btCWehkYryfy4nbWWmMcxwQmopTjjF+aVRauomVgnFWeZQ85znnSc21XEnxtl4FxLnFOPyApZXJpjEFd18jumnmp0Wn7D4dXYLziPM84Ho84n844n06pwc2hJHS6eePQBpTi8srRTV4UYJwl5fLx9Z3UCNQuA3tlMbuPtIss42grwtZ22BiHnlz6vpw9Dm2PWqpl4A1cWXyFEVRWqLmAzmQSpShSLHnxfrH5NZJQmNzm5YK/0jegveteJRG0qAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/39caabbd44b8d6bf6560fecef746ecb3/7c297/thumbnail_til.webp 180w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/33ecc/thumbnail_til.webp 360w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/df77d/thumbnail_til.webp 720w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/dd3ab/thumbnail_til.webp 895w\"\n              sizes=\"(max-width: 720px) 100vw, 720px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/39caabbd44b8d6bf6560fecef746ecb3/e9ea2/thumbnail_til.png 180w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/53918/thumbnail_til.png 360w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/242a6/thumbnail_til.png 720w,\n/static/39caabbd44b8d6bf6560fecef746ecb3/b002d/thumbnail_til.png 895w\"\n            sizes=\"(max-width: 720px) 100vw, 720px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/39caabbd44b8d6bf6560fecef746ecb3/242a6/thumbnail_til.png\"\n            alt=\"thumbnail\"\n            title=\"thumbnail\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<p><br><br><br><br></p>\n<h1 id=\"개발하며-얻은-til\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EB%B0%9C%ED%95%98%EB%A9%B0-%EC%96%BB%EC%9D%80-til\" aria-label=\"개발하며 얻은 til permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개발하며 얻은 TIL</h1>\n<p>흑우집합소 개발하며 얻은 내용 및 노션에 작성한 내용을 정리한 포스팅이다.<br>\n오늘 개발하면서 배운 내용은 아래와 같다.</p>\n<ol>\n<li>예외처리의 미흡함 (예외처리 부분)</li>\n<li>문자열 상수(String Literal) - Typescript Object 키 문제</li>\n<li>반복적 코드를 줄이는 리팩토링</li>\n</ol>\n<p>각 항목은 아래의 내용을 참고하자.</p>\n<h2 id=\"1-예외처리-부분\" style=\"position:relative;\"><a href=\"#1-%EC%98%88%EC%99%B8%EC%B2%98%EB%A6%AC-%EB%B6%80%EB%B6%84\" aria-label=\"1 예외처리 부분 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 예외처리 부분</h2>\n<p>오늘도 개발을 하던 도중 코드가 이상한 부분을 찾게 되었다.<br>\n백엔드 측의 에러 핸들링 부분이었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>exception <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//토큰 문제가 발생한 경우</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-1'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-2'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-3'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-4'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-5'</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> decodeData <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodeJwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">accessJwtDecode</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//로그아웃 처리</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>logoutAccountInboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      email<span class=\"token operator\">:</span> decodeData<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n      joinType<span class=\"token operator\">:</span> decodeData<span class=\"token punctuation\">.</span>joinType<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Error Handler 부분의 일부다.<br>\n여기서 저기 <strong>const decodeData</strong> 부분의 로직을 보면 request의 헤더로부터 jwt를 가져오는 부분이 있다.</p>\n<p>만약 헤더에 jwt를 안가지고 올 경우 어떻게 될까?<br>\n또 버그를 양산하는 모양새가 된다.</p>\n<p>물론 <strong>jwtStrategy</strong>에서 검증을 하겠지만, 혹시 <strong>AuthExceptionHandler</strong>를 strategy 없이 사용하는 곳에서 발생했다면?<br>\n그래서 이 부분은 검사를 한번 더 하는 방향으로 로직을 수정했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>exception <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//토큰 문제가 발생한 경우</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-1'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-2'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-3'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-4'</span> <span class=\"token operator\">||</span>\n    exception<span class=\"token punctuation\">.</span>errorCode <span class=\"token operator\">===</span> <span class=\"token string\">'8-5'</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//만약 JWT가 헤더 안에 있다면...</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> decodeData <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodeJwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">accessJwtDecode</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">//로그아웃 처리</span>\n      <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>logoutAccountInboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        email<span class=\"token operator\">:</span> decodeData<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n        joinType<span class=\"token operator\">:</span> decodeData<span class=\"token punctuation\">.</span>joinType<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 한번 보호를 함으로써 예외를 막을 수 있었다.</p>\n<h2 id=\"2-typescript-object-키-문제\" style=\"position:relative;\"><a href=\"#2-typescript-object-%ED%82%A4-%EB%AC%B8%EC%A0%9C\" aria-label=\"2 typescript object 키 문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Typescript Object 키 문제</h2>\n<p>개발을 하던 도중 아래와 같은 코드를 작성했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">F_HEADER_BKEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">'test_key'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> defaultH<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">'key-str'</span><span class=\"token operator\">:</span> <span class=\"token string\">'value-str'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">'F_HEADER_BKEY'</span><span class=\"token operator\">:</span> <span class=\"token string\">'111aaa'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'show value = '</span><span class=\"token punctuation\">,</span> defaultH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이렇게 작성할 경우 결과는 아래와 같아 나온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[LOG]: \"show value = \",  {\n  \"key-str\": \"value-str\",\n  \"F_HEADER_BKEY\": \"111aaa\"\n}</code></pre></div>\n<p>내가 원하는 그림은 <strong>F-HEADER_BKEY</strong>의 값이 저 상수 이름 값이 아닌,<br>\n<strong>test_key</strong> 상수의 값이 들어가길 원했다.</p>\n<p>이 문제를 해결하려면 아래와 같이 작성한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">F_HEADER_BKEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">'test_key'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span>\n<span class=\"token keyword\">const</span> defaultH<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">'key-str'</span><span class=\"token operator\">:</span> <span class=\"token string\">'value-str'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\ndefaultH<span class=\"token punctuation\">[</span><span class=\"token constant\">F_HEADER_BKEY</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"aaa\"</span>\n\n<span class=\"token comment\">//결과</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token constant\">LOG</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token string\">\"show value = \"</span><span class=\"token punctuation\">,</span>  <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">\"key-str\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"value-str\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"test_key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aaa\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>맨 처음처럼 나타나는 이유는 내가 선언한 <strong>defaultH</strong>의 경우,<br>\n타입이 다음과 같이 <strong>{ [key: string]: string }</strong> 되어 있다.</p>\n<p>즉 key는 string으로 되어 있기에 string 자체로 인식을 해버린다.<br>\n하지만 두 번째 제대로 나오는 부분에서는 Object형에 접근하기 위한 값으로 사용한 것이,<br>\n문자열(string)이 아닌 **상수 문자열(string literal)**를 사용했기에 적용이 된다.</p>\n<p>그리고 하나 더 찝어서 이야기 하면 아래와 같은 코드도 동작이 안될 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">defaultH<span class=\"token punctuation\">.</span><span class=\"token constant\">F_HEADER_BKEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"aaa\"</span>\n\n<span class=\"token comment\">//결과</span>\n<span class=\"token punctuation\">[</span><span class=\"token constant\">LOG</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token string\">\"show value = \"</span><span class=\"token punctuation\">,</span>  <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">\"key-str\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"value-str\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"test_key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aaa\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"F_HEADER_BKEY\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"a111\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이거는 간단한 것이 object에 .(Dot)으로 접근 시 해당 키를 이용해 접근하는 방식이다.<br>\n하지만 여기도 <strong>F-HEADER_BKEY</strong>를 문자열 자체로 받아들인다.</p>\n<p>이게 문자열 상수 값으로 받아들여지지 않고, 그냥 문자열 자체로 받아들인단 의미다.<br>\n그래서 혹시 선언된 객체형에 키를 동적으로 쓰고 싶다면 <strong>[]</strong> 형식을 이용해서 접근하는게 좋다.</p>\n<h2 id=\"3-반복적-코드를-줄이는-리팩토링\" style=\"position:relative;\"><a href=\"#3-%EB%B0%98%EB%B3%B5%EC%A0%81-%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%A4%84%EC%9D%B4%EB%8A%94-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81\" aria-label=\"3 반복적 코드를 줄이는 리팩토링 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 반복적 코드를 줄이는 리팩토링</h2>\n<p>백엔드 측을 개발하면서 다음과 같은 코드가 있었다.<br>\n(아래 코드는 예시를 위해 사용하여 일부 변수 및 내용이 코드 문법에 어긋날 수 있습니다.)</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtStrategy</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">PassportStrategy</span><span class=\"token punctuation\">(</span>Strategy<span class=\"token punctuation\">,</span> <span class=\"token string\">'Jwt'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">VERIFY_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> verifyjwtOutboundPort<span class=\"token operator\">:</span> VerifyJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">DECODE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> decodJwtOutboundPort<span class=\"token operator\">:</span> DecodeJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">CREATE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> createJwtOutboundPort<span class=\"token operator\">:</span> CreateJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">FIND_ACCOUNT_EMAIL_JOINTYPE_STATUS_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> findAccountEmailJoinTypeOutboundPort<span class=\"token operator\">:</span> FindAccountEmainJoinTypeStatusOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">LOGOUT_ACCOUNT_INBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> logoutAccountInboundPort<span class=\"token operator\">:</span> LogoutAccountInboundPort<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token operator\">&lt;</span>ParamsDictionary<span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> ParsedQs<span class=\"token punctuation\">,</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token operator\">>></span><span class=\"token punctuation\">,</span> options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> jwt <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADER_JWT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * JWT가 존재하지 않는 경우 에러 처리\n     */</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>jwt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthException</span><span class=\"token punctuation\">(</span>AuthJwtErrorCode<span class=\"token punctuation\">.</span><span class=\"token function\">jwtNotFound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> account<span class=\"token operator\">:</span> Account <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAccountInJwt</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">,</span> <span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//...Some work</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">//JWT 내에서 계정 정보를 가져오는 함수</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> <span class=\"token function\">getAccountInJwt</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> tokenType<span class=\"token operator\">:</span> JwtType<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>Account<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Access가 만료된 경우 리프레시 토큰도 체크해줘야 한다.</span>\n    <span class=\"token keyword\">const</span> jwtData <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodJwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">accessJwtDecode</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//계정 정보를 가져온다.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>findAccountEmailJoinTypeOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      u_email<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n      ua_joinType<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>joinType<span class=\"token punctuation\">,</span>\n      uStatus<span class=\"token operator\">:</span> <span class=\"token constant\">ACCOUNT_STATUS_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVE</span><span class=\"token punctuation\">,</span>\n      uAccAuth<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>근데 코드를 작성하다보니…<strong>getAccountInJwt</strong> 함수의 경우 다른 곳에서도 비슷한 방식으로 사용되고 있었다.<br>\n쉽게말해 중복적으로 코드가 작성되고 있었다.</p>\n<p>이 부분은 <strong>Inbound Port</strong> 성향의 서비스 로직으로 분리할 수 있었다.<br>\n난 <strong>Port &#x26; Adaptor</strong> 아키텍쳐 방식을 사용할 때 In과 Out을 저번에 받은 강의 내요을 토대로 사용한다.</p>\n<p>In 성향은 외부 세계에서 요청이 오는 경우로 나누고,<br>\nOut은 백엔드 내에서 처리하여 인프라 쪽과 연계되는 경우로 나눈다.</p>\n<p>지금처럼 Jwt를 받아서 그 안에 담겨있는 정보를 요청해야 하는 경우,<br>\n이 성향은 Inbound 성향이라 할 수 있다.</p>\n<p>설령 내부에서 호출한다 해도 jwt라는 속성 자체가 외부에서 오기 때문이다.<br>\n물론 인프라 측의 DB 로직을 한번 타긴 하는데, 난 이런 경우 처음 접근하는 변수를 기준으로 잡는다.</p>\n<p>그래서 이 부분은 <strong>Inbound Port</strong>로 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">//Inbound Port 정의</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> JwtType <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/domain/auth/types/jwt.enums'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">GET_ACCOUNT_IN_JWT_INBOUND_PORT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Get_Account_In_Jwt_Inbound_Port'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GetAccountInJwtInputDto</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  jwt<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  jwtType<span class=\"token operator\">:</span> JwtType<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GetAccountInJwtOutputDto</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">GetAccountInJwtInboundPort</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">excute</span><span class=\"token punctuation\">(</span>params<span class=\"token operator\">:</span> GetAccountInJwtInputDto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//인바운드 인터페이스 구현체 서비스</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GetAccountInJwtService</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">GetAccountInJwtInboundPort</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">DECODE_JWT_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> decodJwtOutboundPort<span class=\"token operator\">:</span> DecodeJwtOutboundPort<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">FIND_ACCOUNT_EMAIL_JOINTYPE_STATUS_OUTBOUND_PORT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> findAccountEmailJoinTypeOutboundPort<span class=\"token operator\">:</span> FindAccountEmainJoinTypeStatusOutboundPort<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">excute</span><span class=\"token punctuation\">(</span>params<span class=\"token operator\">:</span> GetAccountInJwtInputDto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Access가 만료된 경우 리프레시 토큰도 체크해줘야 한다.</span>\n    <span class=\"token keyword\">const</span> jwtData <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodJwtOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">accessJwtDecode</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//계정 정보를 가져온다.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>findAccountEmailJoinTypeOutboundPort<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      u_email<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n      ua_joinType<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>joinType<span class=\"token punctuation\">,</span>\n      uStatus<span class=\"token operator\">:</span> <span class=\"token constant\">ACCOUNT_STATUS_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVE</span><span class=\"token punctuation\">,</span>\n      uAccAuth<span class=\"token operator\">:</span> jwtData<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>위와 같이 별도 Inbound Service로 분리할 경우 아래와 같이 간단하게 작성할 수 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Inject</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">//여기서 아래의 getAccountInJwtService 인터페이스 주입을 해준다.</span>\n\n<span class=\"token comment\">//Get Account</span>\n<span class=\"token keyword\">const</span> account<span class=\"token operator\">:</span> Account <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>getAccountInJwtService<span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> jwt<span class=\"token punctuation\">,</span> jwtType<span class=\"token operator\">:</span> <span class=\"token constant\">JWT_TYPE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_TOKEN</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//기존 코드</span>\n<span class=\"token comment\">//const account: Account = await this.getAccountInJwt(jwt, JWT_TYPE.ACCESS_TOKEN);</span></code></pre></div>\n<br>\n<p>이렇게 함으로써 다른 영역에서도 해당 로직을 재사용할 수 있게 되었다.</p>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>개발을 하면서 계속 더 나은 코드를 작성하는 건 뭐랄까…<br>\n완벽할 수 없지만, 완벽에 가까워지도록 하는 형태가 된다고 해야 할까?</p>\n<p>그런 의미로 리팩토링은 참 재미있는 것 같다.</p>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#1-%EC%98%88%EC%99%B8%EC%B2%98%EB%A6%AC-%EB%B6%80%EB%B6%84\">1. 예외처리 부분</a></li>\n<li><a href=\"#2-typescript-object-%ED%82%A4-%EB%AC%B8%EC%A0%9C\">2. Typescript Object 키 문제</a></li>\n<li><a href=\"#3-%EB%B0%98%EB%B3%B5%EC%A0%81-%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%A4%84%EC%9D%B4%EB%8A%94-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81\">3. 반복적 코드를 줄이는 리팩토링</a></li>\n<li><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></li>\n</ul>\n</div>","frontmatter":{"date":"2023.03.31","title":"23년 3월 24일 TIL & 개발노트 (Typescript에서 문자열 상수, 그리고 코드 리팩토링)","categories":"til","emoji":"📜"},"fields":{"slug":"/til/230324_til/"}},"site":{"siteMetadata":{"siteUrl":"https://elfinlas.github.io","comments":{"utterances":{"repo":"elfinlas/blog_utterances"}},"projects":[{"title":"마와셀(웹) - 와인 가격 비교","description":"와인 가격 비교 서비스","techStack":["Typescript","React","Next.Js","Nest.Js"],"thumbnailUrl":"myc_icon.png","links":{"post":"https://blog.naver.com/wisseraph/223393940649","github":"","web":"https://appmyc.info","googlePlay":"","appStore":""}},{"title":"마와셀(엡) - 와인과 셀러 관리, 시음노트","description":"보유한 와인의 관리, 시음노트 작성, 보유 와인 셀러의 관리 어플리케이션","techStack":["Dart","Flutter","hive","provider"],"thumbnailUrl":"myc_icon.png","links":{"post":"https://blog.naver.com/wisseraph/223531933037","github":"","web":"","googlePlay":"https://play.google.com/store/apps/details?id=dev.mhlab.myc","appStore":"https://itunes.apple.com/kr/app/apple-store/6474965246"}},{"title":"흑우집합소(웹) - 로또번호 추천 서비스","description":"로또번호 추천 서비스","techStack":["Typescript","React","Next.Js","Nest.Js"],"thumbnailUrl":"bcow_icon.png","links":{"post":"https://blog.naver.com/wisseraph/223059966682","github":"","web":"https://bcow.world/","googlePlay":"","appStore":""}},{"title":"흑우집합소(앱) - 로또번호 추천 서비스","description":"로또번호 추천 서비스","techStack":["Dart","Flutter","drift","provider"],"thumbnailUrl":"bcow_icon.png","links":{"post":"https://blog.naver.com/wisseraph/223232966579","github":"","web":"","googlePlay":"https://play.google.com/store/apps/details?id=dev.mhlab.bcow_world","appStore":"https://itunes.apple.com/kr/app/apple-store/6470312130"}}]}}},"pageContext":{"slug":"/nginx/230330_nginx_header/","nextSlug":"/til/230329_til/","prevSlug":"/til/230324_til/"}},"staticQueryHashes":["1186322783","1321405810","3649515864"]}