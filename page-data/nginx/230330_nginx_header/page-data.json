{"componentChunkName":"component---src-templates-post-jsx","path":"/nginx/230330_nginx_header/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab"}},"markdownRemark":{"id":"fc305de8-065f-51e6-ab94-7a4b00c704a6","excerpt":"분명 로컬에서는 잘 되었는데... 흑우집합소 개발이 다 되서 프로덕션 환경에서 배포 후 처리를 하는데 로그인 부분이 제대로 되지 않았다. 왜 그런가 콘솔 로그까지 찍어가며 확인해본 결과 헤더의 특정 값이 전달되지 않았다. 그래서 찾아보니... Nginx…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/29d31/thumbnail_nginx.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB47VGdJL/AP/EABoQAAICAwAAAAAAAAAAAAAAAAECABEQEiH/2gAIAQEAAQUCtoGNu3dRn//EABYRAQEBAAAAAAAAAAAAAAAAAAAREv/aAAgBAwEBPwHSv//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/Aar/xAAZEAEBAAMBAAAAAAAAAAAAAAABABAhIjH/2gAIAQEABj8C9Y23LMY//8QAGxABAAMBAAMAAAAAAAAAAAAAAQARITFRYZH/2gAIAQEAAT8hqL+zNZ33cl+mvS+ZqKiBQgD2f//aAAwDAQACAAMAAAAQsB//xAAXEQADAQAAAAAAAAAAAAAAAAAAAVER/9oACAEDAQE/EMQSw//EABYRAQEBAAAAAAAAAAAAAAAAAAARUf/aAAgBAgEBPxCcS//EABsQAAMBAQADAAAAAAAAAAAAAAERIQBBUXHB/9oACAEBAAE/EOQiOuBKgjvDHzACYBaFb1xYSFAS4o4AR5OaI0Vd/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"thumbnail\"\n        title=\"\"\n        src=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/6aca1/thumbnail_nginx.jpg\"\n        srcset=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/d2f63/thumbnail_nginx.jpg 163w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/c989d/thumbnail_nginx.jpg 325w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/6aca1/thumbnail_nginx.jpg 650w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/29d31/thumbnail_nginx.jpg 700w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"분명-로컬에서는-잘-되었는데\" style=\"position:relative;\"><a href=\"#%EB%B6%84%EB%AA%85-%EB%A1%9C%EC%BB%AC%EC%97%90%EC%84%9C%EB%8A%94-%EC%9E%98-%EB%90%98%EC%97%88%EB%8A%94%EB%8D%B0\" aria-label=\"분명 로컬에서는 잘 되었는데 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>분명 로컬에서는 잘 되었는데...</h1>\n<p>흑우집합소 개발이 다 되서 프로덕션 환경에서 배포 후 처리를 하는데 로그인 부분이 제대로 되지 않았다.<br>\n왜 그런가 콘솔 로그까지 찍어가며 확인해본 결과 헤더의 특정 값이 전달되지 않았다.</p>\n<p>그래서 찾아보니...<br>\nNginx는 기본 헤더나 잘 알려진 기본 헤더 값만 전송한다고 한다.</p>\n<p>기본 Http 헤더는 <a href=\"https://developer.mozilla.org/ko/docs/Web/HTTP/Headers\">모질라 개발 문서</a>를 참고하자.<br>\n무튼 어떻게 해야 하나 방법을 찾아보니 의외로 간단했다.</p>\n<h2 id=\"how-to\" style=\"position:relative;\"><a href=\"#how-to\" aria-label=\"how to permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to?</h2>\n<p>참고로 난 Http로 오면 https로 포워딩하고, 내부 프론트엔드를 바라보게 되어있다.<br>\n그리고 설정은 다 못까지만 일부는 오픈한다.<br>\n또한 Ubuntu 환경에서 진행한다.</p>\n<p>먼저 정답을 이야기 하면 두 가지 옵션을 넣으면 된다.<br>\n<strong>underscores_in_headers</strong> 와 <strong>proxy_pass_request_headers</strong> 옵션이다.</p>\n<p>설명을 이어나가면...<br>\n<strong>nginx.conf</strong> 또는 자신의 별도 설정 파일에서 포워딩하는 부분을 찾는다.</p>\n<p>아래는 80에서 443으로 포워딩하는 부분이다.<br>\n여기는 설정할게 없다.</p>\n<p>다음은 https쪽이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">### 443 (Https)\nserver {\n  #기본 설정\n  listen 443;\n  listen [::]:443;\n  root /var/www/html;\n\n  server_name bcow.world;\n\n  underscores_in_headers on; #언더스코어 형식 헤더 허용\n  location / {\n    proxy_set_header Range $saferange;\n\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    proxy_set_header X-NginX-Proxy true;\n\n    proxy_pass http://localhost:68742;\n    proxy_pass_request_headers on; #리퀘스트로 온 헤더를 프록시로 전달\n  }\n}</code></pre></div>\n<p>저기 주석에 나온 것처럼 하면 된다.<br>\n헤더에 난 _(언더스코어)를 써서 보내는 것들이 있어서 저 옵션도 넣었다.</p>\n<p>이렇게 하니까 해결이 되었다.</p>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>내가 두 서비스를 배포하면서 느낀게 있다.<br>\n로컬에서는 잘 되는데 배포를 하면 안되는 경우, 변경된 개발환경을 살펴봐라.</p>\n<p>그 변경된 개발환경이 나의 경우 nginx밖에 없었기에 이 부분이 정답이었다.<br>\n왜 안되지라고 시간 많이 먹을 뻔 했다...</p>\n<div class=\"gatsby-highlight\" data-language=\"toc\"><pre class=\"language-toc\"><code class=\"language-toc\"></code></pre></div>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%B6%84%EB%AA%85-%EB%A1%9C%EC%BB%AC%EC%97%90%EC%84%9C%EB%8A%94-%EC%9E%98-%EB%90%98%EC%97%88%EB%8A%94%EB%8D%B0\">분명 로컬에서는 잘 되었는데...</a></p>\n<ul>\n<li><a href=\"#how-to\">How to?</a></li>\n<li><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"Nginx에서 헤더 전달하기 (프록시 사용)","description":null,"date":"March 30, 2023","tags":["Nginx"],"series":"Nginx","previewImage":"nginx_logo.webp","isPrivate":null,"writer":null}},"previous":{"fields":{"slug":"/til/230329_til/"},"frontmatter":{"title":"23년 3월 29일 TIL & 개발노트 (코드 리팩토링, 배포환경)","isPrivate":null}},"next":{"fields":{"slug":"/til/230324_til/"},"frontmatter":{"title":"23년 3월 24일 TIL & 개발노트 (Typescript에서 문자열 상수, 그리고 코드 리팩토링)","isPrivate":null}}},"pageContext":{"id":"fc305de8-065f-51e6-ab94-7a4b00c704a6","previousPostId":"ad412d83-fae4-534e-b378-79cf66bc7b68","nextPostId":"2a875bbb-bc02-5ce5-b2d1-d2824688ead5"}},"staticQueryHashes":[],"slicesMap":{}}