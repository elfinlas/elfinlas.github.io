{"componentChunkName":"component---src-templates-post-jsx","path":"/nginx/230401_defense_attacker/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab"}},"markdownRemark":{"id":"ef070f61-9a5a-5145-9709-bbbdc1327037","excerpt":"서비스를 열어두면... 오픈을 하고나면 정말 많은 일들이 생긴다. 도메인 주소를 어떻게 알고 이상한 메일들도 오고, 다양한 방법으로 연락이 온다. -_-;; 그래봤자 넷상이니까? 근데 이제 서비스 접근 로그 또는 nginx에 접근 로그를 보면 대환장 파티다. 이건 내 Nginx…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/29d31/thumbnail_nginx.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB47VGdJL/AP/EABoQAAICAwAAAAAAAAAAAAAAAAECABEQEiH/2gAIAQEAAQUCtoGNu3dRn//EABYRAQEBAAAAAAAAAAAAAAAAAAAREv/aAAgBAwEBPwHSv//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/Aar/xAAZEAEBAAMBAAAAAAAAAAAAAAABABAhIjH/2gAIAQEABj8C9Y23LMY//8QAGxABAAMBAAMAAAAAAAAAAAAAAQARITFRYZH/2gAIAQEAAT8hqL+zNZ33cl+mvS+ZqKiBQgD2f//aAAwDAQACAAMAAAAQsB//xAAXEQADAQAAAAAAAAAAAAAAAAAAAVER/9oACAEDAQE/EMQSw//EABYRAQEBAAAAAAAAAAAAAAAAAAARUf/aAAgBAgEBPxCcS//EABsQAAMBAQADAAAAAAAAAAAAAAERIQBBUXHB/9oACAEBAAE/EOQiOuBKgjvDHzACYBaFb1xYSFAS4o4AR5OaI0Vd/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"thumbnail\"\n        title=\"\"\n        src=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/6aca1/thumbnail_nginx.jpg\"\n        srcset=\"/static/498bbc62b7c7109bb1e79faf8d355cb5/d2f63/thumbnail_nginx.jpg 163w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/c989d/thumbnail_nginx.jpg 325w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/6aca1/thumbnail_nginx.jpg 650w,\n/static/498bbc62b7c7109bb1e79faf8d355cb5/29d31/thumbnail_nginx.jpg 700w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"서비스를-열어두면\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-%EC%97%B4%EC%96%B4%EB%91%90%EB%A9%B4\" aria-label=\"서비스를 열어두면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서비스를 열어두면...</h1>\n<p>오픈을 하고나면 정말 많은 일들이 생긴다.<br>\n도메인 주소를 어떻게 알고 이상한 메일들도 오고, 다양한 방법으로 연락이 온다. -_-;;</p>\n<p>그래봤자 넷상이니까?<br>\n근데 이제 서비스 접근 로그 또는 nginx에 접근 로그를 보면 대환장 파티다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">128.90.135.254 - - [04/Feb/2023:14:03:43 +0000] \"GET / HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0\"\n159.223.56.86 - - [04/Feb/2023:14:17:38 +0000] \"GET / HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36\"\n20.231.80.56 - - [04/Feb/2023:14:24:53 +0000] \"GET /wp-login.php HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.100 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:09 +0000] \"GET /.env HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:10 +0000] \"POST /.env HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:10 +0000] \"GET /.aws/credentials HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:11 +0000] \"POST /.aws/credentials HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:12 +0000] \"GET /.aws/config HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:12 +0000] \"POST /.aws/config HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:13 +0000] \"GET /aws/credentials HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:14 +0000] \"POST /aws/credentials HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:14 +0000] \"GET /credentials HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:15 +0000] \"POST /credentials HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:16 +0000] \"GET /test.php HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:16 +0000] \"POST /test.php HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:17 +0000] \"GET /laravel/.env HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:17 +0000] \"POST /laravel/.env HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:18 +0000] \"GET /demo/.env HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:19 +0000] \"POST /demo/.env HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:19 +0000] \"GET /web/.env HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:20 +0000] \"POST /web/.env HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:21 +0000] \"GET /phpinfo HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n109.237.98.53 - - [04/Feb/2023:14:41:21 +0000] \"POST /phpinfo HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36\"\n178.62.72.53 - - [04/Feb/2023:20:28:52 +0000] \"GET / HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36\"\n159.223.56.86 - - [04/Feb/2023:23:44:00 +0000] \"GET / HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36\"\n165.227.89.199 - - [05/Feb/2023:00:23:58 +0000] \"GET / HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36\"\n159.223.56.86 - - [05/Feb/2023:01:15:39 +0000] \"GET / HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36\"\n5.62.58.235 - - [05/Feb/2023:02:16:29 +0000] \"GET / HTTP/1.1\" 301 178 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36\"\n205.210.31.157 - - [05/Feb/2023:04:08:24 +0000] \"GET / HTTP/1.1\" 301 178 \"-\" \"Xpanse, a Palo Alto Networks company, indexes customer network perimeters. If you have any questions or concerns, please reach out to: scaninfo@paloaltonetworks.com.\"</code></pre></div>\n<br>\n<p>이건 내 Nginx 접근 기록에서 따온 로그 중 일부다.<br>\n저기 <strong>109.237.98.53</strong>IP 접근을 보라.</p>\n<p>파이썬이나 기타 언어로 봇 만들어서 취약점을 열심히 찾는...<br>\n참 부지런하다...</p>\n<p>난 게을러서 저런 노력도 못할 듯 싶다 -_-;;<br>\n무튼 서비스가 오픈되면 어떻게들 귀신같이 알고 저렇게 온다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3e4311ec4e2b3062af0e05a248a4cac2/d8d7f/img01.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.06748466257669%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAVABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQCA//EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAGXN0pcFZtSg0CP/8QAHBAAAQQDAQAAAAAAAAAAAAAAAAECAxESEyEy/9oACAEBAAEFAtEosEhoeZrbHrmqldZ7o//EABYRAQEBAAAAAAAAAAAAAAAAABEAEP/aAAgBAwEBPwEjf//EABYRAQEBAAAAAAAAAAAAAAAAABEAEP/aAAgBAgEBPwFnf//EABoQAAEFAQAAAAAAAAAAAAAAAAABEBFBkeH/2gAIAQEABj8C6VpTQrS1Yf/EABwQAQEAAgIDAAAAAAAAAAAAAAEAETEhUUFh8P/aAAgBAQABPyHuSdqPo2hmQtftsLq4LyxHKJax/9oADAMBAAIAAwAAABAcyD7/xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQMBAT8QZT//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREQ/9oACAECAQE/EFZW/wD/xAAeEAEAAgICAwEAAAAAAAAAAAABABEhMUFRYcHh8P/aAAgBAQABPxAvMPn8I6y4OG3qIs9i21KjhZKdHRWoVKtcRAO1Jo6s4SXBU+fqf//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img01\"\n        title=\"\"\n        src=\"/static/3e4311ec4e2b3062af0e05a248a4cac2/6aca1/img01.jpg\"\n        srcset=\"/static/3e4311ec4e2b3062af0e05a248a4cac2/d2f63/img01.jpg 163w,\n/static/3e4311ec4e2b3062af0e05a248a4cac2/c989d/img01.jpg 325w,\n/static/3e4311ec4e2b3062af0e05a248a4cac2/6aca1/img01.jpg 650w,\n/static/3e4311ec4e2b3062af0e05a248a4cac2/7c09c/img01.jpg 975w,\n/static/3e4311ec4e2b3062af0e05a248a4cac2/d8d7f/img01.jpg 1032w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<br>\n<p>무튼 예전부터 나는 이걸 보호할 방법을 찾았고 적용했었다.<br>\n그리고 포스팅 해야지 하다가..(아마 흑우집합소 1세대쯤이었...)</p>\n<p>그래서 이걸 이제야 포스팅 해본다.</p>\n<h2 id=\"how-to\" style=\"position:relative;\"><a href=\"#how-to\" aria-label=\"how to permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How To?</h2>\n<p>일단 nginx가 설치되어 있다는 것을 가정한다.<br>\nnginx의 기본 설정 파일을 vim이던 원하는 편집기로 연다.</p>\n<p>보통은 경로가 <strong>/etc/nginx/nginx.conf</strong> 일거다.<br>\n물론 보안을 생각하면 다른 장소로 옮겨둔 사람도 있겠지만...</p>\n<p>이 conf파일에 작성해도 좋지만 나 같은 경우 따로 빼뒀다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">http {\n    ## Some Config\n\n    ## 별도 경로로 빼둔 설정파일들\n\tinclude /home/mymy/nginx/ip-block-list.conf;  #ip block\n  \tinclude /home/mymy/nginx/hack_word.conf; #Hack word\n  \tinclude /home/mymy/nginx/ip-range-block-list.conf; #ip range block\n}</code></pre></div>\n<p>저 설정파일들은 nginx에서 사용할 변수를 만들어 둔 파일들이다.<br>\n그리고 저 설정파일들은 아래서 더 자세하게 설명하겠다.</p>\n<br>\n<h3 id=\"개별-ip-막기\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EB%B3%84-ip-%EB%A7%89%EA%B8%B0\" aria-label=\"개별 ip 막기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개별 IP 막기</h3>\n<p>위의 <strong>ip-block-list.conf</strong> 파일에는 다음과 같이 되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">geo $bad_ip {\n    5.62.41.163 1;\n    5.62.58.235 1;\n    default 0;\n}</code></pre></div>\n<p>상단에 geo를 적고 **$**표시가 변수 이름이다.<br>\n그리고 안에 값은 밴 시킬 ip는 1을 주고, 그 외는 허용하려 하기에 0을 줬다.</p>\n<p>여기까지 하고 되면 참 좋겠지만...<br>\n이제 몇 가지 설정이 남았다.</p>\n<p>다시 nginx.conf 파일을 열거나 자신의 서비스에 맞는 설정을 빼뒀으면 그 config를 열어준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server {\n  #기본 설정\n  listen 80;\n  listen [::]:80;\n  root /var/www/html;\n\n  server_name bcow.world;\n\n  #Ban black ip\n  if ($bad_ip) { return 444; }\n\n  #Ban ip range\n  if ($bad_ip_range) { return 444;  }\n\n  #특정 url 패턴을 거부\n  if ($bad_word = 1) { return 444; }\n\n  underscores_in_headers    on;  #1. 언더형식의 헤더를 허용 합니다.\n\n  #실제 사용 처리\n  location / {\n    proxy_set_header Range $saferange;\n\n    proxy_pass http://localhost:11122334;\n    proxy_pass_request_headers\ton; ## 요청 헤더 바로 전달\n  }\n}</code></pre></div>\n<p>설정을 저렇게 해주면 된다.<br>\n<strong>if ($bad_ip) { return 444; }</strong> 이 설정으로 인해,<br>\n해당 IP는 444응답... 즉 아무 응답도 못받고 죽은 서버라는 응답을 받게 된다.</p>\n<p>만약 특정 Ip 영역대를 밴 시키고 싶다면?</p>\n<br>\n<h3 id=\"ip-class로-막기\" style=\"position:relative;\"><a href=\"#ip-class%EB%A1%9C-%EB%A7%89%EA%B8%B0\" aria-label=\"ip class로 막기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IP Class로 막기</h3>\n<p>IP는 알다시피 A클래스, B클래스, C클래스 영역으로 나눠져있다.<br>\n그리고 서브넷 등등...</p>\n<p>자세한 건 네트워크 쪽 찾아보거나 시스코의 CCNA 자격증 공부하면 줄기차게 나온다.<br>\n무튼...</p>\n<p>이번엔 위에서 설명된 <strong>ip-range-block-list.conf</strong> 설정을 열람해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">geo $bad_ip_range {\n\t# A\n\t103.0.0.0/8 1; #VN-21-11-29\n  \t185.0.0.0/8 1; #DE-21-12-27\n\n    # B\n  \t5.161.0.0/16 1; #22-01-02\n  \t45.83.0.0/16 1; #log4j\n\n    # C\n  \t77.111.247.0/24 1; #NO-21-12-16\n  \t167.172.62.0/24 1; #22-01-02\n\n    default 0;\n}</code></pre></div>\n<p>얘도 아까 단일 Ip랑 같은 설정을 가진다.<br>\n단지 A클래스일 경우 앞 대역 주소를 적고 나머진 0.0.0 즉 해당 네트워크 주소(시작 주소)를 적어둔다.</p>\n<p>그리고 뒤에 서브넷을 입력한다.<br>\nA클래스니까 당연 서브넷은 8이다.</p>\n<p>B랑 C는 A랑 같기에 설명은 생략한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 199px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0d97179dbf34cf3d16f524aa7fce4407/4fd5b/img04.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126.99386503067484%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAZABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAQFAwb/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAFa6hQNREJ1XnaQmNB//8QAHhAAAwACAQUAAAAAAAAAAAAAAQIDABIEEyIxMjT/2gAIAQEAAQUCdjbJDWC7YEIsGdlej7pXvk/TlVy1X88n5pen/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAHxAAAgIBBAMAAAAAAAAAAAAAAQIAESEDEjFBEGFx/9oACAEBAAY/AmWiX3YihR1Mx65gKge4a1FWujG38tCXOBGIWNNP74//xAAdEAADAAICAwAAAAAAAAAAAAAAAREhMUFREGHw/9oACAEBAAE/IavYOOuh84mS5pieWy6MWnRKldmyNRNAu7BhjS54L3tN7a8T5fRpP//aAAwDAQACAAMAAAAQ0wsM/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAIhABAAICAQIHAAAAAAAAAAAAAQARITFRQaEQYXGBkbHB/9oACAEBAAE/EGiymDFqV6YgfWeKsGfe7iTVOgmiLgFoN27z5M5cbCqaQPnMo8BYL0X05Yrg3us6PwgdHGq23o5bZYVeKVwTuH7nePAf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img04\"\n        title=\"\"\n        src=\"/static/0d97179dbf34cf3d16f524aa7fce4407/4fd5b/img04.jpg\"\n        srcset=\"/static/0d97179dbf34cf3d16f524aa7fce4407/d2f63/img04.jpg 163w,\n/static/0d97179dbf34cf3d16f524aa7fce4407/4fd5b/img04.jpg 199w\"\n        sizes=\"(max-width: 199px) 100vw, 199px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>무튼 이것도 변수를 선언하고 메인 설정에서 단일 Ip 밴시키듯 아래 설정을 두면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#Ban ip range\n  if ($bad_ip_range) { return 444;  }</code></pre></div>\n<p>근데 이 블록 Ip는 잘보고 막자.<br>\n가끔 B클래스가 같은거 같아서 막 막다보면 엄한 영역도 막을 수 있다.</p>\n<p>그래서 ip조회 서비스 등을 조회해서 대상 B클래스 주소가 같은 지역 같은 호스트,<br>\n비슷한 것 같으면 그 때 막는게 좋다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dc9ea991615ab825e918c5032c2d0094/1132d/img03.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.34969325153374%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABzUlEQVR42nVTWY6dQAzk/kfIR+4T5QIjRZM3egs8dnqhadaash+MUEb5KDXdwuVy2U6mecaBcZrg+17PdV3/wabAtsHFBT9/b/jxa0PpFr4zdudIhhiVQDAJ+DgvyzfEMX4hMOYtDXjLBhgfMMrbEIgBiXUej7KCrSu4osDInxcqOmNeZvS9J5yiMw16V2MeLazt9jeeoUciJf653nH5uMGkKQbvsbCsM6Go9t4pqXUGZV2iI5EnkdzlbFomCeFF+H57ICNZ6DrM8/RNoRCG4BFOBGVFUtOyzF7vxhq1Qwn/3lPURYmRGcSv/xGKQkelAuM6VE2lKGlXmj/Vx8T6Hk96GJqXf5N4KKQHDg9F4U4qasQzIRZ1bdegKAudEFV4eTzR5PSPJYxxVJKVPq67l4dC762i5X/W8Vs85V2SDCxdup04EmZFhfp6hckybYyvKvRdC9/U2qRp77Lb/ROFrwbZvTFWvR0ix8Yx4JblaNI7uvQBm+cYnENkIiGb97l8qaN/DDbssJTcEkIupcv9i/DyyNB4dnjl1HMZjnLPJVtV5ZRY1AiREJvT+CihbMqqxp82Y1+jQ93EUZLEAzchMkjGQ4J1OzgZ+h2DbtsnE9+fcH+YE4UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img03\"\n        title=\"\"\n        src=\"/static/dc9ea991615ab825e918c5032c2d0094/a6d36/img03.png\"\n        srcset=\"/static/dc9ea991615ab825e918c5032c2d0094/222b7/img03.png 163w,\n/static/dc9ea991615ab825e918c5032c2d0094/ff46a/img03.png 325w,\n/static/dc9ea991615ab825e918c5032c2d0094/a6d36/img03.png 650w,\n/static/dc9ea991615ab825e918c5032c2d0094/e548f/img03.png 975w,\n/static/dc9ea991615ab825e918c5032c2d0094/1132d/img03.png 1158w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>이건 <a href=\"https://ip-api.com/\">IP-API</a>사이트에서 조회한 것인데 저렇게 밑에 hosting이라 되어 있으면 일단 막는게 좋다.<br>\n그리고 사진에 나온 것처럼 미국인데 asname이 텐센트...</p>\n<p>물론 클라우드를 통해 접근해서 지역은 상관 없긴 하지만...<br>\n일단 중국은 다 막자.</p>\n<p>다음은 url에 특정 키워드가 포함된 것을 잡는 것을 알아보자.</p>\n<br>\n<h3 id=\"url-keyword\" style=\"position:relative;\"><a href=\"#url-keyword\" aria-label=\"url keyword permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Url keyword</h3>\n<p>이것도 원리는 같다.<br>\n<strong>hack_word.conf</strong> 설정 파일을 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#Request Bad Word\nmap $request_uri $bad_word {\n\tdefault 0;\n\t~*(wp-includes|wlwmanifest|xmlrpc|wordpress|administrator|wp-admin|wp-login|owa|a2billing) 1;\n\t~*(fgt_lang|flu|stalker_portal|streaming|system_api|exporttool|ecp|vendor|LogService|invoke|phpinfo) 1;\n\t~*(Autodiscover|console|eval-stdin|staging|magento|demo|rss|root|mifs|git|graphql|sidekiq|c99|GponForm) 1;\n\t~*(header-rollup-554|fckeditor|ajax|misc|plugins|execute-solution|wp-content|php|telescope) 1;\n\t~*(idx_config|DS_Store|nginx|wp-json|ads|humans|exec|level|monitoring|configprops|balancer|actuator) 1;\n\t~*(meta-data|web_shell_cmd|latest|remote|_asterisk|bash|Bind|binding|appxz|bankCheck|GetAllGameCategory) 1;\n\t~*(exchangerateuserconfig|exchange_article|kline_week|anquan|dns-query|nsepa_setup|java_script|gemini-iptv) 1;\n\t~*(j_spring_security_check|wps|cgi|asmx|HNAP1|sdk|evox) 1;\n\t~*(_ignition|alvzpxkr|ALFA_DATA|wp-plain) 1;\n\t~*(ldap|jndi|dns|securityscan|rmi|ldaps|iiop|corba|nds|nis) 1; # log4j\n}</code></pre></div>\n<p>일단 내가 주로 막는 유형만 가져왔다.<br>\n저렇게 하면 url에 저 키워드가 들어가면 조건에 걸린다.</p>\n<p>내가 집요하게 로그를 분석하며 취약점 찾으려 들어온 놈들 키워드를 분석했다.<br>\n이것도 메인 설정에 박아두면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">if ($bad_word = 1) { return 444; }</code></pre></div>\n<p>이렇게 하면 어느정도 취약점 찾는 놈들은 막을 수 있을 것이다.</p>\n<h2 id=\"기타\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%ED%83%80\" aria-label=\"기타 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기타</h2>\n<p>또 막는 설정은 다양한게 있겠지만...</p>\n<p>요새는 영악해서 가짜 UA 달고 오는게 예의지만...<br>\nUserAgent 공백으로 오는 무성의한 놈들도 있다. (아주 가끔...)</p>\n<p>이런 놈들은 아래 설정으로 막을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#공백 UserAgent 차단\nif (\\$http_user_agent = \"\") { return 444; }</code></pre></div>\n<p>그리고 악의적인 행위로 유명한 봇들도 있다.<br>\n이건 아래 내용을 참고하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#Bot\nmap $http_user_agent $limit_bots {\n        default 0;\n        ~*(MJ12bot|ltx71|Adsbot/3.1/WordPress|BLEXBot|UCBrowser|Mb2345Browser) 1;\n        ~*(MicroMessenger|LieBaoFast|Headless|netEstate|PetalBot) 1;\n        ~*(bingbot|FeedDemon|GrapeshotCrawler|DuckDuckBot|MegaIndex) 1;\n        ~*(VelenPublicWebCrawler|SimplePie|YandexBot|SCMGUARD|DotBot) 1;\n        ~*(AhrefsBot|SemrushBot) 1;\n\t~*(wget|curl) 1;\n    }</code></pre></div>\n<p>이걸 또 메인 설정(또는 개인 서비스 설정)에 아래와 같이 넣어준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#불필요 로봇 차단\nif (\\$limit_bots = 1) { return 444; }</code></pre></div>\n<p>이렇게하면 일단 가드를 완전히 올린 셋팅은 아니지만 어중이 떠중이는 못들어오게 막아준다.</p>\n<br>\n<p>nginx 책도 빌렸는데 공부를 좀 해서 더 견고하게 막아보도록 노오력해봐야겠다.<br>\n아래는 범위 ip 설정을 올려본다.</p>\n<p>단일은 진짜 넘 커서...<br>\n이건 깃허브나 파일로 제공해야 할 듯 싶다.</p>\n<p>해외 서비스 하는 분은 잘 알아보고 적용하고,<br>\n국내나 국외 크게 신경 안쓰시는 분은 아래 내용을 참고하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">geo $bad_ip_range {\n\t# A\n    #34.0.0.0/8 1; #22-07-01 => Google Bot 있을 수 있음\n\t103.0.0.0/8 1; #VN-21-11-29\n  \t185.0.0.0/8 1; #DE-21-12-27\n\t159.0.0.0/8 1; #22-04-17\n\t20.0.0.0/8 1; #22-04-30\n\t15.0.0.0/8 1; #22-06-10\n\t51.0.0.0/8 1; #22-06-27\n\t35.0.0.0/8 1; #22-07-01\n\n  \t# B\n    # 66.249.0.0/16 1; #US_21-11-15 => Google Bot 있을 수 있음\n  \t5.161.0.0/16 1; #22-01-02\n  \t45.83.0.0/16 1; #log4j\n  \t51.159.0.0/16 1; #FR-21-11-17\n  \t137.184.0.0/16 1; #22-01-02\n  \t167.71.0.0/16 1; #US(NE)-21-11-25\n  \t185.220.0.0/16 1; #log4j\n\t20.119.0.0/16 1; #22-02-02\n\t92.223.0.0/16 1; #22-04-05\n\t46.101.0.0/16 1; #22-06-09\n\t163.172.0.0/16 1; #22-06-10\n\t198.235.0.0/16 1; #22-06-28\n\t5.62.0.0/16 1;\n\t178.62.0.0/16 1;\n\t146.70.0.0/16 1;\n\t14.116.0.0/16 1;\n\t144.168.0.0/16 1;\n\t144.126.0.0/16 1;\n\t143.198.0.0/16 1;\n\t128.199.0.0/16 1;\n\t18.118.0.0/16 1;\n\t18.234.0.0/16 1;\n\t159.65.0.0/16 1;\n\t159.65.0.0/16 1;\n\t34.240.0.0/16 1;\n\t157.245.0.0/16 1;\n\t170.247.0.0/16 1;\n\t159.223.0.0/16 1;\n\t165.232.0.0/16 1;\n\t168.119.0.0/16 1;\n\t188.166.0.0/16 1;\n\t198.244.0.0/16 1;\n\t35.86.0.0/16 1;\n\t35.89.0.0/16 1;\n\t106.75.0.0/16 1;\n\t205.185.0.0/16 1;\n\t209.141.0.0/16 1;\n\t209.127.0.0/16 1;\n\t43.130.0.0/16 1;\n\t35.93.0.0/16 1;\n\n  \t# C\n  \t77.111.247.0/24 1; #NO-21-12-16\n  \t167.172.62.0/24 1; #22-01-02\n  \t171.25.193.0/24 1; #log4j\n\t92.118.160.0/24 1; #22-04-10\n\t220.181.51.0/24 1; #22-04-12\n\t95.142.120.0/24 1; #22-04-25\n\t5.188.62.0/24 1; #22-05-10\n\t116.179.33.0/24 1; #22-06-10\n\n\t92.223.85.0/24 1;\n\t93.158.91.0/24 1;\n\t93.158.90.0/24 1;\n\t36.99.136.0/24 1;\n\t111.7.100.0/24 1;\n\t117.187.173.0/24 1;\n\t156.146.35.0/24 1;\n\t185.54.229.0/24 1;\n\t185.27.99.0/24 1;\n\t185.181.60.0/24 1;\n\t198.235.24.0/24 1;\n\t205.169.39.0/24 1;\n\t205.210.31.0/24 1;\n\t208.80.194.0/24 1;\n\t111.7.100.0/24 1;\n\t205.210.31.0/24 1;\n\t51.222.253.0/24 1;\n\t89.187.163.0/24 1;\n\t95.142.120.0/24 1;\n\t42.83.147.0/24 1;\n\t54.36.148.0/24 1;\n\t64.43.117.0/24 1;\n\t191.102.179.0/24 1;\n\t199.244.88.0/24 1;\n\n  \tdefault 0;\n}</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"toc\"><pre class=\"language-toc\"><code class=\"language-toc\"></code></pre></div>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-%EC%97%B4%EC%96%B4%EB%91%90%EB%A9%B4\">서비스를 열어두면...</a></p>\n<ul>\n<li>\n<p><a href=\"#how-to\">How To?</a></p>\n<ul>\n<li><a href=\"#%EA%B0%9C%EB%B3%84-ip-%EB%A7%89%EA%B8%B0\">개별 IP 막기</a></li>\n<li><a href=\"#ip-class%EB%A1%9C-%EB%A7%89%EA%B8%B0\">IP Class로 막기</a></li>\n<li><a href=\"#url-keyword\">Url keyword</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B8%B0%ED%83%80\">기타</a></p>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"Nginx에서 특정 IP 접근 금지 시키기 (With Url 문자열 접근 막기)","description":null,"date":"April 01, 2023","tags":["Nginx"],"series":"Nginx","previewImage":"nginx_logo.webp","isPrivate":null,"writer":null}},"previous":{"fields":{"slug":"/nest_js/230401_ipv6_ipv4/"},"frontmatter":{"title":"Nest.js에서 Ip 조회할 때 IpV6로 표시되는 것을 IpV4로 바꾸기","isPrivate":null}},"next":{"fields":{"slug":"/next-js/230404_nextjs_in_adsense/"},"frontmatter":{"title":"Next.Js에 구글 애드센스(Adsense) 등록하기","isPrivate":null}}},"pageContext":{"id":"ef070f61-9a5a-5145-9709-bbbdc1327037","previousPostId":"4faf903c-517b-5f9a-9798-68f088e76684","nextPostId":"44017749-1055-55df-8d0d-5c8bd98bbc06"}},"staticQueryHashes":[],"slicesMap":{}}