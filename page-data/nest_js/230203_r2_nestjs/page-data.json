{"componentChunkName":"component---src-templates-post-jsx","path":"/nest_js/230203_r2_nestjs/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab"}},"markdownRemark":{"id":"fd684f04-ca6c-5697-8f1f-77c62976d76e","excerpt":"저번 포스팅에 이어... 저번 포스팅(CloudFlare R2 사용해보기 Part 1)에 이어 이번에는 R2에 파일 업로드와 다운로드, 삭제 등을 Nest.Js…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7685b7a900370c34be4e657df3f862d/8c557/thumbnail_nestjs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.14723926380368%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeUlEQVR42p2Su0oDQRSG8xR2WlmID2ATCy3UJ7CxsbUQFGwECyGi2NgYVMRCJFHxgmhQQTCNhZgURkQISDBGA+ayxuwme8nuzPzOTrLLkiAaDyz7D+fwzX/OGR+coBQwLYAQ/nHN8K/wuTDWINhQy2oPyJgH2DiQ7Adq0VtooRMoM4t1pz8CfnGo7UVQ6BlCrqMP+a5+fI6MQz+8cMdAMllxoT0KplRAiyUw0wSVFTBVg3mXAOPaBaobYchTAQHKdw9CGhhDsXcYJP0OWpBQWViFun0Eff8M6uYutIMI9NMrVJbWYMYSUGaXQaWSZ4Z2F0YNJPUKyT8qoPlOP8z7J7AvGep6CLWbGKorWxweBHlOw4w/CG1Ernk+DFp2HNob5WGcR1GemIM8HRBty5Pz/BIDrKrBSqZAXt5Ac0VYHGY9JgXASqXBdIPnMmBlucmhposW9eNLVIM7vEBp2eDfn413gfaTaQbZmrL639WeGifXAnQLaNvOHIffj+jrKwtXR3EAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"thumbnail\"\n        title=\"\"\n        src=\"/static/b7685b7a900370c34be4e657df3f862d/a6d36/thumbnail_nestjs.png\"\n        srcset=\"/static/b7685b7a900370c34be4e657df3f862d/222b7/thumbnail_nestjs.png 163w,\n/static/b7685b7a900370c34be4e657df3f862d/ff46a/thumbnail_nestjs.png 325w,\n/static/b7685b7a900370c34be4e657df3f862d/a6d36/thumbnail_nestjs.png 650w,\n/static/b7685b7a900370c34be4e657df3f862d/8c557/thumbnail_nestjs.png 700w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"저번-포스팅에-이어\" style=\"position:relative;\"><a href=\"#%EC%A0%80%EB%B2%88-%ED%8F%AC%EC%8A%A4%ED%8C%85%EC%97%90-%EC%9D%B4%EC%96%B4\" aria-label=\"저번 포스팅에 이어 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>저번 포스팅에 이어...</h1>\n<p>저번 포스팅(<a href=\"https://elfinlas.github.io/cloud-flare/230127_use_r2/\">CloudFlare R2 사용해보기 Part 1</a>)에 이어 이번에는 R2에 파일 업로드와 다운로드, 삭제 등을 <strong>Nest.Js</strong>로 구현하는 것을 해보려 한다.<br>\n일단 프로젝트를 따로 파서 깃허브에 올려서 하려 했으나...</p>\n<p>생각해보니 각 설정들 부터 해서 <strong>Wrangler</strong>의 설정 및 배포 등 생각할 것과 직접 구현해야 할 부분이 많아지는 관계로...<br>\n일단 코드 조각으로 예시를 만들어보려 한다.</p>\n<p>그렇다고 생략을 엄청 하는 것은 아니고, 환경이 구성되어 있다면 해당 코드 예제가 도움될 것이라 생각이 든다.</p>\n<p>설명에 앞서 구성, 그리고 기타 사항은 다음과 같이 되어 있다.</p>\n<ul>\n<li>Nest.JS 사용</li>\n<li>Typescript 사용</li>\n<li><a href=\"https://elfinlas.github.io/cloud-flare/230127_use_r2/\">CloudFlare R2 사용해보기 Part 1</a> 포스팅까지 진행 완료된 CloudFlare 계정</li>\n<li><strong>Wrangler</strong> 프로젝트가 현재 진행하는(또는 따로 만든) 곳 내부에 존재하는 것을 예시로 진행</li>\n<li>먼저 <strong>files</strong>라는 도메인에서 진행한다. (아래 사진은 참고용)</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 261px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/63f833163615a6da2efd925b95c803eb/edf96/img01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 133.74233128834356%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAADKklEQVR42p1VSW/bZhTkHyjQS1s0SGtJNEVR4k5K4k5RC7XESmQ7Tds46CG5FUWBXvr3p/M+1UDaGJbsw2ihPo7mvZn3qOkDF5eGC3+dINilGOUpugMbP3RMdC6H6Bqjk5BzfS+APnCg9UyHF4cwHR95u4U3zRCMC4STEsbQx4VuqRtOods/kmvGMIDAsmOUyz2m+RJls0O9vIIbZfxXD5eWfxr/ntNGfgI3LuCEGWabA3a3H9DubvD69g6Hn35DnM4x8lP+np+EHWTQjuwuzJEPN5lj2lxR5RzFbIOhO0avb0M33TPhSQ9d1cOO4SBLx2jXDeJsgbRcov+EHt4bqAmrThUX/QBXMxuf3qaI8zVCGvOSTvf6Ypp9FuSsJi+dSwtdIipaJPM9bG+CotkqlT/2BkrlORCVmjTcHVfwiYamrN/8gu3+HRabGxqygBMVZ8OmMZoT5YjoZERD6vaAzeE9fr77hA1J3bhCOG0UgunsJPxJTZcHxx4afB/YITbXv1JtoVwepw0npq9KEbdPgkOiid09uiPRsZwIzfaAaFqp6KTViqQzeFF61hgK6ReE7et3HL0Sk6xBVrWK0AmS5xKGWO1v4ce5IhOFuslF0e2rw08mHNgR5vv38ISwbqlyjqSQgAfPVGgHuHlTsuSMCtckW6jSddN5DqEHa+Tgr48eySQCpSIMadCFPnxayfLFkAVBU77Z/gmXecrrlerly46hpkAm5nM8pPiLkmV7d5INQ1ozh2vEScXIHBeuwA1T+BwEuSbn/0/6X0L2SS68mOyosGLZKxLWSGmKGCRBT8sVklLaUKpNdJqQn7+6/htOskDGGyMSiikS8pyKZXKO5ZtnlCwLkheuDRNjTkZCNTIx94Rjvg/Y43uiMwgdtc+CZMsHVEVTWm6bGaZ0OuEak0zKBjcsj9s9UNDVA+5EyV+/+oMls8RqqUou51tFJiVnVF1yT9bLV6qnI+5NacEjhA6+W32EpwiPiyGv14pYbriPiyzkIx6NzZHw293vsMIC02ymQh1OCro9U2osJ3404A8q/L65g6Niw77RDOlfxbJlUYhBD+Xvc8J/APqkQNMsrNQkAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img01\"\n        title=\"\"\n        src=\"/static/63f833163615a6da2efd925b95c803eb/edf96/img01.png\"\n        srcset=\"/static/63f833163615a6da2efd925b95c803eb/222b7/img01.png 163w,\n/static/63f833163615a6da2efd925b95c803eb/edf96/img01.png 261w\"\n        sizes=\"(max-width: 261px) 100vw, 261px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li><strong>레이어드 아키텍처</strong> 기반으로 코드가 구성되어 있다. (원래 <strong>포트 앤 어뎁터</strong>로 하려 했는데 아직 배우는 단계라...)</li>\n</ul>\n<br>\n<h2 id=\"1-worker-처리기-배포\" style=\"position:relative;\"><a href=\"#1-worker-%EC%B2%98%EB%A6%AC%EA%B8%B0-%EB%B0%B0%ED%8F%AC\" aria-label=\"1 worker 처리기 배포 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Worker 처리기 배포</h2>\n<p><a href=\"https://elfinlas.github.io/cloud-flare/230127_use_r2/\">CloudFlare R2 사용해보기 Part 1</a> 까지 한 뒤에 작성했던 <strong>index.ts</strong>에 대해서 CloudFlare에 배포를 해줘야 한다.<br>\n이 부분은 자주 쓸 수 있기에 <strong>package.json</strong>의 <strong>scripts</strong>에 등록을 해두고 쓰자.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"scripts\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        ...\n        <span class=\"token property\">\"r2:build:dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wrangler publish -c ./my_worker/wrangler.toml\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 <strong>my_worker</strong>의 경우 서비스 생성할 때 이름을 적어주면 된다.<br>\n각자 프로젝트 디렉토리에 보면 자신이 정한 디렉토리명이 있는데 이를 넣어주면 된다.<br>\n그리고 실행 명령어도 입맛에 바꿔도 된다.</p>\n<p>이렇게 하고 아래 명령어처럼 배포를 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">> yarn r2:build:dev</code></pre></div>\n<br>\n<p>그럼 콘솔에 배포가 잘 되고, CloudFlare 사이트의 Workers에서 등록한 서비스를 들어가서 배포 항목을 보면 확인이 가능하다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f6641b9ce995167297d289d8977bffc1/12bff/img02.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.65030674846626%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJUlEQVR42nWRS07EMBBEjRAIuBcHYDNiz4IDjLgP65yG5eyQkBARRPmNf4mdNFXGkxlQaKnUsst5LnfUMAxChRBEu0G6z3fxdi8hRvmn5hUtpbquE2useO9lr6300F4bsdakPefcIl4ccdE8HxkMQk9rnaTKj1LK+ks6pyWMIw6MYoyRuq4TkBD0iR+jv+52u01Zlndt226qqrrF2Wd6TdNE7InyzosZrbjoj29Cgr7vE4w1obL1Al0qFPpF7lsaOBuYXpHK2AcQRQM3poQsrKcMJvAaOoOuCIT3RM9aGxggzTDEsMAOQF70F5gT3hRFcU5wTpiAmCMmNooCeRn0KZAD5oG8Pk3468nwtnm+P0D+gDXg2gzR3uA9Qg+532OvyDOMBH4DItJI3Btep3EAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img02\"\n        title=\"\"\n        src=\"/static/f6641b9ce995167297d289d8977bffc1/a6d36/img02.png\"\n        srcset=\"/static/f6641b9ce995167297d289d8977bffc1/222b7/img02.png 163w,\n/static/f6641b9ce995167297d289d8977bffc1/ff46a/img02.png 325w,\n/static/f6641b9ce995167297d289d8977bffc1/a6d36/img02.png 650w,\n/static/f6641b9ce995167297d289d8977bffc1/e548f/img02.png 975w,\n/static/f6641b9ce995167297d289d8977bffc1/12bff/img02.png 1032w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<br>\n<h2 id=\"2-프로젝트-구성\" style=\"position:relative;\"><a href=\"#2-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EA%B5%AC%EC%84%B1\" aria-label=\"2 프로젝트 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 프로젝트 구성</h2>\n<p>먼저 <strong>Nest.JS</strong>환경이 구성되어 있어야 한다.(아마 진행자라면 다들 구성되어 있을 것이다.)<br>\n위에서 설명한 것과 같이 <strong>레이어드 아키텍쳐</strong> 기반으로 구성하고 설명한다.<br>\n각 구성은 다음과 같다.</p>\n<ul>\n<li>FileController : URL로 직접 접근하는 부분</li>\n<li>FileR2Service : R2 관련 로직을 핸들링하는 서비스 로직</li>\n<li>multerR2Options : Multer 처리 옵션 로직</li>\n</ul>\n<p>기타 설치해야 할 패키지는 아래와 같다.(같은 역할을 하는 다른 패키지를 써도 무방하다)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">yarn add @types/multer --dev\nyarn add @nestjs/axios\nyarn add axios\nyarn add rxjs</code></pre></div>\n<p>각 구성 영역에 대해 설명한다.</p>\n<br>\n<h3 id=\"2-1-filecontroller\" style=\"position:relative;\"><a href=\"#2-1-filecontroller\" aria-label=\"2 1 filecontroller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-1 FileController</h3>\n<p>컨트롤러 영역은 별거 없다.<br>\n물론 파일 업로드 및 다운로드, 삭제 등의 작업 시 권한이나 그런 로직은 제외한다.<br>\n순수하게 기능에만 집중한 예제이기에 해당 코드를 바로 사용하기 보다는 약간 로직을 추가해서 쓰는 것이 좋다.</p>\n<p>그리고 아래 예제는 내가 사용하던 코드인데 일부 코드는 공개가 불가능해서 조작하였다.<br>\n약간 억지같은 부분도 있지만 기능 구현이라는 관점만 봐주셨으면 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  Controller<span class=\"token punctuation\">,</span>\n  Delete<span class=\"token punctuation\">,</span>\n  Get<span class=\"token punctuation\">,</span>\n  Param<span class=\"token punctuation\">,</span>\n  Post<span class=\"token punctuation\">,</span>\n  Req<span class=\"token punctuation\">,</span>\n  Res<span class=\"token punctuation\">,</span>\n  UploadedFile<span class=\"token punctuation\">,</span>\n  UseInterceptors<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@nestjs/common\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> FileInterceptor <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@nestjs/platform-express\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Request<span class=\"token punctuation\">,</span> Response <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  FilesSuccessCode<span class=\"token punctuation\">,</span>\n  FilesSuccessResponse<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./files.response.success\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> multerR2Options <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./multer.options\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> FilesService <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./services/files.service\"</span>\n\n<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Controller</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"files\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FilesController</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> fileService<span class=\"token operator\">:</span> FilesService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Post</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"upload\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">UseInterceptors</span></span><span class=\"token punctuation\">(</span><span class=\"token function\">FileInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file\"</span><span class=\"token punctuation\">,</span> multerR2Options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">fileUpload</span><span class=\"token punctuation\">(</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">UploadedFile</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> file<span class=\"token operator\">:</span> Express<span class=\"token punctuation\">.</span>Multer<span class=\"token punctuation\">.</span>File<span class=\"token punctuation\">,</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Req</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> req<span class=\"token operator\">:</span> Request\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>fileService<span class=\"token punctuation\">.</span><span class=\"token function\">upload</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> FilesSuccessResponse<span class=\"token punctuation\">.</span><span class=\"token function\">returnRes</span><span class=\"token punctuation\">(</span>FilesSuccessCode<span class=\"token punctuation\">.</span><span class=\"token function\">uploadFile4R2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Get</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"get/:file_id\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">downloaFiles</span><span class=\"token punctuation\">(</span><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Res</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> response<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span> <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Param</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> param<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>fileService<span class=\"token punctuation\">.</span><span class=\"token function\">fileDownload</span><span class=\"token punctuation\">(</span>param<span class=\"token punctuation\">.</span>file_id<span class=\"token punctuation\">)</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">\"Content-disposition\"</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">attachment; filename=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>result<span class=\"token punctuation\">.</span>fileName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> result<span class=\"token punctuation\">.</span>axiosResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Delete</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delete/:file_id\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">deleteFiles</span><span class=\"token punctuation\">(</span><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Param</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> param<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>fileService<span class=\"token punctuation\">.</span><span class=\"token function\">updateDeleteStatus</span><span class=\"token punctuation\">(</span>param<span class=\"token punctuation\">.</span>file_id<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> FilesSuccessResponse<span class=\"token punctuation\">.</span><span class=\"token function\">returnRes</span><span class=\"token punctuation\">(</span>FilesSuccessCode<span class=\"token punctuation\">.</span><span class=\"token function\">deleteFile4R2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 <strong>FilesService</strong>가 있는데 이 서비스 로직은 디비에 저장 및 로깅, 기타 작업 등을 처리하는 메인 서비스 로직인데 이 부분은 아래 서비스 로직에서 다루겠다.</p>\n<br>\n<h3 id=\"2-2-fileservice--filer2service\" style=\"position:relative;\"><a href=\"#2-2-fileservice--filer2service\" aria-label=\"2 2 fileservice  filer2service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-2 FileService &#x26; FileR2Service</h3>\n<p>여기는 실제 기능을 담당하는 구현 로직이다.<br>\n<strong>FilesService</strong>의 경우 일부 로직만 구현되어 있기에 그냥 호출 흐름 정도만 공개한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">//FilesService</span>\n\n<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FilesService</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> r2Service<span class=\"token operator\">:</span> FilesR2Service<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * 파일 업로드 영역\n   * @param req\n   * @param file\n   */</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">upload</span><span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> file<span class=\"token operator\">:</span> Express<span class=\"token punctuation\">.</span>Multer<span class=\"token punctuation\">.</span>File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>Files<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//R2에 파일 업로드를 처리한다.</span>\n    <span class=\"token keyword\">const</span> fileKey<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token function\">getUuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> r2Result<span class=\"token operator\">:</span> R2UploadResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>r2Service<span class=\"token punctuation\">.</span><span class=\"token function\">uploadR2</span><span class=\"token punctuation\">(</span>\n      file<span class=\"token punctuation\">,</span>\n      fileKey\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * 파일 다운로드 영역\n   * @param id\n   * @returns\n   */</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">fileDownload</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>GetDownloadFile<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> entity <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filesRepo<span class=\"token punctuation\">.</span><span class=\"token function\">findEntityById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>r2Service<span class=\"token punctuation\">.</span><span class=\"token function\">getFileR2</span><span class=\"token punctuation\">(</span>\n      entity<span class=\"token punctuation\">.</span>r2Key<span class=\"token punctuation\">,</span>\n      entity<span class=\"token punctuation\">.</span>uploadName <span class=\"token operator\">+</span> <span class=\"token string\">\".\"</span> <span class=\"token operator\">+</span> entity<span class=\"token punctuation\">.</span>extension\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">updateDeleteStatus</span><span class=\"token punctuation\">(</span>fileId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>r2Service<span class=\"token punctuation\">.</span><span class=\"token function\">deleteFileData4R2</span><span class=\"token punctuation\">(</span>fileKey<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>내가 구성한 코드의 경우 파일 업로드 시 해당 파일명을 <strong>uuid</strong>로 바꿔서 관리했다.<br>\n그래서 실제 R2에 파일 업로드 시 <strong>aaa.png</strong> 파일명이라면 R2에는 acbv-3342 등의 UUID로 변경되어 저장된다.<br>\n이는 향후 다운로드 시 디비에 저장된 값으로 다시 바꿔서 전달하면 되는 부분인데 여기서는 자세하게 설명하지 않는다.</p>\n<p>다운로드는 컨트롤러에서 받은 유니크한 UUID 생성 키 값으로 파일 데이터를 찾아서 R2에 저장된 파일명을 가져온다.</p>\n<p>삭제의 경우 원래 파일 상태만 바꾸는데 이번 예제에서는 직접 삭제를 진행한다.</p>\n<p>다음은 실제 구현 로직인 <strong>FileR2Service</strong>이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> HttpService <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@nestjs/axios\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Injectable <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@nestjs/common\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> AxiosError<span class=\"token punctuation\">,</span> AxiosRequestConfig <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"axios\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> firstValueFrom<span class=\"token punctuation\">,</span> lastValueFrom<span class=\"token punctuation\">,</span> map <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"rxjs\"</span>\n\n<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FilesR2Service</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> http<span class=\"token operator\">:</span> HttpService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">uploadR2</span><span class=\"token punctuation\">(</span>\n    file<span class=\"token operator\">:</span> Express<span class=\"token punctuation\">.</span>Multer<span class=\"token punctuation\">.</span>File<span class=\"token punctuation\">,</span>\n    fileKey<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>R2UploadResult<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> url<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUrl4WorkerR2</span><span class=\"token punctuation\">(</span>fileKey<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> baseHeader<span class=\"token operator\">:</span> AxiosRequestConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getR2DefaultAxiosHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>mimetype<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> data<span class=\"token operator\">:</span> R2UploadResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">lastValueFrom</span><span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>http\n        <span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">,</span> baseHeader<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> data\n\n    <span class=\"token comment\">//데이터가 안올 때 처리 필요</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">getFileR2</span><span class=\"token punctuation\">(</span>r2Key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> fileName<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>GetDownloadFile<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> url<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUrl4WorkerR2</span><span class=\"token punctuation\">(</span>r2Key<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> axiosConfg<span class=\"token operator\">:</span> AxiosRequestConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getR2DefaultAxiosHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    axiosConfg<span class=\"token punctuation\">.</span>responseType <span class=\"token operator\">=</span> <span class=\"token string\">\"arraybuffer\"</span> <span class=\"token comment\">//AxiosRequestConfig 추가</span>\n    <span class=\"token keyword\">const</span> fileData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>http<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> axiosConfg<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      axiosResponse<span class=\"token operator\">:</span> <span class=\"token function\">firstValueFrom</span><span class=\"token punctuation\">(</span>fileData<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">=></span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      fileName<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * [주의] R2에서 물리적 파일 삭제 처리 함수\n   * @param fileKey R2에 저장된 파일명\n   * @returns\n   */</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">deleteFileData4R2</span><span class=\"token punctuation\">(</span>fileKey<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> url<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUrl4WorkerR2</span><span class=\"token punctuation\">(</span>fileKey<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> axiosConfg<span class=\"token operator\">:</span> AxiosRequestConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getR2DefaultAxiosHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>http<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> axiosConfg<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> callback <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">firstValueFrom</span><span class=\"token punctuation\">(</span>\n      result<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> callback<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token string\">\"success\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * R2에 업로드 Url을 생성해주는 메서드\n   * @param fileName\n   * @returns\n   */</span>\n  <span class=\"token keyword\">private</span> <span class=\"token function\">getUrl4WorkerR2</span><span class=\"token punctuation\">(</span>fileName<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//CF_R2_WORKER_URL = \"https://myworker.workers.dev/\"</span>\n    <span class=\"token keyword\">return</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">CF_R2_WORKER_URL</span> <span class=\"token operator\">+</span> fileName\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token function\">getR2DefaultAxiosHeader</span><span class=\"token punctuation\">(</span>headerOpt<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> AxiosRequestConfig <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> baseHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">\"X-Auth-My-S-Key\"</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">CF_R2_AUTH_KEY</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      headers<span class=\"token operator\">:</span>\n        headerOpt <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> baseHeader <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>baseHeader<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>headerOpt <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>자잘자잘한 로직이 많다.<br>\n코드를 보면 알겠지만 좀 지저분하고, 로직이 난잡한데 이는 비공개 코드를 지우느라 어색한 부분이 있어서 그렇다.(물론 코드 리팩토링이 아직 제대로 안됨 -_-;)</p>\n<p><strong>getUrl4WorkerR2</strong> 메서드의 경우 .env 파일에 있는 값을 가져오는데 저기서는 Worker Url이다.<br>\n자신이 설정한 URL로 설정해두자.</p>\n<p><strong>getR2DefaultAxiosHeader</strong> 메서드의 경우 Axios 요청 시 헤더 값이다.<br>\n여기서 헤더의 키 값은 <strong>wrangler.toml</strong>파일과 맞춰줘야 한다.<br>\n전 포스팅에서 만들었던 암호키를 넣으면 된다.</p>\n<p>그리고 헤더 이름도 <strong>index.ts</strong>에서 처리한 것과 같게 해줘야 한다. (너무 당연한 이야기...)<br>\n각자 구성에 맞춰서 진행해야 에러가 안난다.</p>\n<p>403뜨면 이 부분을 잘 확인해보자.</p>\n<p>그 외에 부분은 코드를 보면 이해가 될 것이다.<br>\n업로드 후 <strong>data</strong>를 로깅으로 찍어보면 아래와 같은 값이 나온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">data =  {\n  uploaded: '2023-01-31T00:59:59.713Z',\n  etag: '8b0e11242eda10911c1d203f33ab841b',\n  size: 630046,\n  version: '5307c9d4821a4ea903f7015ec19d72ef',\n  key: '7c7e5ae2-8260-499e-883c-949a0a687ada'\n}</code></pre></div>\n<p>각 설명은 아래를 참고하자</p>\n<ul>\n<li>uploaded : 업로드 날짜</li>\n<li>etag : 고유 etag 값</li>\n<li>size : 파일 사이트</li>\n<li>version : R2에서 사용하는 값</li>\n<li>key : 업로드한 파일명</li>\n</ul>\n<p>저기 로직에서 axios 통신을 보면 Workers의 HTTP 처리기 로직(index.ts)와 매칭이 된다.<br>\n이 부분을 잘 응용하면 좀 더 고도화 된 코드를 구현할 수 있는데, 귀찮으면 일단 여기 로직으로 시작해도 된다.</p>\n<br>\n<h3 id=\"2-3-multerr2options\" style=\"position:relative;\"><a href=\"#2-3-multerr2options\" aria-label=\"2 3 multerr2options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-3 multerR2Options</h3>\n<p>이건 약간 번외 파일인데...<br>\n각자 업로드에 맞춰서 사용하면 된다.</p>\n<p>아래는 그냥 내가 사용했던 샘플 코드인데...<br>\n그냥 어디선가 긁어온 코드를 그냥 사용했었다....</p>\n<p>물론 지금 내 서비스 코드는 다르게 되어 있지만...<br>\n여러분들도 입맛에 맞춰서 바꿔 사용해보시는 것을 추천한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> HttpException<span class=\"token punctuation\">,</span> HttpStatus <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@nestjs/common\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> existsSync<span class=\"token punctuation\">,</span> mkdirSync <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"fs\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> diskStorage <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"multer\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> extname <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"path\"</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> multerR2Options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">fileFilter</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>mimetype<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\/(jpg|jpeg|png|gif)$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpException</span><span class=\"token punctuation\">(</span>\n          <span class=\"token punctuation\">{</span>\n            message<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            error<span class=\"token operator\">:</span> <span class=\"token string\">\"지원하지 않는 이미지 형식입니다.\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          HttpStatus<span class=\"token punctuation\">.</span><span class=\"token constant\">BAD_REQUEST</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token boolean\">false</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  limits<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    fieldNameSize<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 필드명 사이즈 최대값 (기본값 100bytes)</span>\n    filedSize<span class=\"token operator\">:</span> <span class=\"token number\">10</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 필드 사이즈 값 설정 (기본값 1MB) 10MB</span>\n    fields<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 파일 형식이 아닌 필드의 최대 개수 (기본 값 무제한)</span>\n    fileSize<span class=\"token operator\">:</span> <span class=\"token number\">16777216</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//multipart 형식 폼에서 최대 파일 사이즈(bytes) \"16MB 설정\" (기본 값 무제한)</span>\n    files<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//multipart 형식 폼에서 파일 필드 최대 개수 (기본 값 무제한)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>좀 성급한 정리의 감이 없지않아 있지만...\n위 코드를 참고하면 구현할 수 있을 것이다.</p>\n<p>R2와 S3는 사실 각각의 장단점을 가지고 있다.<br>\nS3는 접근 제어를 할 수 있지만, R2는 내가 알기론 다 공개형태이다.</p>\n<p>URL만 있으면 접근이 가능하다는 뜻이다.<br>\n그래서 이 부분이 서비스 구현에 맞다면 R2를 쓰는것이 좋지만...</p>\n<p>보안이 좀 필요하거나 하면 S3를 쓰는게 맞는 것 같다.</p>\n<p>각자 구성환경이 좀 다르겠지만...<br>\n보통 React 또는 Next.JS를 프론트에 두고, 백엔드는 Nest.js 또는 스프링, FastApi 등을 쓰고 할 것이다.</p>\n<p>근데 나는 Next.Js + Nest.Js 에 Ngix를 통해서 작업을 했다.<br>\n근데 Next.Js에서 미들웨어에서 파일에 대한 ByteArray를 전달할 때 좀 문제가 있었다.</p>\n<p>물론 이 부분은 다 구현해서 정리해뒀다.</p>\n<p>나중에 시간날 때 저 환경에서 파일 업로드 다운로드를 하는 부분에 대해 포스팅 해볼 예정이다.</p>\n<p>예제를 최대한 친절하게 작성해뒀지만...<br>\n이해가 안되는 부분이 있다면 댓글로 남겨주시면 확인 후 답변 드릴 예정이다.</p>\n<p>나중에 시간이 좀 많이 널널해지면 그땐 깃허브에 예제를 올리고 해당 포스팅 문서도 업데이트 하도록 할 예정이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"toc\"><pre class=\"language-toc\"><code class=\"language-toc\"></code></pre></div>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EC%A0%80%EB%B2%88-%ED%8F%AC%EC%8A%A4%ED%8C%85%EC%97%90-%EC%9D%B4%EC%96%B4\">저번 포스팅에 이어...</a></p>\n<ul>\n<li>\n<p><a href=\"#1-worker-%EC%B2%98%EB%A6%AC%EA%B8%B0-%EB%B0%B0%ED%8F%AC\">1. Worker 처리기 배포</a></p>\n</li>\n<li>\n<p><a href=\"#2-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EA%B5%AC%EC%84%B1\">2. 프로젝트 구성</a></p>\n<ul>\n<li><a href=\"#2-1-filecontroller\">2-1 FileController</a></li>\n<li><a href=\"#2-2-fileservice--filer2service\">2-2 FileService &#x26; FileR2Service</a></li>\n<li><a href=\"#2-3-multerr2options\">2-3 multerR2Options</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></p>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"CloudFlare R2 사용해보기 Part 2 (With Nest.Js)","description":null,"date":"February 03, 2023","tags":["NestJs","CloudFlare","R2"],"series":"NestJs","previewImage":"nestjs_logo.jpg","isPrivate":null,"writer":null}},"previous":{"fields":{"slug":"/nest_js/230129_tast_scheduling/"},"frontmatter":{"title":"Nest.Js에서 한국시간 기준 스케쥴링할 때 주의점 (With Timezone)","isPrivate":null}},"next":{"fields":{"slug":"/utils/230203_web_carbon/"},"frontmatter":{"title":"(Web) 코드를 예쁜 이미지로 변환해주는 Carbon now","isPrivate":null}}},"pageContext":{"id":"fd684f04-ca6c-5697-8f1f-77c62976d76e","previousPostId":"7b17f725-16a5-5bf4-8162-37b01e686dd9","nextPostId":"e8c2d4e3-b425-59a4-a72e-deefb0ee2fee"}},"staticQueryHashes":[],"slicesMap":{}}