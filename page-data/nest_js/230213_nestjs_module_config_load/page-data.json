{"componentChunkName":"component---src-templates-blog-post-js","path":"/nest_js/230213_nestjs_module_config_load/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab","siteUrl":"https://elfinlas.github.io","comment":{"disqusShortName":"","utterances":"elfinlas/blog_utterances"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"id":"867f7fa0-a3d6-53cf-9f1e-68088e18d08a","excerpt":"블로그용 작은 프로젝트를 만들다가… 이번에 Nest.Js에서 Jwt쓰기 주제로 포스팅을 준비중이다. 근데 처음부터 다시 설치해서 하려니까 몇 가지 막히는 부분이 있었다. 이런 코드가 있다. 근데 @Module 안에서 process.env로 설정파일에 접근하려 했다. 근데 아래와 같이 에러가 발생했다.  이유가 뭘까 잠깐 고민했는데… 기존 프로젝트는 이미 다 되어 있는 것이라서 내가 빼 먹은 설정과 패키지가 있었다. Next.js에서 Config 이유는 간단했다. 먼저 Config…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7685b7a900370c34be4e657df3f862d/a27c6/thumbnail_nestjs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeUlEQVQoz5VSu0oDQRTNX1j5aOytxCIJiK1a2ASsLPQDBCsFizQKAQsRtbEQRBAsFFQM0WBAI9GoJI2Cj0B8ZU1CyO4m+5idOe5OsskuRowHzsyFmXvu4d7rgQlGKacTjDFOZ/wXLXjswIaRyULZC7cWtgo7Yvvd+dfDRXJ5iLMhFHwBFAbHUfAHQJ4ybscGdSXymxi1W66C6aTm0DrE+SUI3T4IXV7kOr0ojk5xWoWoJKOysQNl9wh66h7axTXU4zNoVykoB6cgjxlIi2swXj+aglSUwKoKtFgCX33DEHqHkOvoN5OT5psMMbgM9eSCFxbnQtBv0lDDMZSng1xUWlgFLZbqPTRqtrXEHSrrWyhNzEDo8SM/MAZi9pNVqlAOo9CTaWiXt1D2I1Cjce7IEiUPz1Aj5zDePuuCtNYP8pI1Bbchr2yiODIJLZ50Nb8dNIbinJSRfQcti63XhbLGpG0j9sr9WBv+iZBmNTvxH2wI/rprzO2+HXwDU8vrEbOHyiEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b7685b7a900370c34be4e657df3f862d/77434/thumbnail_nestjs.webp 300w,\n/static/b7685b7a900370c34be4e657df3f862d/411c4/thumbnail_nestjs.webp 600w,\n/static/b7685b7a900370c34be4e657df3f862d/84c6d/thumbnail_nestjs.webp 700w\"\n              sizes=\"(max-width: 700px) 100vw, 700px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b7685b7a900370c34be4e657df3f862d/a8a0d/thumbnail_nestjs.png 300w,\n/static/b7685b7a900370c34be4e657df3f862d/dface/thumbnail_nestjs.png 600w,\n/static/b7685b7a900370c34be4e657df3f862d/a27c6/thumbnail_nestjs.png 700w\"\n            sizes=\"(max-width: 700px) 100vw, 700px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b7685b7a900370c34be4e657df3f862d/a27c6/thumbnail_nestjs.png\"\n            alt=\"thumbnail\"\n            title=\"thumbnail\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1 id=\"블로그용-작은-프로젝트를-만들다가\" style=\"position:relative;\"><a href=\"#%EB%B8%94%EB%A1%9C%EA%B7%B8%EC%9A%A9-%EC%9E%91%EC%9D%80-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8%EB%A5%BC-%EB%A7%8C%EB%93%A4%EB%8B%A4%EA%B0%80\" aria-label=\"블로그용 작은 프로젝트를 만들다가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>블로그용 작은 프로젝트를 만들다가…</h1>\n<p>이번에 <strong>Nest.Js</strong>에서 <strong>Jwt</strong>쓰기 주제로 포스팅을 준비중이다.<br>\n근데 처음부터 다시 설치해서 하려니까 몇 가지 막히는 부분이 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">//auth.module.ts</span>\n<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Module</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    imports<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    JwtModule<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_KEY</span><span class=\"token punctuation\">,</span>\n      signOptions<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> expiresIn<span class=\"token operator\">:</span> <span class=\"token string\">'60s'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>이런 코드가 있다.<br>\n근데 @Module 안에서 process.env로 설정파일에 접근하려 했다.</p>\n<p>근데 아래와 같이 에러가 발생했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 952px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/24c9340c13f5d6f39177875192ad9bf3/be2fd/img01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA10lEQVQY0zWO6XKCQBCEeRrjLSAqiSzsLizHikTjReX936MzM1Z+dE3PVNc3HWhVorIetrlAu0Gm0h46s3BawxYFdF7CqLfyo4E6WsRJhnX8hcXmgMk8xsdii+kyQRDtCzTnF5r+gar7QX26o6W97p+o+X4exTu6uxNnbigpx9NQgTRziIkxW+0EGkQ7BUcBP4xw/kawp/iWHnTk+8uvPKv9XZ6x53zZXqGMx/agkaQGIXFCah0wnZsx6B/mv0d0w0vEniUwasiTYcmnIViBaJ9jGabSkPUH6aOPPMeI3FgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/24c9340c13f5d6f39177875192ad9bf3/77434/img01.webp 300w,\n/static/24c9340c13f5d6f39177875192ad9bf3/411c4/img01.webp 600w,\n/static/24c9340c13f5d6f39177875192ad9bf3/493ca/img01.webp 952w\"\n              sizes=\"(max-width: 952px) 100vw, 952px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/24c9340c13f5d6f39177875192ad9bf3/a8a0d/img01.png 300w,\n/static/24c9340c13f5d6f39177875192ad9bf3/dface/img01.png 600w,\n/static/24c9340c13f5d6f39177875192ad9bf3/be2fd/img01.png 952w\"\n            sizes=\"(max-width: 952px) 100vw, 952px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/24c9340c13f5d6f39177875192ad9bf3/be2fd/img01.png\"\n            alt=\"img01\"\n            title=\"img01\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>이유가 뭘까 잠깐 고민했는데…<br>\n기존 프로젝트는 이미 다 되어 있는 것이라서 내가 빼 먹은 설정과 패키지가 있었다.</p>\n<h2 id=\"nextjs에서-config\" style=\"position:relative;\"><a href=\"#nextjs%EC%97%90%EC%84%9C-config\" aria-label=\"nextjs에서 config permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Next.js에서 Config</h2>\n<p>이유는 간단했다.<br>\n먼저 <strong>Config</strong>관련 패키지를 빼먹었었다.</p>\n<p>먼저 아래의 명령어로 패키지를 설치해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">> yarn add @nestjs/config</code></pre></div>\n<p>그리고 모듈의 최상단인 <strong>app.module</strong>을 연다.<br>\n아래와 같이 모듈 파일을 수정해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Module <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@nestjs/common'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ConfigModule <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@nestjs/config'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> AuthModule <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./domain/auth/auth.module'</span>\n\n<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Module</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  imports<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>ConfigModule<span class=\"token punctuation\">.</span><span class=\"token function\">forRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> AuthModule<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  controllers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  providers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AppModule</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>imports</strong> 부분에서 저렇게 처리하면 된다.</p>\n<p>만약 구동 환경마다 설정파일을 좀 다르게 하고 싶다면 아래와 같이 처리가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">ConfigModule<span class=\"token punctuation\">.</span><span class=\"token function\">forRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    envFilePath<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"prod\"</span> <span class=\"token operator\">?</span> <span class=\"token string\">\".production.env\"</span> <span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"stage-dev\"</span> <span class=\"token operator\">?</span> <span class=\"token string\">\".stagedev.env\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\".dev.env\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>NODE_ENV는 실행 인자에서 전달해주는 것으로 처리했다.<br>\n이렇게 하면 각 구동 인자에 따라 설정 파일을 다르게 넣을 수 있다.</p>\n<p>그리고 아까 예제를 다시 보면…<br>\n약간 코드를 바꿔야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">//auth.module.ts</span>\n<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Module</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    imports<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    JwtModule<span class=\"token punctuation\">.</span><span class=\"token function\">registerAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function-variable function\">useFactory</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_KEY</span><span class=\"token punctuation\">,</span>\n        signOptions<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> expiresIn<span class=\"token operator\">:</span> <span class=\"token string\">'60s'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>registerAsync</strong> 이걸 써줘야 정상적으로 값을 불러올 수 있다.<br>\n저 비동기 등록을 쓰는 이유는 아직 config에서 env를 가져와서 등록하기 위함이다.</p>\n<p>만약 일반적으로 <strong>JwtModule.register</strong>를 사용하면 에러가 발생한다.<br>\n그래서 비동기 등록을 사용해야 한다.</p>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>아주 간단한 문제였는데 덕분에 하나 배웠다.<br>\n항상 기존 틀을 이용해서 그대로 진행하니 이런 부분에서 문제가 생기는 것 같다.</p>\n<p>틀에서 벗어나 본질을 이해해야 하는데 이 부분이 부족했던 것 같다…</p>\n<br>\n<p><a href=\"https://stackoverflow.com/questions/63285055/nestjs-how-to-use-env-variables-in-main-app-module-file-for-database-connecti\">참고 Stackoverflow</a><br>\n<a href=\"https://docs.nestjs.com/techniques/configuration\">공식 Next.js confing 문서</a></p>","frontmatter":{"title":"Nest.Js에서 @Module의 속성에서 process.env 사용하기","date":"February 13, 2023"}}},"pageContext":{"slug":"/nest_js/230213_nestjs_module_config_load/","previous":{"fields":{"slug":"/nest_js/230212_start_nestjs/"},"frontmatter":{"title":"Nest.Js 프로젝트 생성하기"}},"next":{"fields":{"slug":"/til/230119_til/"},"frontmatter":{"title":"23년 2월 13일 TIL & 개발노트 (흑우집합소)"}}}},"staticQueryHashes":["3128451518","903436796"]}