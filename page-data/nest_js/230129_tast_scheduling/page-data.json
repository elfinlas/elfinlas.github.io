{"componentChunkName":"component---src-templates-blog-post-js","path":"/nest_js/230129_tast_scheduling/","result":{"data":{"site":{"siteMetadata":{"title":"MHLab blog","author":"MHLab","siteUrl":"https://elfinlas.github.io","comment":{"disqusShortName":"","utterances":"elfinlas/blog_utterances"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"id":"64ee10d8-9585-53ff-9d7d-e2e76afb8ba1","excerpt":"NestJs에서 스케쥴링… 현재 하고 있는 프로젝트에서 스케쥴링이 필요하여 구현했었다. 그런데 스케쥴링을 돌렸는데 뭔가 시간이 안맞게 돌아간다고 해야 하나? 분과 초단위는 잘 도는데 시간대가 좀 안맞았다. 그래서 테스트를 하고 자료를 찾다가 원인을 알게되었다… 원인? 이유는 바로 TimeZone 문제였다. 내가 구현한 코드는 다음과 같이 구성되어 있다. 일요일에서 금요일까지 자정에서 11시까지 도는 스케쥴러다. 근데 로깅을 찍어보고 해봐도 뭔가 이상했다. 저 @Cron…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e7f1dd81de905b7face826931df4ca61/64756/thumbnail.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAADX0lEQVQozx3S3U/TdxTH8S9kLkuMGVuWJbuYmyYmZtnVCEsQDDIZG6AIAREEJg8dqVJaAWsrFAoIgn0CVooFqjTQAR0rFEspDwoqEwNSCjWIAcSMxMxkf8R7P3dxbl/n5HM+oiz+S/LST1Pb3ktttxu93Y3O6iItM5u8SwUoauqptQ5RIcvi55jD6FqNXNfmUflrNLfMNdj9izif7NA3F6JnNoQwOsYoKNfQ6PRhC6zSMb5It28Ji/shZbKfyDhxkAZNKQ1pH3H2mKAo7mP06lTK0gWXzggu53+KxelgYHH3f1Q4JF1eb6HwWiv58ipU+jbqrYO0dP2OuasT1cUjaH4QFH8fSU70ARpPCxqLYlFUxnFZJijJEBSmfELPxCOcjzcRPTNrWLzLtLVpyI8VpMZ+RmtnF0ZjK+ZbOjrdfoovxJD9jaD5bARKCcw6eRRF3U0U1V9QUyNQlQjaDBW41/59DwaxzW0z25PChkHQeiES+bkoMmM/pEd2ELvxCrdHl1CUx6FMFFyMiaJveIiBR1vcDTygyRBDi1qgLzlMe+8A4t7DEL9NbzHWl8tri6AzV1CR8QEJ0kXFMQJHjrRdncnI8gsaNfHcbtLi33zH2PMdxoN/M7q8R5+rm6tSLIXRAnEn8BzHwkvMzmHmDcdpyo6iKPkQSccFJ7+KQH0iAkuKoH/EzcTyEt6VDUafbeMNvuF+aA/v6mvGV/ZoKDyKPEEC7dOrtHseo78XwOzy0mxzoC09RcLXgu8+j+R6UiQ+lcCkV+AN/cPQQpCOkSmpZt245p7hC+7iC7+lo6UM5Xuww/sUnclGrbYa6/0lqkz9yGQFUlaRHDkUQYv0xUWd4M/JcTo8C7iehPljfgW9Vo3J7sS//obJjX1cEz6uSQ8TZvcDGns9FPySj0xxhfNFctRmB7aaLM59ewCrqYop/TFu9g5SqlRS11zP7Mu3+J6G8Qd38K/tMhncxh/ex1InQ9ww3qGs8gaF5ZWkpySiqq6kzT2PXFmO7mouE+F3DLr7sY9PY/MEqNKo8CyuMbO5T2B9l0BoV0K3mVzbYWLlFaKoQktq8ikUDQbSzqRxPjORZmsXPybFk5ydg8npxv3XC6mPPqoNXXQOeRheWGE2vMfM+g7T0kxJoD/4isnVLf4DDfZcDS/jIKsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e7f1dd81de905b7face826931df4ca61/77434/thumbnail.webp 300w,\n/static/e7f1dd81de905b7face826931df4ca61/411c4/thumbnail.webp 600w,\n/static/e7f1dd81de905b7face826931df4ca61/cbd37/thumbnail.webp 1200w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e7f1dd81de905b7face826931df4ca61/a8a0d/thumbnail.png 300w,\n/static/e7f1dd81de905b7face826931df4ca61/dface/thumbnail.png 600w,\n/static/e7f1dd81de905b7face826931df4ca61/64756/thumbnail.png 1200w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e7f1dd81de905b7face826931df4ca61/64756/thumbnail.png\"\n            alt=\"thumbnail\"\n            title=\"thumbnail\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1 id=\"nestjs에서-스케쥴링\" style=\"position:relative;\"><a href=\"#nestjs%EC%97%90%EC%84%9C-%EC%8A%A4%EC%BC%80%EC%A5%B4%EB%A7%81\" aria-label=\"nestjs에서 스케쥴링 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NestJs에서 스케쥴링…</h1>\n<p>현재 하고 있는 프로젝트에서 스케쥴링이 필요하여 구현했었다.<br>\n그런데 스케쥴링을 돌렸는데 뭔가 시간이 안맞게 돌아간다고 해야 하나?</p>\n<p>분과 초단위는 잘 도는데 시간대가 좀 안맞았다.<br>\n그래서 테스트를 하고 자료를 찾다가 원인을 알게되었다…</p>\n<br>\n<h2 id=\"원인\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8\" aria-label=\"원인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인?</h2>\n<p>이유는 바로 <strong>TimeZone</strong> 문제였다.</p>\n<p>내가 구현한 코드는 다음과 같이 구성되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Cron</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0 0-10 0-23 * * 0-5\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">\"UpdateDataSchedule\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token function\">cron4Time4Data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>taskSchedulerService<span class=\"token punctuation\">.</span><span class=\"token function\">UpdateData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">stop4CronJob</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UpdateDataSchedule\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>일요일에서 금요일까지 자정에서 11시까지 도는 스케쥴러다.<br>\n근데 로깅을 찍어보고 해봐도 뭔가 이상했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">CronOptions</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n   * Specify the name of your cron job. This will allow to inject your cron job reference through `@InjectCronRef`.\n   */</span>\n  name<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token comment\">/**\n   * Specify the timezone for the execution. This will modify the actual time relative to your timezone. If the timezone is invalid, an error is thrown. You can check all timezones available at [Moment Timezone Website](http://momentjs.com/timezone/). Probably don't use both ```timeZone``` and ```utcOffset``` together or weird things may happen.\n   */</span>\n  timeZone<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token comment\">/**\n   * This allows you to specify the offset of your timezone rather than using the ```timeZone``` param. Probably don't use both ```timeZone``` and ```utcOffset``` together or weird things may happen.\n   */</span>\n  utcOffset<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">number</span>\n  <span class=\"token comment\">/**\n   * If you have code that keeps the event loop running and want to stop the node process when that finishes regardless of the state of your cronjob, you can do so making use of this parameter. This is off by default and cron will run as if it needs to control the event loop. For more information take a look at [timers#timers_timeout_unref](https://nodejs.org/api/timers.html#timers_timeout_unref) from the NodeJS docs.\n   */</span>\n  unrefTimeout<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Creates a scheduled job.\n * @param cronTime The time to fire off your job. This can be in the form of cron syntax or a JS ```Date``` object.\n * @param options Job execution options.\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">declare</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Cron</span><span class=\"token punctuation\">(</span>\n  cronTime<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> Date<span class=\"token punctuation\">,</span>\n  options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> CronOptions\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MethodDecorator</code></pre></div>\n<p>저 <strong>@Cron</strong>의 함수 형태인데 뒤에 옵션이 수상했다.<br>\n위에 선언된 속성 중 <strong>timezone</strong>이 옵셔널로 들어오는데 이게 문제였었다.</p>\n<p>아무것도 선언을 안해주면 그냥 <strong>UTC</strong> 시간대가 적용된다.<br>\n그래서 이걸 아래와 같이 timezone을 선언해주면 아주 간단하게 해결되는 문제였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Cron</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0 0-10 0-23 * * 0-5\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">\"UpdateDataSchedule\"</span><span class=\"token punctuation\">,</span> timeZone<span class=\"token operator\">:</span> <span class=\"token string\">\"Asia/Seoul\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">...</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>이렇게 해주니 한국시 기준으로 잘 동작하였다.</p>\n<h2 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h2>\n<ul>\n<li><a href=\"https://docs.nestjs.com/techniques/task-scheduling\">참고 공식 문서</a></li>\n</ul>","frontmatter":{"title":"Nest.Js에서 한국시간 기준 스케쥴링할 때 주의점 (With Timezone)","date":"January 29, 2023"}}},"pageContext":{"slug":"/nest_js/230129_tast_scheduling/","previous":{"fields":{"slug":"/cloud-flare/230127_use_r2/"},"frontmatter":{"title":"CloudFlare R2 사용해보기 Part 1 (With Nest.Js)"}},"next":{"fields":{"slug":"/nest_js/230203_r2_nestjs/"},"frontmatter":{"title":"CloudFlare R2 사용해보기 Part 2 (With Nest.Js)"}}}},"staticQueryHashes":["3128451518","903436796"]}